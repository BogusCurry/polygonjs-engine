(window.webpackJsonpPOLY=window.webpackJsonpPOLY||[]).push([["Cop","Gl~Mat"],{331:function(e,t,n){"use strict";n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return _})),n.d(t,"b",(function(){return a})),n.d(t,"d",(function(){return o})),n.d(t,"e",(function(){return d}));var s,r=n(371);!function(e){e.ATTRIBUTE="attribute",e.FUNCTION="function",e.UNIFORM="uniform",e.VARYING="varying"}(s||(s={}));class i{constructor(e,t,n,s){this._definition_type=e,this._data_type=t,this._node=n,this._name=s}get definition_type(){return this._definition_type}get data_type(){return this._data_type}get node(){return this._node}get name(){return this._name}collection_instance(){return new r.a}}class _ extends i{constructor(e,t,n){super(s.ATTRIBUTE,t,e,n),this._node=e,this._data_type=t,this._name=n}get line(){return`attribute ${this.data_type} ${this.name}`}}class a extends i{constructor(e,t,n){super(s.FUNCTION,t,e,n),this._node=e,this._data_type=t,this._name=n}get line(){return this.name}}class o extends i{constructor(e,t,n){super(s.UNIFORM,t,e,n),this._node=e,this._data_type=t,this._name=n}get line(){return`uniform ${this.data_type} ${this.name}`}}class d extends i{constructor(e,t,n){super(s.VARYING,t,e,n),this._node=e,this._data_type=t,this._name=n}get line(){return`varying ${this.data_type} ${this.name}`}}},332:function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var s=n(15),r=n(9),i=n.n(r),_=n(66),a=n.n(_),o=n(5),d=n.n(o);class u{static any(e){if(d()(e))return e;if(a()(e))return`${e}`;if(i()(e))return`${s.a.ensure_float(e)}`;{const t=e.toArray().map(e=>`${s.a.ensure_float(e)}`);return`${`vec${t.length}`}(${t.join(", ")})`}}static vector3(e){if(d()(e))return e;return`vec3(${e.toArray().map(e=>`${s.a.ensure_float(e)}`).join(", ")})`}static vector2(e){if(d()(e))return e;return`vec2(${e.toArray().map(e=>`${s.a.ensure_float(e)}`).join(", ")})`}static vector3_float(e,t){return d()(t)||(t=s.a.ensure_float(t)),`vec4(${this.vector3(e)}, ${t})`}static float4(e,t,n,r){return d()(e)||(e=s.a.ensure_float(e)),d()(t)||(t=s.a.ensure_float(t)),d()(n)||(n=s.a.ensure_float(n)),d()(r)||(r=s.a.ensure_float(r)),`vec4(${e}, ${t}, ${n}, ${r})`}static float3(e,t,n){return d()(e)||(e=s.a.ensure_float(e)),d()(t)||(t=s.a.ensure_float(t)),d()(n)||(n=s.a.ensure_float(n)),`vec3(${e}, ${t}, ${n})`}static float2(e,t){return d()(e)||(e=s.a.ensure_float(e)),d()(t)||(t=s.a.ensure_float(t)),`vec2(${e}, ${t})`}static float(e){return d()(e)||(e=s.a.ensure_float(e)),`${e}`}static int(e){return`${e}`}static bool(e){return`${e}`}}},333:function(e,t,n){"use strict";var s;n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return r})),function(e){e.VERTEX="vertex",e.FRAGMENT="fragment",e.LEAVES_FROM_NODES_SHADER="leaves_from_nodes_shader",e.PARTICLES_0="particles_0",e.PARTICLES_1="particles_1",e.PARTICLES_2="particles_2",e.PARTICLES_3="particles_3",e.PARTICLES_4="particles_4",e.PARTICLES_5="particles_5",e.PARTICLES_6="particles_6",e.PARTICLES_7="particles_7",e.PARTICLES_8="particles_8",e.PARTICLES_9="particles_9"}(s||(s={}));const r=[s.PARTICLES_0,s.PARTICLES_1,s.PARTICLES_2,s.PARTICLES_3,s.PARTICLES_4,s.PARTICLES_5,s.PARTICLES_6,s.PARTICLES_7,s.PARTICLES_8,s.PARTICLES_9]},334:function(e,t,n){"use strict";n.d(t,"b",(function(){return f})),n.d(t,"a",(function(){return b}));var s=n(58),r=n(332),i=n(35),_=n(44),a=n(45),o=n(118),d=n(65),u=n.n(d),l=n(3),c=n.n(l),h=n(9),p=n.n(h);class m{constructor(e){this.node=e,this._allow_inputs_created_from_params=!0}disallow_inputs_created_from_params(){this._allow_inputs_created_from_params=!1}initialize_node(){this.node.params.set_post_create_params_hook(this.create_inputs_from_params.bind(this))}create_inputs_from_params(){if(!this._allow_inputs_created_from_params)return;const e=[];for(let t of this.node.params.names){let n=!0;if(this._inputless_param_names&&this._inputless_param_names.length>0&&this._inputless_param_names.includes(t)&&(n=!1),n&&this.node.params.has(t)){const n=this.node.params.get(t);if(n&&!n.parent_param){const t=a.f[n.type];if(t){const s=new o.a(n.name,t);e.push(s)}}}}this.node.io.inputs.set_named_input_connection_points(e)}set_inputless_param_names(e){return this._inputless_param_names=e}create_spare_parameters(){const e=new Map,t=new Map,n=this.node.params.spare_names,s={};for(let r of n)if(this.node.params.has(r)){const n=this.node.params.get(r);n&&(e.set(r,n.raw_input_serialized),t.set(r,n.default_value_serialized),s.names_to_delete=s.names_to_delete||[],s.names_to_delete.push(r))}for(let e of this.node.io.inputs.named_input_connection_points){const n=e.name,r=e.param_type;let i=e.init_value;const _=t.get(n),a=this.node.gl_input_default_value(n);if(i=null!=a?a:null!=_?_:e.init_value,c()(e.init_value)&&p()(i)){const t=new Array(e.init_value.length);for(let e=0;e<t.length;e++)t[e]=i;i=t}null!=i&&(s.to_add=s.to_add||[],s.to_add.push({name:n,type:r,init_value:u()(i),options:{spare:!0}}))}if(!this.node.scene.loading_controller.is_loading){this.node.params.update_params(s);for(let t of this.node.params.spare)if(!t.parent_param){const n=e.get(t.name);n&&t.set(n)}}}}class f extends s.b{constructor(){super(...arguments),this.spare_params_controller=new m(this)}static node_context(){return i.a.GL}initialize_base_node(){this.io.connections.init_inputs(),this.ui_data.set_layout_horizontal(),this.io.outputs.set_named_output_connection_points([]),this.spare_params_controller.initialize_node()}node_sibbling(e){return super.node_sibbling(e)}cook(){console.warn("gl nodes should never cook")}_set_mat_to_recompile(){var e;null===(e=this.material_node)||void 0===e||e.assembler_controller.set_compilation_required_and_dirty(this)}get material_node(){var e;if(this.parent)return this.parent.type==this.type?null===(e=this.parent)||void 0===e?void 0:e.material_node:this.parent}gl_var_name(e){return`v_POLY_${this.name}_${e}`}variable_for_input(e){var t;const n=this.io.inputs.get_input_index(e),s=this.io.connections.input_connection(n);if(s){const t=s.node_src,n=t.io.outputs.named_output_connection_points[s.output_index];if(n){const e=n.name;return t.gl_var_name(e)}throw console.warn(`no output called '${e}' for gl node ${t.full_path()}`),"variable_for_input ERROR"}return r.a.any(null===(t=this.params.get(e))||void 0===t?void 0:t.value)}set_lines(e){}reset_code(){var e;null===(e=this._param_configs_controller)||void 0===e||e.reset()}set_param_configs(){}param_configs(){var e;return null===(e=this._param_configs_controller)||void 0===e?void 0:e.list}gl_input_default_value(e){return null}}class g extends _.a{}const v=new g;class b extends f{constructor(){super(...arguments),this.params_config=v}}},343:function(e,t,n){"use strict";n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return l})),n.d(t,"c",(function(){return c}));class s{constructor(e){this.node=e,this._state=!0,this._hooks=null}add_hook(e){this._hooks=this._hooks||[],this._hooks.push(e)}on_update(){}set(e){this._state!=e&&(this._state=e,this.on_update(),this.run_hooks())}get active(){return this._state}toggle(){this.set(!this._state)}run_hooks(){if(this._hooks)for(let e of this._hooks)e()}}var r=n(7);class i extends s{constructor(){super(...arguments),this._state=!1}on_update(){this.node.emit(r.a.FLAG_BYPASS_UPDATED),this.node.set_dirty()}}class _ extends s{on_update(){this.node.emit(r.a.FLAG_DISPLAY_UPDATED)}}class a{constructor(e){this.node=e}has_display(){return!1}has_bypass(){return!1}}function o(e){return class extends e{constructor(){super(...arguments),this.display=new _(this.node)}has_display(){return!0}}}function d(e){return class extends e{constructor(){super(...arguments),this.bypass=new i(this.node)}has_bypass(){return!0}}}class u extends(o(a)){}class l extends(d(a)){}class c extends(d(o(a))){}},345:function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var s=n(385),r=n(359),i=n(331),_=n(119),a=n(333);const o={position:"vec3( position )"};class d extends s.a{handle_globals_node(e,t,n){var s;const r=e.io.outputs.named_output_connection_points_by_name(t);if(!r)return;const _=e.gl_var_name(t),a=r.type,o=new i.e(e,a,_);n.add_definitions(e,[o]);const d=null===(s=e.material_node)||void 0===s?void 0:s.assembler_controller.assembler;if(!d)return;const u=d.shader_config(n.current_shader_name);if(!u)return;const l=u.dependencies(),c=`${_} = ${a}(${t})`;for(let t of l)n.add_definitions(e,[o],t),n.add_body_lines(e,[c],t);0==l.length&&n.add_body_lines(e,[c])}static variable_config_default(e){return o[e]}variable_config_default(e){return d.variable_config_default(e)}read_attribute(e,t,n,s){return d.read_attribute(e,t,n,s)}static read_attribute(e,t,n,s){var o;d.PRE_DEFINED_ATTRIBUTES.indexOf(n)<0&&s.add_definitions(e,[new i.a(e,t,n)],a.b.VERTEX);const u=s.current_shader_name;switch(u){case a.b.VERTEX:return n;case a.b.FRAGMENT:{if(!(e instanceof r.a))return;const d="varying_"+e.gl_var_name(e.output_name),l=new i.e(e,t,d),c=new Map;c.set(a.b.FRAGMENT,[]);const h=new Map;h.set(a.b.FRAGMENT,[]),_.a.push_on_array_at_entry(c,u,l);const p=`${d} = ${t}(${n})`,m=null===(o=e.material_node)||void 0===o?void 0:o.assembler_controller.assembler.shader_config(u);if(m){const t=m.dependencies();for(let e of t)_.a.push_on_array_at_entry(c,e,l),_.a.push_on_array_at_entry(h,e,p);c.forEach((t,n)=>{s.add_definitions(e,t,n)}),h.forEach((t,n)=>{s.add_body_lines(e,t,n)})}return d}}}handle_attribute_node(e,t,n,s){return d.read_attribute(e,t,n,s)}}d.PRE_DEFINED_ATTRIBUTES=["position","color","normal","uv","uv2","morphTarget0","morphTarget1","morphTarget2","morphTarget3","skinIndex","skinWeight"],d.IF_RULE={uv:"defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )"}},347:function(e,t,n){"use strict";n.d(t,"b",(function(){return m})),n.d(t,"a",(function(){return f}));var s=n(58),r=n(39);class i extends r.b{set_content(e){super.set_content(e)}texture(){return this._content}core_content(){return this._content}core_content_cloned(){var e;console.log("clone",this._content);const t=null===(e=this._content)||void 0===e?void 0:e.clone();return t&&(t.needsUpdate=!0),t}object(){return this.texture()}infos(){if(null!=this._content)return[this._content]}resolution(){return this._content&&this._content.image?[this._content.image.width,this._content.image.height]:[-1,-1]}}var _=n(37),a=n(35),o=n(343),d=n(122),u=n(4);const l=["input texture","input texture","input texture","input texture"];for(var c=new Uint16Array(32),h=0;h<32;h++)c[h]=28898;const p=new d.a(c,32,1,u.cb,u.I);class m extends s.b{constructor(e){super(e,"BaseCopNode"),this.container_controller=new _.a(this,i),this.flags=new o.a(this)}static node_context(){return a.a.COP}static displayed_input_names(){return l}initialize_base_node(){this.io.outputs.set_has_one_output()}node_sibbling(e){return super.node_sibbling(e)}set_texture(e){e.name=this.full_path(),this.set_container(e)}clear_texture(){this.set_container(p)}}class f extends m{}},348:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var s=n(45),r=n(118);class i{constructor(e){this.node=e,this._input_name_function=e=>`in${e}`,this._output_name_function=e=>0==e?"val":`val${e}`,this._expected_input_types_function=()=>{const e=this.first_input_connection_type()||s.c.FLOAT;return[e,e]},this._expected_output_types_function=()=>[this._expected_input_types_function()[0]],this._update_signature_if_required_bound=this.update_signature_if_required.bind(this),this._initialized=!1}set_input_name_function(e){this._input_name_function=e}set_output_name_function(e){this._output_name_function=e}set_expected_input_types_function(e){this._expected_input_types_function=e}set_expected_output_types_function(e){this._expected_output_types_function=e}output_name(e){return this._output_name_function(e)}initialize_node(){this._initialized?console.warn("already initialized",this.node):(this._initialized=!0,this.node.io.inputs.add_on_set_input_hook("_update_signature_if_required",this._update_signature_if_required_bound),this.node.params.add_on_scene_load_hook("_update_signature_if_required",this._update_signature_if_required_bound),this.node.params.set_post_create_params_hook(this._update_signature_if_required_bound),this.node.add_post_dirty_hook("_update_signature_if_required",this._update_signature_if_required_bound))}update_signature_if_required(e){this.node.lifecycle.creation_completed&&this._connections_match_inputs()||(this.update_connection_types(),this.node.remove_dirty_state(),this.make_successors_update_signatures())}make_successors_update_signatures(){for(let e of this.node.graph_all_successors()){const t=e;t.gl_connections_controller&&t.gl_connections_controller.update_signature_if_required(this.node)}}update_connection_types(){const e=this._expected_input_types_function(),t=this._expected_output_types_function(),n=e.map((e,t)=>new r.a(this._input_name_function(t),e)),s=t.map((e,t)=>new r.a(this._output_name_function(t),e));this.node.io.inputs.set_named_input_connection_points(n),this.node.io.outputs.set_named_output_connection_points(s,!1),this.node.spare_params_controller.create_spare_parameters()}_connections_match_inputs(){const e=this.node.io.inputs.named_input_connection_points.map(e=>e.type),t=this.node.io.outputs.named_output_connection_points.map(e=>e.type),n=this._expected_input_types_function(),s=this._expected_output_types_function();if(n.length!=e.length)return!1;if(s.length!=t.length)return!1;for(let t=0;t<e.length;t++)if(e[t]!=n[t])return!1;for(let e=0;e<t.length;e++)if(t[e]!=s[e])return!1;return!0}first_input_connection_type(){const e=this.node.io.connections.input_connections();if(e){const t=e[0];if(t)return this.connection_type_from_connection(t)}}connection_type_from_connection(e){const t=e.node_src,n=e.output_index;return t.io.outputs.named_output_connection_points[n].type}}},351:function(e,t,n){"use strict";n.d(t,"a",(function(){return x}));var s,r=n(1),i=n(346),_=n(4),a=n(347),o=n(379),d=n(6),u=n(11);!function(e){e.EXR="exr",e.BASIS="basis",e.HDR="hdr"}(s||(s={}));class l{constructor(e,t){this._node=e,this._param=t}load_texture_from_url_or_op(e){return Object(r.a)(this,void 0,void 0,(function*(){let t,n=null;if("op:"==e.substring(0,3)){const s=e.substring(3);if(t=d.a.find_node(this._node,s),t)if(t instanceof a.a){n=(yield t.request_container()).texture()}else this._node.states.error.set("found node is not a texture node");else this._node.states.error.set(`no node found in path '${s}'`)}else n=yield this.load_url(e),n?this._param.options.texture_as_env()||(n=l.set_texture_for_mapping(n)):this._node.states.error.set(`could not load texture ${e}`);return t&&this._param.graph_predecessors()[0]!=t&&(this._param.graph_disconnect_predecessors(),this._param.add_graph_input(t)),n}))}load_url(e){return Object(r.a)(this,void 0,void 0,(function*(){return new Promise((t,n)=>Object(r.a)(this,void 0,void 0,(function*(){const s=l._ext(e);if(l.VIDEO_EXTENSIONS.includes(s)){return yield this._load_as_video(e)}this.loader_for_ext(s).then(s=>{s.load(e,t,void 0,e=>{console.warn("error",e),n()})})})))}))}loader_for_ext(e){return Object(r.a)(this,void 0,void 0,(function*(){switch(e.toLowerCase()){case s.EXR:{const{EXRLoader:e}=yield n.e(2).then(n.bind(null,621));return new e}case s.HDR:{const{RGBELoader:e}=yield n.e(3).then(n.bind(null,610)),t=new e;return t.setDataType(_.Wc),t}case s.BASIS:{const{BasisTextureLoader:e}=yield n.e(4).then(n.bind(null,622)),t=new e;t.setTranscoderPath("/three/js/libs/basis/");const s=yield u.a.instance().renderers_controller.wait_for_renderer();return s?t.detectSupport(s):console.warn("texture loader found no renderer for basis texture loader"),t}}return new o.a}))}_load_as_video(e){return new Promise((t,n)=>{const s=document.createElement("video");s.setAttribute("crossOrigin","anonymous"),s.setAttribute("autoplay","true"),s.setAttribute("loop","true"),s.onloadedmetadata=function(){s.pause();const e=new i.a(s);t(e)};const r=document.createElement("source"),_=l._ext(e);let a=l.VIDEO_SOURCE_TYPE_BY_EXT[_];a=a||l._default_video_source_type(e),r.setAttribute("type",a),r.setAttribute("src",e),s.appendChild(r)})}static _default_video_source_type(e){return`video/${this._ext(e)}`}static pixel_data(e){const t=e.image,n=document.createElement("canvas");n.width=t.width,n.height=t.height;const s=n.getContext("2d");if(s)return s.drawImage(t,0,0,t.width,t.height),s.getImageData(0,0,t.width,t.height)}static _ext(e){const t=e.split(".");return t[t.length-1].toLowerCase()}static set_texture_for_mapping(e){return e}}l.PARAM_DEFAULT="/examples/textures/uv.jpg",l.PARAM_ENV_DEFAULT="/examples/textures/piz_compressed.exr",l.VIDEO_EXTENSIONS=["mp4","webm","ogv"],l.VIDEO_SOURCE_TYPE_BY_EXT={ogg:'video/ogg; codecs="theora, vorbis"',ogv:'video/ogg; codecs="theora, vorbis"',mp4:'video/mp4; codecs="avc1.42E01E, mp4a.40.2"'};var c=n(0),h=n(7),p=n(44);const m=[{UVMapping:_.Uc},{CubeReflectionMapping:_.m},{CubeRefractionMapping:_.n},{EquirectangularReflectionMapping:_.A},{EquirectangularRefractionMapping:_.B},{SphericalReflectionMapping:_.Ic},{CubeUVReflectionMapping:_.o},{CubeUVRefractionMapping:_.p}],f=[{ClampToEdgeWrapping:_.l},{RepeatWrapping:_.rc},{MirroredRepeatWrapping:_.gb}],g=[{LinearFilter:_.R},{NearestFilter:_.kb}],v=[{NearestFilter:_.kb},{NearestMipMapNearestFilter:_.mb},{NearestMipMapLinearFilter:_.lb},{LinearFilter:_.R},{LinearMipMapNearestFilter:_.T},{LinearMipMapLinearFilter:_.S}],b=["mapping","wrapS","wrapT","minFilter","magFilter"],y={mapping:"mapping",wrapS:"wrap_s",wrapT:"wrap_t",minFilter:"min_filter",magFilter:"mag_filter"};class E extends p.a{constructor(){super(...arguments),this.url=p.b.STRING(l.PARAM_DEFAULT,{desktop_browse:{file_type:"texture"}}),this.reload=p.b.BUTTON(null,{callback:(e,t)=>{x.PARAM_CALLBACK_reload(e,t)}}),this.mapping=p.b.INTEGER(_.Uc,{menu:{entries:m.map(e=>({name:Object.keys(e)[0],value:Object.values(e)[0]}))}}),this.wrap_s=p.b.INTEGER(Object.values(f[0])[0],{menu:{entries:f.map(e=>({name:Object.keys(e)[0],value:Object.values(e)[0]}))}}),this.wrap_t=p.b.INTEGER(Object.values(f[0])[0],{menu:{entries:f.map(e=>({name:Object.keys(e)[0],value:Object.values(e)[0]}))}}),this.mag_filter=p.b.INTEGER(Object.values(g[0])[0],{menu:{entries:g.map(e=>({name:Object.keys(e)[0],value:Object.values(e)[0]}))}}),this.min_filter=p.b.INTEGER(Object.values(v[0])[0],{menu:{entries:v.map(e=>({name:Object.keys(e)[0],value:Object.values(e)[0]}))}})}}const w=new E;class x extends a.b{constructor(){super(...arguments),this.params_config=w}static type(){return"file"}cook(){return Object(r.a)(this,void 0,void 0,(function*(){this._is_static_image_url(this.pv.url)?yield this.cook_for_image():yield this.cook_for_video()}))}_is_static_image_url(e){return!0}cook_for_image(){return Object(r.a)(this,void 0,void 0,(function*(){const e=yield this._load_texture(this.pv.url);e?(this._update_texture_params(e),this.set_texture(e)):this.clear_texture()}))}cook_for_video(){return Object(r.a)(this,void 0,void 0,(function*(){if(this._param_url_changed()){const e=yield this._load_texture(this.pv.url);e&&this._add_video_spare_params_if_required(e),this._previous_param_url=this.pv.url,this._set_video_current_time(),e?(this._update_texture_params(e),this.set_texture(e)):this.cook_controller.end_cook()}}))}resolved_url(){return this.pv.url}_update_texture_params(e){for(let t of b){const n=y[t],s=this.params.float(n);null!=s&&e&&e[t]!=s&&(e[t]=s,e.needsUpdate=!0)}}static PARAM_CALLBACK_reload(e,t){e.param_callback_reload()}param_callback_reload(){this._previous_param_url=void 0,this.p.url.set_successors_dirty()}_set_video_current_time(){this._video&&this.params.has("video_time")&&(this._video.currentTime=this.params.float("video_time"))}_add_video_spare_params_if_required(e){if(e){if(e.constructor==i.a){if(this._video=e.image,this._video&&!this.params.has_param(x.VIDEO_TIME_PARAM_NAME)){const e=this._video.duration;this.add_param(c.a.FLOAT,x.VIDEO_TIME_PARAM_NAME,"$T",{spare:!0,cook:!0,range:[0,e],range_locked:[!0,!0]}),this.emit(h.a.PARAMS_UPDATED)}}else this._remove_spare_params()}else this._remove_spare_params()}_remove_spare_params(){this.params.has_param(x.VIDEO_TIME_PARAM_NAME)&&this.params.update_params({names_to_delete:[x.VIDEO_TIME_PARAM_NAME]})}_param_url_changed(){return this._previous_param_url!=this.pv.url}_load_texture(e){return Object(r.a)(this,void 0,void 0,(function*(){let t=null;const n=this.params.get("url");if(e&&n){this._texture_loader=this._texture_loader||new l(this,n);try{t=yield this._texture_loader.load_texture_from_url_or_op(e)}catch(e){}t||this.states.error.set(`could not load texture '${e}'`)}else this.states.error.set("not url given to Mat/Base._load_texture");return t}))}}x.VIDEO_TIME_PARAM_NAME="video_time",x.DEFAULT_NODE_PATH={UV:"/COP/file_uv",ENV_MAP:"/COP/env_map"}},352:function(e,t,n){"use strict";n.d(t,"e",(function(){return s})),n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return _})),n.d(t,"d",(function(){return a})),n.d(t,"f",(function(){return o}));const s={LIGHT:"lights",MANAGER:"managers",GEOMETRY:"geometries",CAMERA:"cameras",MISC:"misc"},r={INPUT:"inputs",ADVANCED:"advanced",MISC:"misc"},i={CAMERA:"cameras",MISC:"misc"},_={COLOR:"color",CONVERSION:"conversion",DYNAMICS:"dynamics",GEOMETRY:"geometry",GLOBALS:"globals",LOGIC:"logic",MATH:"math",QUAT:"quat",TRIGO:"trigo",UTIL:"util",INSTANCE:"instance"},a={ADVANCED:"advanced",MESH:"meshes",POINTS:"points",LINE:"lines",VOLUME:"volumes",INSTANCE:"instances"},o={ADVANCED:"advanced",ANIMATION:"animation",ATTRIBUTE:"attributes",DYNAMICS:"dynamics",INPUT:"inputs",MISC:"misc",MODIFIER:"modifiers",PRIMITIVES:"primitives",RENDER:"render"}},359:function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var s=n(129),r=n.n(s),i=n(334),_=n(45),a=n(0),o=n(348),d=n(44);const u=[_.c.FLOAT,_.c.VEC2,_.c.VEC3,_.c.VEC4];class l extends d.a{constructor(){super(...arguments),this.name=d.b.STRING(""),this.type=d.b.INTEGER(0,{menu:{entries:u.map((e,t)=>({name:e,value:t}))}})}}const c=new l;class h extends i.b{constructor(){super(...arguments),this.params_config=c,this._on_create_set_name_if_none_bound=this._on_create_set_name_if_none.bind(this),this.gl_connections_controller=new o.a(this)}static type(){return"attribute"}initialize_node(){this.add_post_dirty_hook("_set_mat_to_recompile",this._set_mat_to_recompile_if_is_exporting.bind(this)),this.lifecycle.add_on_create_hook(this._on_create_set_name_if_none_bound),this.gl_connections_controller.initialize_node(),this.gl_connections_controller.set_expected_input_types_function(()=>[]),this.gl_connections_controller.set_expected_output_types_function(()=>[u[this.pv.type]])}create_params(){var e;(null===(e=this.material_node)||void 0===e?void 0:e.assembler_controller.allow_attribute_exports())&&this.add_param(a.a.BOOLEAN,"export_when_connected",0)}get input_name(){return h.INPUT_NAME}get output_name(){return h.OUTPUT_NAME}set_lines(e){var t;null===(t=this.material_node)||void 0===t||t.assembler_controller.assembler.set_node_lines_attribute(this,e)}get attribute_name(){return r()(this.pv.name)}gl_type(){return this.io.outputs.named_output_connection_points[0].type}connected_input_node(){return this.io.inputs.named_input(h.INPUT_NAME)}connected_input_connection_point(){return this.io.inputs.named_input_connection_point(h.INPUT_NAME)}output_connection_point(){return this.io.outputs.named_output_connection_points_by_name(this.input_name)}get is_importing(){return this.io.outputs.used_output_names().length>0}get is_exporting(){if(this.pv.export_when_connected){return null!=this.io.inputs.named_input(h.INPUT_NAME)}return!1}_set_mat_to_recompile_if_is_exporting(){this.is_exporting&&this._set_mat_to_recompile()}_on_create_set_name_if_none(){""==this.pv.name&&this.p.name.set(this.name)}}h.INPUT_NAME="export",h.OUTPUT_NAME="val"},360:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));class s{constructor(e,t,n){this._name=e,this._input_names=t,this._dependencies=n}name(){return this._name}input_names(){return this._input_names}dependencies(){return this._dependencies}}},361:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));class s{constructor(e,t={}){this._name=e,this._options=t}name(){return this._name}default_from_attribute(){return this._options.default_from_attribute||!1}default(){return this._options.default}if_condition(){return this._options.if}prefix(){return this._options.prefix||""}suffix(){return this._options.suffix||""}}},365:function(e,t,n){"use strict";n.d(t,"a",(function(){return R}));var s=n(1),r=n(397),i=n.n(r),_=n(384),a=n.n(_),o=n(137),d=n.n(o),u=n(12),l=n(58),c=n(345),h=n(15);class p{constructor(e){this._scene=e,this._data={}}data(){this._scene.nodes_controller.reset_node_context_signatures();const e=T.dispatch_node(this._scene.root),t=e.data(),n=e.ui_data();return this._data={properties:{frame:this._scene.frame||1,frame_range:this._scene.frame_range,frame_range_locked:this._scene.time_controller.frame_range_locked,master_camera_node_path:this._scene.cameras_controller.master_camera_node_path},root:t,ui:n},this._data}static sanitize_string(e){return e=e.replace(/'/g,"'"),e=h.a.escape_line_breaks(e)}}class m{constructor(e){this._node=e}data(){var e,t,n,s;this.is_root()||this._node.scene.nodes_controller.register_node_context_signature(this._node),this._data={type:this._node.type};const r=this.nodes_data();if(Object.keys(r).length>0){this._data.nodes=r;const t=null===(e=this._node.children_controller)||void 0===e?void 0:e.context;t&&(this._data.children_context=t)}if(this.is_root()||(this._data.params=this.params_data(),this._data.inputs=this.inputs_data()),this._node.flags&&(this._data.flags={},this._node.flags.has_bypass()&&(null===(t=this._node.flags.bypass)||void 0===t?void 0:t.active)&&(this._data.flags.bypass=this._node.flags.bypass.active),this._node.flags.has_display()&&(this._data.flags.display=null===(n=this._node.flags.display)||void 0===n?void 0:n.active)),this._node.children_allowed()){const e=null===(s=this._node.children_controller)||void 0===s?void 0:s.selection;if(e&&this._node.children().length>0){const t=[],n={};for(let t of e.nodes())n[t.graph_node_id]=!0;for(let e of this._node.children())e.graph_node_id in n&&t.push(e);this._data.selection=t.map(e=>e.name)}}if(this._node.io.inputs.override_clonable_state_allowed()){const e=this._node.io.inputs.override_clonable_state();e&&(this._data.override_clonable_state=e)}return this.add_custom(),this._data}ui_data(){const e={};if(!this.is_root()){const t=this._node.ui_data;e.pos=t.position.toArray();const n=t.comment;n&&(e.comment=p.sanitize_string(n))}const t=this._node.children();return t.length>0&&(e.nodes={},t.forEach(t=>{const n=T.dispatch_node(t);e.nodes[t.name]=n.ui_data()})),e}is_root(){return null===this._node.parent&&this._node.graph_node_id==this._node.root.graph_node_id}inputs_data(){const e=[];return this._node.io.inputs.inputs().forEach((t,n)=>{if(t){const s=this._node.io.connections.input_connection(n);if(this._node.io.inputs.has_named_inputs){const r=this._node.io.inputs.named_input_connection_points[n].name,i=s.output_index,_=t.io.outputs.named_output_connection_points[i].name;e.push({name:r,node:t.name,output:_})}else e.push(t.name)}}),e}params_data(){const e={};for(let t of this._node.params.names){const n=this._node.params.get(t);if(n&&!n.parent_param){const t=T.dispatch_param(n);if(t.required){const s=t.data();e[n.name]=s}}}return e}nodes_data(){const e={};for(let t of this._node.children()){const n=T.dispatch_node(t);e[t.name]=n.data()}return e}add_custom(){}}class f{constructor(e){this._param=e,this._complex_data={}}get required(){const e=this._param.options.is_spare&&!this._param.parent_param,t=!this._param.is_default;return e||t}data(){if(this._param.parent_param)throw console.warn("no component should be saved"),"no component should be saved";return this._require_data_complex()?this._data_complex():this._data_simple()}_data_simple(){return this._param.raw_input_serialized}_data_complex(){if(this._complex_data={},this._param.options.is_spare&&!this._param.parent_param&&(this._complex_data.type=this._param.type,this._complex_data.default_value=this._param.default_value_serialized,this._complex_data.raw_input=this._param.raw_input_serialized,this._complex_data.options=this._param.options.current),this._param.is_default||this.add_main(),this._param.options.has_options_overridden){const e={},t=this._param.options.overridden_options;for(let n of Object.keys(t)){const s=t[n];e[n]=JSON.stringify(s)}this._complex_data.overriden_options=e}return this._complex_data}_require_data_complex(){return!!this._param.options.is_spare||!!this._param.options.has_options_overridden}add_main(){}}class g extends f{add_main(){if(!this._require_data_complex())return this._param.raw_input_serialized;this._complex_data.raw_input=this._param.raw_input_serialized}}class v extends f{add_main(){let e=this._param.raw_input;if(e=p.sanitize_string(e),!this._require_data_complex())return e;this._complex_data.raw_input=e}}class b extends f{add_main(){let e=this._param.raw_input;if(e=p.sanitize_string(e),!this._require_data_complex())return e;this._complex_data.raw_input=e}}class y extends f{add_main(){if(!this._require_data_complex())return this._param.raw_input_serialized;this._complex_data.raw_input=this._param.raw_input_serialized}}var E=n(43),w=n(139),x=n(67),A=n(28);class T{static dispatch_node(e){return new m(e)}static dispatch_param(e){return e instanceof E.a?new g(e):e instanceof w.a?new v(e):e instanceof x.a?new b(e):e instanceof A.a?new y(e):new f(e)}}l.b;class R{constructor(e,t){this.node=e,this._globals_handler=new c.a,this._compile_required=!0,this._deleted_params_data=new Map,this._assembler=new t(this.node)}set_assembler_globals_handler(e){(this._globals_handler?this._globals_handler.id():null)!=(e?e.id():null)&&(this._globals_handler=e,this.set_compilation_required_and_dirty(),this._assembler.reset_configs())}get assembler(){return this._assembler}get globals_handler(){return this._globals_handler}add_output_params(e){this._assembler.add_output_params(e)}add_globals_params(e){this._assembler.add_globals_params(e)}allow_attribute_exports(){return this._assembler.allow_attribute_exports()}on_create(){const e=this.node.create_node("globals"),t=this.node.create_node("output");e.ui_data.set_position(new u.a(-200,0)),t.ui_data.set_position(new u.a(200,0))}set_compilation_required(e=!0){this._compile_required=e}set_compilation_required_and_dirty(e){this.set_compilation_required(),this.node.set_dirty(e)}compile_required(){return this._compile_required}post_compile(){return Object(s.a)(this,void 0,void 0,(function*(){this.create_spare_parameters(),this.set_compilation_required(!1)}))}assign_uniform_values(){return Object(s.a)(this,void 0,void 0,(function*(){if(this._assembler)for(let e of this._assembler.param_configs())yield e.set_uniform_value(this.node)}))}create_spare_parameters(){const e=this.node.params.spare_names,t=this._assembler.param_configs(),n=t.map(e=>e.name),s=d()(n,e),r=d()(e,n),_={},o=this.node.params.names,u=a()(s,o);if(u.length>0){const e=`${this.node.full_path()} attempts to create spare params called '${u.join(", ")}' with same name as params`;console.warn(e),this.node.states.error.set(e)}r.forEach(e=>{const t=this.node.params.get(e);if(t){const e=T.dispatch_param(t);if(e.required){const n=e.data();this._deleted_params_data.set(t.name,n)}}_.names_to_delete=_.names_to_delete||[],_.names_to_delete.push(e)});for(let e of t)if(s.indexOf(e.name)>=0){const t=i()(e.param_options,{spare:!0,cook:!0});_.to_add=_.to_add||[],_.to_add.push({name:e.name,type:e.type,init_value:e.default_value,options:t})}this.node.params.update_params(_)}}},366:function(e,t,n){"use strict";n.d(t,"a",(function(){return C}));var s,r=n(1),i=n(12);!function(e){e.FUNCTION_DECLARATION="function_declaration",e.DEFINE="define",e.BODY="body"}(s||(s={}));var _=n(360),a=n(361),o=n(30),d=n.n(o),u=n(386),l=n(119),c=n(331),h=n(371),p=n(376);class m{constructor(e){this._shader_name=e,this._definitions_by_node_id=new Map,this._body_lines_by_node_id=new Map}get shader_name(){return this._shader_name}add_definitions(e,t){for(let n of t)l.a.push_on_array_at_entry(this._definitions_by_node_id,e.graph_node_id,n)}definitions(e){return this._definitions_by_node_id.get(e.graph_node_id)}add_body_lines(e,t){for(let n of t)l.a.push_on_array_at_entry(this._body_lines_by_node_id,e.graph_node_id,n)}body_lines(e){return this._body_lines_by_node_id.get(e.graph_node_id)}}class f{constructor(e,t){this._shader_names=e,this._current_shader_name=t,this._lines_controller_by_shader_name=new Map;for(let e of this._shader_names)this._lines_controller_by_shader_name.set(e,new m(e))}get shader_names(){return this._shader_names}set_current_shader_name(e){this._current_shader_name=e}get current_shader_name(){return this._current_shader_name}add_definitions(e,t,n){if(0==t.length)return;n=n||this._current_shader_name;const s=this._lines_controller_by_shader_name.get(n);s&&s.add_definitions(e,t)}definitions(e,t){const n=this._lines_controller_by_shader_name.get(e);if(n)return n.definitions(t)}add_body_lines(e,t,n){if(0==t.length)return;n=n||this._current_shader_name;const s=this._lines_controller_by_shader_name.get(n);s&&s.add_body_lines(e,t)}body_lines(e,t){const n=this._lines_controller_by_shader_name.get(e);if(n)return n.body_lines(t)}}const g={[s.FUNCTION_DECLARATION]:"",[s.DEFINE]:";",[s.BODY]:";"},v={[s.FUNCTION_DECLARATION]:"",[s.DEFINE]:"",[s.BODY]:"\t"};class b{static node_comment(e,t){let n=`// ${e.full_path()}`;return t==s.BODY&&(n=`\t${n}`),n}static line_wrap(e,t){let n=!0;return 0!=e.indexOf("#if")&&0!=e.indexOf("#endif")||(n=!1),n?`${v[t]}${e}${g[t]}`:`${v[t]}${e}`}static post_line_separator(e){return e==s.BODY?"\t":""}}class y{constructor(e,t){this._assembler=e,this._gl_parent_node=t,this._param_configs_controller=new p.a,this._param_configs_set_allowed=!0,this._lines=new Map,this._function_declared=new Map}build_from_nodes(e){return Object(r.a)(this,void 0,void 0,(function*(){const t=new u.a(this._assembler,this._gl_parent_node);t.traverse(e);const n=new Map;for(let e of this.shader_names())n.set(e,t.nodes_for_shader_name(e));const s=t.sorted_nodes();for(let e of this.shader_names()){const t=this._assembler.root_nodes_by_shader_name(e);for(let s of t)l.a.push_on_array_at_entry(n,e,s)}const r=new Map;for(let e of s)r.set(e.graph_node_id,!0);for(let t of e)r.get(t.graph_node_id)||(s.push(t),r.set(t.graph_node_id,!0));for(let e of s)e.reset_code();for(let e of s)yield e.params.eval_all();this._shaders_collection_controller=new f(this.shader_names(),this.shader_names()[0]),this.reset();for(let e of this.shader_names()){const t=d()(n.get(e));if(this._shaders_collection_controller.set_current_shader_name(e),t)for(let e of t)this._param_configs_set_allowed&&e.set_param_configs(),e.set_lines(this._shaders_collection_controller)}this._param_configs_set_allowed&&this.set_param_configs(s),this.set_code_lines(s)}))}disallow_new_param_configs(){this._param_configs_set_allowed=!1}allow_new_param_configs(){this._param_configs_set_allowed=!0}shader_names(){return this._assembler.shader_names}reset(){for(let e of this.shader_names()){const t=new Map;this._lines.set(e,t),this._function_declared.set(e,new Map)}}param_configs(){return this._param_configs_controller.list||[]}lines(e,t){return this._lines.get(e).get(t)}all_lines(){return this._lines}set_param_configs(e){this._param_configs_controller.reset();for(let t of e){const e=t.param_configs();if(e)for(let t of e)this._param_configs_controller.push(t)}}set_code_lines(e){for(let t of this.shader_names())this.add_code_lines(e,t)}add_code_lines(e,t){this.add_definitions(e,t,c.c.FUNCTION,s.FUNCTION_DECLARATION),this.add_definitions(e,t,c.c.UNIFORM,s.DEFINE),this.add_definitions(e,t,c.c.VARYING,s.DEFINE),this.add_definitions(e,t,c.c.ATTRIBUTE,s.DEFINE),this.add_code_line_for_nodes_and_line_type(e,t,s.BODY)}add_definitions(e,t,n,s){if(!this._shaders_collection_controller)return;const r=[];for(let s of e){let e=this._shaders_collection_controller.definitions(t,s);if(e){e=e.filter(e=>e.definition_type==n);for(let t of e)r.push(t)}}if(r.length>0){const e=new h.a(r),n=e.uniq();if(e.errored)throw`code builder error: ${e.error_message}`;const i=new Map,_=new Map;for(let e of n){const t=e.node.graph_node_id;_.has(t)||_.set(t,!0),l.a.push_on_array_at_entry(i,t,e)}const a=this._lines.get(t);_.forEach((e,t)=>{const n=i.get(t);if(n){const e=n[0];if(e){const t=b.node_comment(e.node,s);l.a.push_on_array_at_entry(a,s,t);for(let e of n){const t=b.line_wrap(e.line,s);l.a.push_on_array_at_entry(a,s,t)}const r=b.post_line_separator(s);l.a.push_on_array_at_entry(a,s,r)}}})}}add_code_line_for_nodes_and_line_type(e,t,n){var s=(e=e.filter(e=>{if(this._shaders_collection_controller){const n=this._shaders_collection_controller.body_lines(t,e);return n&&n.length>0}})).length;for(let r=0;r<s;r++){const s=r==e.length-1;this.add_code_line_for_node_and_line_type(e[r],t,n,s)}}add_code_line_for_node_and_line_type(e,t,n,r){if(!this._shaders_collection_controller)return;const i=this._shaders_collection_controller.body_lines(t,e);if(i&&i.length>0){const _=this._lines.get(t),a=b.node_comment(e,n);if(l.a.push_on_array_at_entry(_,n,a),d()(i).forEach(e=>{e=b.line_wrap(e,n),l.a.push_on_array_at_entry(_,n,e)}),n!=s.BODY||!r){const e=b.post_line_separator(n);l.a.push_on_array_at_entry(_,n,e)}}}}var E=n(345);var w=n(333),x=n(0),A=n(118),T=n(45),R=n(387),O=n(359);const N=new Map([[w.b.VERTEX,"#include <common>"],[w.b.FRAGMENT,"#include <common>"]]),I=new Map([[w.b.VERTEX,"#include <color_vertex>"],[w.b.FRAGMENT,"vec4 diffuseColor = vec4( diffuse, opacity );"]]),M=new Map([[w.b.VERTEX,["#include <begin_vertex>","#include <beginnormal_vertex>"]],[w.b.FRAGMENT,[]]]);class C extends class{}{constructor(e){super(),this._gl_parent_node=e,this._shaders_by_name=new Map,this._lines=new Map,this._root_nodes=[],this._leaf_nodes=[],this._uniforms_time_dependent=!1,this._resolution_dependent=!1}compile(){return Object(r.a)(this,void 0,void 0,(function*(){}))}_template_shader_for_shader_name(e){var t,n;switch(e){case w.b.VERTEX:return null===(t=this._template_shader)||void 0===t?void 0:t.vertexShader;case w.b.FRAGMENT:return null===(n=this._template_shader)||void 0===n?void 0:n.fragmentShader}}get globals_handler(){return this._gl_parent_node.assembler_controller.globals_handler}compile_allowed(){return null!=this._gl_parent_node.assembler_controller.globals_handler}shaders_by_name(){return this._shaders_by_name}_build_lines(){for(let e of this.shader_names){const t=this._template_shader_for_shader_name(e);t&&this._replace_template(t,e)}}set_root_nodes(e){this._root_nodes=e}get _template_shader(){}add_uniforms(e){for(let t of this.param_configs())e[t.uniform_name]=t.uniform;this.uniforms_time_dependent()&&(e.time={value:this._gl_parent_node.scene.time}),this.resolution_dependent()&&(e.resolution={value:new i.a(1e3,1e3)})}root_nodes_by_shader_name(e){const t=[];for(let e of this._root_nodes)switch(e.type){case"output":t.push(e)}return t}leaf_nodes_by_shader_name(e){const t=[];for(let e of this._leaf_nodes)switch(e.type){case R.a.type():t.push(e);break;case O.a.type():}return t}set_node_lines_globals(e,t){}set_node_lines_output(e,t){}set_node_lines_attribute(e,t){}get code_builder(){return this._code_builder=this._code_builder||new y(this,this._gl_parent_node)}build_code_from_nodes(e){return Object(r.a)(this,void 0,void 0,(function*(){yield this.code_builder.build_from_nodes(e)}))}allow_new_param_configs(){this.code_builder.allow_new_param_configs()}disallow_new_param_configs(){this.code_builder.disallow_new_param_configs()}builder_param_configs(){return this.code_builder.param_configs()}builder_lines(e,t){return this.code_builder.lines(e,t)}all_builder_lines(){return this.code_builder.all_lines()}param_configs(){return(this._param_config_owner||this.code_builder).param_configs()}set_param_configs_owner(e){this._param_config_owner=e,this._param_config_owner?this.code_builder.disallow_new_param_configs():this.code_builder.allow_new_param_configs()}static add_output_params(e){e.params.add_param(x.a.VECTOR3,"position",[0,0,0],{hidden:!0}),e.params.add_param(x.a.VECTOR3,"normal",[0,0,0],{hidden:!0}),e.params.add_param(x.a.COLOR,"color",[1,1,1],{hidden:!0}),e.params.add_param(x.a.FLOAT,"alpha",1,{hidden:!0}),e.params.add_param(x.a.VECTOR2,"uv",[0,0],{hidden:!0})}add_output_params(e){C.add_output_params(e)}static create_globals_node_output_connections(){return[new A.a("position",T.c.VEC3),new A.a("normal",T.c.VEC3),new A.a("color",T.c.VEC3),new A.a("uv",T.c.VEC2),new A.a("gl_FragCoord",T.c.VEC4),new A.a("resolution",T.c.VEC2),new A.a("time",T.c.FLOAT)]}create_globals_node_output_connections(){return C.create_globals_node_output_connections()}add_globals_params(e){e.io.outputs.set_named_output_connection_points(this.create_globals_node_output_connections())}allow_attribute_exports(){return!1}reset_configs(){this._reset_shader_configs(),this._reset_variable_configs(),this._reset_uniforms_time_dependency(),this._reset_resolution_dependency()}get shader_configs(){return this._shader_configs=this._shader_configs||this.create_shader_configs()}set_shader_configs(e){this._shader_configs=e}get shader_names(){var e;return(null===(e=this.shader_configs)||void 0===e?void 0:e.map(e=>e.name()))||[]}_reset_shader_configs(){this._shader_configs=void 0}create_shader_configs(){return[new _.a(w.b.VERTEX,["position","normal","uv"],[]),new _.a(w.b.FRAGMENT,["color","alpha"],[w.b.VERTEX])]}shader_config(e){var t;return null===(t=this.shader_configs)||void 0===t?void 0:t.filter(t=>t.name()==e)[0]}variable_configs(){return this._variable_configs=this._variable_configs||this.create_variable_configs()}set_variable_configs(e){this._variable_configs=e}variable_config(e){return this.variable_configs().filter(t=>t.name()==e)[0]}static create_variable_configs(){return[new a.a("position",{default_from_attribute:!0,prefix:"vec3 transformed = "}),new a.a("normal",{default_from_attribute:!0,prefix:"vec3 objectNormal = "}),new a.a("color",{prefix:"diffuseColor.xyz = "}),new a.a("alpha",{prefix:"diffuseColor.a = "}),new a.a("uv",{prefix:"vUv = ",if:E.a.IF_RULE.uv})]}create_variable_configs(){return C.create_variable_configs()}_reset_variable_configs(){this._variable_configs=void 0,this.variable_configs()}input_names_for_shader_name(e,t){var n;return(null===(n=this.shader_config(t))||void 0===n?void 0:n.input_names())||[]}_reset_uniforms_time_dependency(){this._uniforms_time_dependent=!1}set_uniforms_time_dependent(){this._uniforms_time_dependent=!0}uniforms_time_dependent(){return this._uniforms_time_dependent}_reset_resolution_dependency(){this._resolution_dependent=!1}set_resolution_dependent(){this._resolution_dependent=!0}resolution_dependent(){return this._resolution_dependent}insert_define_after(e){return N.get(e)}insert_body_after(e){return I.get(e)}lines_to_remove(e){return M.get(e)}_replace_template(e,t){const n=this.builder_lines(t,s.FUNCTION_DECLARATION),r=this.builder_lines(t,s.DEFINE),i=this.builder_lines(t,s.BODY);let _=e.split("\n");const a=[],o=this.insert_define_after(t),d=this.insert_body_after(t),u=this.lines_to_remove(t);let l=!1,c=!1;for(let e of _){1==l&&(n&&this._insert_lines(a,n),r&&this._insert_lines(a,r),l=!1),1==c&&(i&&this._insert_lines(a,i),c=!1);let t=!1;if(u)for(let n of u)e.indexOf(n)>=0&&(t=!0);t?(a.push("// removed:"),a.push(`//${e}`)):a.push(e),o&&e.indexOf(o)>=0&&(l=!0),d&&e.indexOf(d)>=0&&(c=!0)}this._lines.set(t,a)}_insert_lines(e,t){if(t.length>0){for(let t=0;t<3;t++)e.push("");for(let n of t)e.push(n);for(let t=0;t<3;t++)e.push("")}}get_custom_materials(){return Object(r.a)(this,void 0,void 0,(function*(){return new Map}))}}},371:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));class s{constructor(e=[]){this._definitions=e,this._errored=!1}get errored(){return this._errored}get error_message(){return this._error_message}uniq(){const e=new Map,t=[];for(let n of this._definitions)if(!this._errored){const s=n.name,r=e.get(s);r?r.data_type!=n.data_type&&(this._errored=!0,this._error_message=`attempt to create ${n.name} with types ${n.data_type}`,console.warn("emitting error message",this._error_message)):(e.set(s,n),t.push(s))}const n=[];for(let s of t){const t=e.get(s);t&&n.push(t)}return n}}},376:function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var s=n(1),r=n(346),i=n(36),_=n(2),a=n(12),o=n(0),d=n(141),u=n(35),l=n(130);class c{constructor(e,t,n,s){this._type=e,this._name=t,this._default_value=n,this._uniform_name=s}static from_param(e,t){return new c(e.type,e.name,e.default_value,t)}get type(){return this._type}get name(){return this._name}get default_value(){return this._default_value}get uniform_name(){return this._uniform_name}get uniform(){return this._uniform=this._uniform||this._create_uniform()}_create_uniform(){return c.uniform_by_type(this._type)}get param_options(){const e=this._callback.bind(this);switch(this._type){case o.a.OPERATOR_PATH:return{callback:e,node_selection:{context:u.a.COP}};default:return{callback:e}}}_callback(e,t){this.uniform.value=t.value}static uniform_by_type(e){switch(e){case o.a.BOOLEAN:case o.a.BUTTON:return{value:0};case o.a.COLOR:return{value:new _.a(0,0,0)};case o.a.FLOAT:case o.a.FOLDER:case o.a.INTEGER:case o.a.OPERATOR_PATH:return{value:0};case o.a.RAMP:return{value:null};case o.a.SEPARATOR:return{value:0};case o.a.STRING:return{value:null};case o.a.VECTOR2:return{value:new a.a(0,0)};case o.a.VECTOR3:return{value:new _.a(0,0,0)};case o.a.VECTOR4:return{value:new i.a(0,0,0,0)}}l.a.unreachable(e)}set_uniform_value(e){return Object(s.a)(this,void 0,void 0,(function*(){const t=this.uniform,n=e.params.get(this._name);if(n){yield n.compute();const e=n.value;if(null!=e&&this.has_value_changed(e)||this.is_video_texture())switch(this._type){case o.a.OPERATOR_PATH:yield this.set_uniform_value_from_texture(n,t);break;case o.a.RAMP:this.set_uniform_value_from_ramp(n,t);break;default:t.value=n.value}}}))}set_uniform_value_from_texture(e,t){return Object(s.a)(this,void 0,void 0,(function*(){const n=e.found_node();if(n){const e=(yield n.request_container()).texture();t.value=e}else t.value=null}))}set_uniform_value_from_ramp(e,t){t.value=e.ramp_texture()}has_value_changed(e){const t=d.a[this._type];if(this._cached_param_value){const n=!t.are_values_equal(e,this._cached_param_value);return n&&(this._cached_param_value=t.clone_value(e)),n}return this._cached_param_value=t.clone_value(e),!1}is_video_texture(){let e=!1;const t=this.uniform;if(t){const n=t.value;n&&(e=n.constructor==r.a)}return e}}class h{constructor(){this._param_configs=[]}reset(){this._param_configs=[]}push(e){this._param_configs.push(e)}create_and_push(e,t,n,s){const r=new c(e,t,n,s);this._param_configs.push(r)}get list(){return this._param_configs}}},385:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));class s{constructor(){this._id=s.__next_id++}id(){return this._id}handle_globals_node(e,t,n){}}s.__next_id=0},386:function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var s=n(27),r=n.n(s),i=n(30),_=n.n(i),a=n(119),o=n(333);class d{constructor(e,t){this._assembler=e,this._gl_parent_node=t,this._leaves_graph_id=new Map,this._graph_ids_by_shader_name=new Map,this._outputs_by_graph_id=new Map,this._depth_by_graph_id=new Map,this._graph_id_by_depth=new Map,this._graph=this._gl_parent_node.scene.graph}reset(){this._leaves_graph_id.clear(),this._outputs_by_graph_id.clear(),this._depth_by_graph_id.clear(),this._graph_id_by_depth.clear(),this.shader_names().forEach(e=>{this._graph_ids_by_shader_name.set(e,new Map)})}shader_names(){return this._assembler.shader_names}input_names_for_shader_name(e,t){return this._assembler.input_names_for_shader_name(e,t)}traverse(e){this.reset();for(let e of this.shader_names())this._leaves_graph_id.set(e,new Map);for(let t of this.shader_names()){this._shader_name=t;for(let t of e)this.find_leaves_from_root_node(t),this.set_nodes_depth()}this._depth_by_graph_id.forEach((e,t)=>{null!=e&&a.a.push_on_array_at_entry(this._graph_id_by_depth,e,t)})}leaves_from_nodes(e){var t;this._shader_name=o.b.LEAVES_FROM_NODES_SHADER,this._graph_ids_by_shader_name.set(this._shader_name,new Map),this._leaves_graph_id.set(this._shader_name,new Map);for(let t of e)this.find_leaves(t);const n=[];return null===(t=this._leaves_graph_id.get(this._shader_name))||void 0===t||t.forEach((e,t)=>{n.push(t)}),this._graph.nodes_from_ids(n)}nodes_for_shader_name(e){const t=[];this._graph_id_by_depth.forEach((e,n)=>{t.push(n)}),t.sort((e,t)=>e-t);const n=[];return t.forEach(t=>{const s=this._graph_id_by_depth.get(t);s&&s.forEach(t=>{var s;if(null===(s=this._graph_ids_by_shader_name.get(e))||void 0===s?void 0:s.get(t)){const e=this._graph.node_from_id(t);n.push(e)}})}),n}sorted_nodes(){const e=[];this._graph_id_by_depth.forEach((t,n)=>{e.push(n)}),e.sort((e,t)=>e-t);const t=[];return e.forEach(e=>{const n=this._graph_id_by_depth.get(e);if(n)for(let e of n){const n=this._graph.node_from_id(e);n&&t.push(n)}}),t}find_leaves_from_root_node(e){var t;null===(t=this._graph_ids_by_shader_name.get(this._shader_name))||void 0===t||t.set(e.graph_node_id,!0);const n=this.input_names_for_shader_name(e,this._shader_name);if(n)for(let t of n){const n=e.io.inputs.named_input(t);n&&(a.a.push_on_array_at_entry(this._outputs_by_graph_id,n.graph_node_id,e.graph_node_id),this.find_leaves(n))}this._outputs_by_graph_id.forEach((e,t)=>{this._outputs_by_graph_id.set(t,_()(e))})}find_leaves(e){var t;null===(t=this._graph_ids_by_shader_name.get(this._shader_name))||void 0===t||t.set(e.graph_node_id,!0);const n=r()(e.io.inputs.inputs()),s=_()(n.map(e=>e.graph_node_id)).map(e=>this._graph.node_from_id(e));if(s.length>0)for(let t of s)a.a.push_on_array_at_entry(this._outputs_by_graph_id,t.graph_node_id,e.graph_node_id),this.find_leaves(t);else this._leaves_graph_id.get(this._shader_name).set(e.graph_node_id,!0)}set_nodes_depth(){this._leaves_graph_id.forEach((e,t)=>{e.forEach((e,t)=>{this.set_node_depth(t)})})}set_node_depth(e,t=0){const n=this._depth_by_graph_id.get(e);null!=n?this._depth_by_graph_id.set(e,Math.max(n,t)):this._depth_by_graph_id.set(e,t);const s=this._outputs_by_graph_id.get(e);s&&s.forEach(e=>{this.set_node_depth(e,t+1)})}}},387:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var s=n(334),r=n(44);class i extends r.a{}const _=new i;class a extends s.b{constructor(){super(...arguments),this.params_config=_}static type(){return"globals"}create_params(){var e;null===(e=this.material_node)||void 0===e||e.assembler_controller.add_globals_params(this)}set_lines(e){var t,n;null===(n=null===(t=this.material_node)||void 0===t?void 0:t.assembler_controller)||void 0===n||n.assembler.set_node_lines_globals(this,e)}}},388:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));class s{static find_output_nodes(e){return e.nodes_by_type("output")}static find_attribute_export_nodes(e){return e.nodes_by_type("attribute").filter(e=>e.is_exporting)}}},619:function(e,t,n){"use strict";n.r(t),n.d(t,"CopRegister",(function(){return z}));var s=n(352),r=n(1),i=n(502),_=n(396),a=n(336),o=n(126),d=n(4),u=n(353),l=n(340),c=n(122),h=n(410),p=n(347),m=n(365),f=n(366),g=n(332),v=n(360),b=n(361),y=n(333),E=n(0),w=n(118),x=n(45),A=n(331);class T extends f.a{get _template_shader(){return{fragmentShader:"#include <common>\n\nuniform vec2 resolution;\n\n// INSERT DEFINE\n\nvoid main() {\n\n\tvec4 diffuseColor = vec4(1.0,0.0,1.0,1.0);\n\n\n\t// INSERT BODY\n\n\tgl_FragColor = vec4( diffuseColor );\n}",vertexShader:void 0,uniforms:void 0}}fragment_shader(){return this._shaders_by_name.get(y.b.FRAGMENT)}uniforms(){return this._uniforms}update_fragment_shader(){return Object(r.a)(this,void 0,void 0,(function*(){this._lines=new Map,this._shaders_by_name=new Map;for(let e of this.shader_names)if(e==y.b.FRAGMENT){const t=this._template_shader.fragmentShader;this._lines.set(e,t.split("\n"))}this._root_nodes.length>0&&(yield this.build_code_from_nodes(this._root_nodes),this._build_lines()),this._uniforms=this._uniforms||{},this.add_uniforms(this._uniforms);for(let e of this.shader_names){const t=this._lines.get(e);t&&this._shaders_by_name.set(e,t.join("\n"))}const e=this._gl_parent_node.scene,t=this._gl_parent_node.graph_node_id;this.uniforms_time_dependent()?this._uniforms&&e.uniforms_controller.add_time_dependent_uniform_owner(t,this._uniforms):e.uniforms_controller.remove_time_dependent_uniform_owner(t)}))}add_output_params(e){e.add_param(E.a.COLOR,"color",[1,1,1],{hidden:!0}),e.add_param(E.a.FLOAT,"alpha",1,{hidden:!0})}add_globals_params(e){e.io.outputs.set_named_output_connection_points([new w.a("gl_FragCoord",x.c.VEC2),new w.a("time",x.c.FLOAT)])}create_shader_configs(){return[new v.a(y.b.FRAGMENT,["color","alpha"],[])]}create_variable_configs(){return[new b.a("color",{prefix:"diffuseColor.xyz = "}),new b.a("alpha",{prefix:"diffuseColor.a = ",default:"1.0"})]}insert_define_after(e){return"// INSERT DEFINE"}insert_body_after(e){return"// INSERT BODY"}lines_to_remove(e){return["// INSERT DEFINE","// INSERT BODY"]}handle_gl_FragCoord(e,t,n){"fragment"==t&&e.push(`vec2 ${n} = vec2(gl_FragCoord.x / resolution.x, gl_FragCoord.y / resolution.y)`)}set_node_lines_output(e,t){const n=this.input_names_for_shader_name(e,t.current_shader_name);if(n)for(let s of n){if(e.io.inputs.named_input(s)){const n=e.variable_for_input(s);let r;"color"==s&&(r=`diffuseColor.xyz = ${g.a.any(n)}`),"alpha"==s&&(r=`diffuseColor.a = ${g.a.any(n)}`),r&&t.add_body_lines(e,[r])}}}set_node_lines_globals(e,t){const n=t.current_shader_name;if(!this.shader_config(n))return;const s=[],r=[];for(let t of e.io.outputs.used_output_names()){const i=e.gl_var_name(t);switch(t){case"time":r.push(new A.d(e,x.c.FLOAT,t)),s.push(`float ${i} = ${t}`),this.set_uniforms_time_dependent();break;case"gl_FragCoord":this.handle_gl_FragCoord(s,n,i)}}t.add_definitions(e,r,n),t.add_body_lines(e,s)}}var R=n(44),O=n(345),N=n(388),I=n(35);class M extends R.a{constructor(){super(...arguments),this.resolution=R.b.VECTOR2([256,256])}}const C=new M;class S extends p.b{constructor(){super(...arguments),this.params_config=C,this._assembler_controller=this._create_assembler_controller(),this._texture_mesh=new l.a(new u.a(2,2)),this._texture_material=new a.a({uniforms:{},vertexShader:"\nvoid main()\t{\n\tgl_Position = vec4( position, 1.0 );\n}\n",fragmentShader:""}),this._texture_scene=new o.a,this._texture_camera=new h.a,this._children_controller_context=I.a.GL}static type(){return"builder"}_create_assembler_controller(){const e=new O.a,t=new m.a(this,T);return t.set_assembler_globals_handler(e),t}get assembler_controller(){return this._assembler_controller}initialize_node(){var e;this.lifecycle.add_on_create_hook(this.assembler_controller.on_create.bind(this.assembler_controller)),null===(e=this.children_controller)||void 0===e||e.init(),this._texture_mesh.material=this._texture_material,this._texture_scene.add(this._texture_mesh),this._texture_camera.position.z=1,this.dirty_controller.add_post_dirty_hook("_reset_if_resolution_changed",this._reset_if_resolution_changed.bind(this)),this.params.set_post_create_params_hook(()=>{this._render_target=this._create_render_target(),this._renderer=this._create_renderer(this._render_target)})}create_node(e){return super.create_node(e)}children(){return super.children()}nodes_by_type(e){return super.nodes_by_type(e)}_reset_if_resolution_changed(e){e&&e.graph_node_id==this.p.resolution.graph_node_id&&this._reset()}_reset(){this._render_target=this._create_render_target(),this._renderer=this._create_renderer(this._render_target),this._pixelBuffer=this._create_pixel_buffer()}_create_pixel_buffer(){const e=this.pv.resolution.x,t=this.pv.resolution.y;return new Float32Array(e*t*4)}cook(){return Object(r.a)(this,void 0,void 0,(function*(){yield this.compile_if_required(),this.render_on_target()}))}shaders_by_name(){return{fragment:this._fragment_shader}}compile_if_required(){return Object(r.a)(this,void 0,void 0,(function*(){this.assembler_controller.compile_required()&&(yield this.run_assembler(),this.assembler_controller.post_compile())}))}run_assembler(){return Object(r.a)(this,void 0,void 0,(function*(){const e=N.a.find_output_nodes(this);if(e.length>1)return void this.states.error.set("only one output node allowed");const t=e[0];if(t){this.assembler_controller.assembler.set_root_nodes([t]),yield this.assembler_controller.assembler.update_fragment_shader();const e=this.assembler_controller.assembler.fragment_shader(),n=this.assembler_controller.assembler.uniforms();e&&n&&(this._fragment_shader=e,this._uniforms=n),this.assembler_controller.assembler.uniforms_time_dependent()?this.states.time_dependent.force_time_dependent():this.states.time_dependent.unforce_time_dependent()}this._fragment_shader&&this._uniforms&&(this._texture_material.fragmentShader=this._fragment_shader,this._texture_material.uniforms=this._uniforms,this._texture_material.needsUpdate=!0,this._texture_material.uniforms.resolution={value:this.pv.resolution})}))}_create_renderer(e){const t=new i.a({antialias:!0});return t.setPixelRatio(window.devicePixelRatio),t.autoClear=!1,t.setRenderTarget(e),t}render_on_target(){return Object(r.a)(this,void 0,void 0,(function*(){const e=this.pv.resolution.x,t=this.pv.resolution.y;if(!this._renderer||!this._render_target)return;this._renderer.clear(),this._renderer.render(this._texture_scene,this._texture_camera),this._pixelBuffer=this._pixelBuffer||this._create_pixel_buffer(),this._renderer.readRenderTargetPixels(this._render_target,0,0,e,t,this._pixelBuffer);const n=new c.a(this._pixelBuffer,e,t,d.Db,d.D);yield class{static sleep(e){return new Promise((t,n)=>{setTimeout(()=>{t()},e)})}}.sleep(2e3),n?this.set_texture(n):this.cook_controller.end_cook()}))}_create_render_target(){const e=d.l,t=d.l,n=d.kb,s=d.kb;return new _.a(this.pv.resolution.x,this.pv.resolution.y,{wrapS:e,wrapT:t,minFilter:n,magFilter:s,format:d.Db,type:/(iPad|iPhone|iPod)/g.test(navigator.userAgent)?d.I:d.D,stencilBuffer:!1,depthBuffer:!1})}}var P=n(506),L=n(34),F=n(11);class D extends R.a{}const k=new D;class U extends p.b{constructor(){super(...arguments),this.params_config=k}static type(){return"env_map"}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([L.a.NEVER])}cook(e){return Object(r.a)(this,void 0,void 0,(function*(){const t=e[0],n=yield this.convert_texture_to_env_map(t);n?this.set_texture(n):this.cook_controller.end_cook()}))}convert_texture_to_env_map(e){return Object(r.a)(this,void 0,void 0,(function*(){const t=yield F.a.instance().renderers_controller.wait_for_renderer();if(t){return new P.a(t).fromEquirectangular(e).texture}this.states.error.set("no renderer found to convert the texture to an env map")}))}}var $=n(351);const V=new R.a;class j extends p.b{constructor(){super(...arguments),this.params_config=V}static type(){return"null"}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([L.a.NEVER])}cook(e){return Object(r.a)(this,void 0,void 0,(function*(){const t=e[0];this.set_texture(t)}))}}class q extends R.a{constructor(){super(...arguments),this.input=R.b.INTEGER(0,{range:[0,3],range_locked:[!0,!0]})}}const B=new q;class G extends p.b{constructor(){super(...arguments),this.params_config=B}static type(){return"switch"}initialize_node(){this.io.inputs.set_count(0,4),this.io.inputs.init_inputs_clonable_state([L.a.NEVER,L.a.NEVER,L.a.NEVER,L.a.NEVER]),this.ui_data.set_width(100),this.cook_controller.disallow_inputs_evaluation()}cook(){return Object(r.a)(this,void 0,void 0,(function*(){const e=this.pv.input;if(this.io.inputs.has_input(e)){const t=yield this.container_controller.request_input_container(e);this.set_texture(t.texture())}else this.states.error.set(`no input ${e}`)}))}}class z{static run(e){e.register_node(S,s.a.ADVANCED),e.register_node(U,s.a.INPUT),e.register_node($.a,s.a.INPUT),e.register_node(j,s.a.MISC),e.register_node(G,s.a.MISC)}}}}]);
//# sourceMappingURL=Cop.bundle.js.map