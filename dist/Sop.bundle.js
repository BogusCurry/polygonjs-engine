(window.webpackJsonpPOLY=window.webpackJsonpPOLY||[]).push([["Sop","Gl~Mat"],{331:function(t,e,s){"use strict";s.d(e,"c",(function(){return i})),s.d(e,"a",(function(){return o})),s.d(e,"b",(function(){return a})),s.d(e,"d",(function(){return _})),s.d(e,"e",(function(){return c}));var i,r=s(371);!function(t){t.ATTRIBUTE="attribute",t.FUNCTION="function",t.UNIFORM="uniform",t.VARYING="varying"}(i||(i={}));class n{constructor(t,e,s,i){this._definition_type=t,this._data_type=e,this._node=s,this._name=i}get definition_type(){return this._definition_type}get data_type(){return this._data_type}get node(){return this._node}get name(){return this._name}collection_instance(){return new r.a}}class o extends n{constructor(t,e,s){super(i.ATTRIBUTE,e,t,s),this._node=t,this._data_type=e,this._name=s}get line(){return`attribute ${this.data_type} ${this.name}`}}class a extends n{constructor(t,e,s){super(i.FUNCTION,e,t,s),this._node=t,this._data_type=e,this._name=s}get line(){return this.name}}class _ extends n{constructor(t,e,s){super(i.UNIFORM,e,t,s),this._node=t,this._data_type=e,this._name=s}get line(){return`uniform ${this.data_type} ${this.name}`}}class c extends n{constructor(t,e,s){super(i.VARYING,e,t,s),this._node=t,this._data_type=e,this._name=s}get line(){return`varying ${this.data_type} ${this.name}`}}},332:function(t,e,s){"use strict";s.d(e,"a",(function(){return l}));var i=s(15),r=s(9),n=s.n(r),o=s(66),a=s.n(o),_=s(5),c=s.n(_);class l{static any(t){if(c()(t))return t;if(a()(t))return`${t}`;if(n()(t))return`${i.a.ensure_float(t)}`;{const e=t.toArray().map(t=>`${i.a.ensure_float(t)}`);return`${`vec${e.length}`}(${e.join(", ")})`}}static vector3(t){if(c()(t))return t;return`vec3(${t.toArray().map(t=>`${i.a.ensure_float(t)}`).join(", ")})`}static vector2(t){if(c()(t))return t;return`vec2(${t.toArray().map(t=>`${i.a.ensure_float(t)}`).join(", ")})`}static vector3_float(t,e){return c()(e)||(e=i.a.ensure_float(e)),`vec4(${this.vector3(t)}, ${e})`}static float4(t,e,s,r){return c()(t)||(t=i.a.ensure_float(t)),c()(e)||(e=i.a.ensure_float(e)),c()(s)||(s=i.a.ensure_float(s)),c()(r)||(r=i.a.ensure_float(r)),`vec4(${t}, ${e}, ${s}, ${r})`}static float3(t,e,s){return c()(t)||(t=i.a.ensure_float(t)),c()(e)||(e=i.a.ensure_float(e)),c()(s)||(s=i.a.ensure_float(s)),`vec3(${t}, ${e}, ${s})`}static float2(t,e){return c()(t)||(t=i.a.ensure_float(t)),c()(e)||(e=i.a.ensure_float(e)),`vec2(${t}, ${e})`}static float(t){return c()(t)||(t=i.a.ensure_float(t)),`${t}`}static int(t){return`${t}`}static bool(t){return`${t}`}}},333:function(t,e,s){"use strict";var i;s.d(e,"b",(function(){return i})),s.d(e,"a",(function(){return r})),function(t){t.VERTEX="vertex",t.FRAGMENT="fragment",t.LEAVES_FROM_NODES_SHADER="leaves_from_nodes_shader",t.PARTICLES_0="particles_0",t.PARTICLES_1="particles_1",t.PARTICLES_2="particles_2",t.PARTICLES_3="particles_3",t.PARTICLES_4="particles_4",t.PARTICLES_5="particles_5",t.PARTICLES_6="particles_6",t.PARTICLES_7="particles_7",t.PARTICLES_8="particles_8",t.PARTICLES_9="particles_9"}(i||(i={}));const r=[i.PARTICLES_0,i.PARTICLES_1,i.PARTICLES_2,i.PARTICLES_3,i.PARTICLES_4,i.PARTICLES_5,i.PARTICLES_6,i.PARTICLES_7,i.PARTICLES_8,i.PARTICLES_9]},334:function(t,e,s){"use strict";s.d(e,"b",(function(){return f})),s.d(e,"a",(function(){return v}));var i=s(58),r=s(332),n=s(35),o=s(44),a=s(45),_=s(118),c=s(65),l=s.n(c),u=s(3),h=s.n(u),d=s(9),p=s.n(d);class m{constructor(t){this.node=t,this._allow_inputs_created_from_params=!0}disallow_inputs_created_from_params(){this._allow_inputs_created_from_params=!1}initialize_node(){this.node.params.set_post_create_params_hook(this.create_inputs_from_params.bind(this))}create_inputs_from_params(){if(!this._allow_inputs_created_from_params)return;const t=[];for(let e of this.node.params.names){let s=!0;if(this._inputless_param_names&&this._inputless_param_names.length>0&&this._inputless_param_names.includes(e)&&(s=!1),s&&this.node.params.has(e)){const s=this.node.params.get(e);if(s&&!s.parent_param){const e=a.f[s.type];if(e){const i=new _.a(s.name,e);t.push(i)}}}}this.node.io.inputs.set_named_input_connection_points(t)}set_inputless_param_names(t){return this._inputless_param_names=t}create_spare_parameters(){const t=new Map,e=new Map,s=this.node.params.spare_names,i={};for(let r of s)if(this.node.params.has(r)){const s=this.node.params.get(r);s&&(t.set(r,s.raw_input_serialized),e.set(r,s.default_value_serialized),i.names_to_delete=i.names_to_delete||[],i.names_to_delete.push(r))}for(let t of this.node.io.inputs.named_input_connection_points){const s=t.name,r=t.param_type;let n=t.init_value;const o=e.get(s),a=this.node.gl_input_default_value(s);if(n=null!=a?a:null!=o?o:t.init_value,h()(t.init_value)&&p()(n)){const e=new Array(t.init_value.length);for(let t=0;t<e.length;t++)e[t]=n;n=e}null!=n&&(i.to_add=i.to_add||[],i.to_add.push({name:s,type:r,init_value:l()(n),options:{spare:!0}}))}if(!this.node.scene.loading_controller.is_loading){this.node.params.update_params(i);for(let e of this.node.params.spare)if(!e.parent_param){const s=t.get(e.name);s&&e.set(s)}}}}class f extends i.b{constructor(){super(...arguments),this.spare_params_controller=new m(this)}static node_context(){return n.a.GL}initialize_base_node(){this.io.connections.init_inputs(),this.ui_data.set_layout_horizontal(),this.io.outputs.set_named_output_connection_points([]),this.spare_params_controller.initialize_node()}node_sibbling(t){return super.node_sibbling(t)}cook(){console.warn("gl nodes should never cook")}_set_mat_to_recompile(){var t;null===(t=this.material_node)||void 0===t||t.assembler_controller.set_compilation_required_and_dirty(this)}get material_node(){var t;if(this.parent)return this.parent.type==this.type?null===(t=this.parent)||void 0===t?void 0:t.material_node:this.parent}gl_var_name(t){return`v_POLY_${this.name}_${t}`}variable_for_input(t){var e;const s=this.io.inputs.get_input_index(t),i=this.io.connections.input_connection(s);if(i){const e=i.node_src,s=e.io.outputs.named_output_connection_points[i.output_index];if(s){const t=s.name;return e.gl_var_name(t)}throw console.warn(`no output called '${t}' for gl node ${e.full_path()}`),"variable_for_input ERROR"}return r.a.any(null===(e=this.params.get(t))||void 0===e?void 0:e.value)}set_lines(t){}reset_code(){var t;null===(t=this._param_configs_controller)||void 0===t||t.reset()}set_param_configs(){}param_configs(){var t;return null===(t=this._param_configs_controller)||void 0===t?void 0:t.list}gl_input_default_value(t){return null}}class b extends o.a{}const g=new b;class v extends f{constructor(){super(...arguments),this.params_config=g}}},339:function(t,e,s){"use strict";s.d(e,"a",(function(){return c}));var i=s(1),r=s(58),n=(s(330),s(39));class o extends n.b{set_content(t){super.set_content(t)}set_material(t){null!=this._content&&this._content.dispose(),this.set_content(t)}has_material(){return this.has_content()}material(){return this.content()}}var a=s(35),_=s(37);class c extends r.b{constructor(){super(...arguments),this.container_controller=new _.a(this,o),this._cook_main_without_inputs_when_dirty_bound=this._cook_main_without_inputs_when_dirty.bind(this)}static node_context(){return a.a.MAT}initialize_base_node(){super.initialize_base_node(),this.name_controller.add_post_set_full_path_hook(this.set_material_name.bind(this)),this.add_post_dirty_hook("_cook_main_without_inputs_when_dirty",this._cook_main_without_inputs_when_dirty_bound)}node_sibbling(t){return super.node_sibbling(t)}_cook_main_without_inputs_when_dirty(){return Object(i.a)(this,void 0,void 0,(function*(){yield this.cook_controller.cook_main_without_inputs()}))}set_material_name(){this._material&&(this._material.name=this.full_path())}get material(){return this._material=this._material||this.create_material()}set_material(t){this.set_container(t)}add_render_hook(t){}}},343:function(t,e,s){"use strict";s.d(e,"b",(function(){return l})),s.d(e,"a",(function(){return u})),s.d(e,"c",(function(){return h}));class i{constructor(t){this.node=t,this._state=!0,this._hooks=null}add_hook(t){this._hooks=this._hooks||[],this._hooks.push(t)}on_update(){}set(t){this._state!=t&&(this._state=t,this.on_update(),this.run_hooks())}get active(){return this._state}toggle(){this.set(!this._state)}run_hooks(){if(this._hooks)for(let t of this._hooks)t()}}var r=s(7);class n extends i{constructor(){super(...arguments),this._state=!1}on_update(){this.node.emit(r.a.FLAG_BYPASS_UPDATED),this.node.set_dirty()}}class o extends i{on_update(){this.node.emit(r.a.FLAG_DISPLAY_UPDATED)}}class a{constructor(t){this.node=t}has_display(){return!1}has_bypass(){return!1}}function _(t){return class extends t{constructor(){super(...arguments),this.display=new o(this.node)}has_display(){return!0}}}function c(t){return class extends t{constructor(){super(...arguments),this.bypass=new n(this.node)}has_bypass(){return!0}}}class l extends(_(a)){}class u extends(c(a)){}class h extends(c(_(a))){}},344:function(t,e,s){"use strict";s.d(e,"a",(function(){return i})),s.d(e,"b",(function(){return d}));var i,r=s(1),n=s(366),o=s(332),a=s(333),_=s(331),c=s(45),l=s(119),u=s(336),h=s(388);!function(t){t.DISTANCE="customDistanceMaterial",t.DEPTH="customDepthMaterial",t.DEPTH_DOF="customDepthDOFMaterial"}(i||(i={}));class d extends n.a{constructor(){super(...arguments),this._assemblers_by_custom_name=new Map}create_material(){return new u.a}custom_assembler_class_by_custom_name(){}_add_custom_materials(t){const e=this.custom_assembler_class_by_custom_name();e&&e.forEach((e,s)=>{this._add_custom_material(t,s,e)})}_add_custom_material(t,e,s){let i=this._assemblers_by_custom_name.get(e);i||(i=new s(this._gl_parent_node),this._assemblers_by_custom_name.set(e,i)),t.custom_materials=t.custom_materials||{},t.custom_materials[e]=i.create_material()}compile_custom_materials(t){return Object(r.a)(this,void 0,void 0,(function*(){const e=this.custom_assembler_class_by_custom_name();e&&e.forEach((e,s)=>Object(r.a)(this,void 0,void 0,(function*(){if(this._code_builder){let i=this._assemblers_by_custom_name.get(s);i||(i=new e(this._gl_parent_node),this._assemblers_by_custom_name.set(s,i)),i.set_root_nodes(this._root_nodes),i.set_param_configs_owner(this._code_builder),i.set_shader_configs(this.shader_configs),i.set_variable_configs(this.variable_configs());const r=t.custom_materials[s];r&&(yield i.compile_material(r))}})))}))}compile_material(t){return Object(r.a)(this,void 0,void 0,(function*(){if(!this.compile_allowed())return;const e=h.a.find_output_nodes(this._gl_parent_node);e.length>1&&this._gl_parent_node.states.error.set("only one output node allowed"),this.set_root_nodes(e),yield this._update_shaders();const s=this._shaders_by_name.get(a.b.VERTEX),i=this._shaders_by_name.get(a.b.FRAGMENT);s&&i&&(t.vertexShader=s,t.fragmentShader=i,this.add_uniforms(t.uniforms),t.needsUpdate=!0);const r=this._gl_parent_node.scene;this.uniforms_time_dependent()?r.uniforms_controller.add_time_dependent_uniform_owner(t.uuid,t.uniforms):r.uniforms_controller.remove_time_dependent_uniform_owner(t.uuid),t.custom_materials&&(yield this.compile_custom_materials(t))}))}_update_shaders(){return Object(r.a)(this,void 0,void 0,(function*(){this._shaders_by_name=new Map,this._lines=new Map;for(let t of this.shader_names){const e=this._template_shader_for_shader_name(t);e&&this._lines.set(t,e.split("\n"))}this._root_nodes.length>0&&(yield this.build_code_from_nodes(this._root_nodes),this._build_lines());for(let t of this.shader_names){const e=this._lines.get(t);e&&this._shaders_by_name.set(t,e.join("\n"))}}))}shadow_assembler_class_by_custom_name(){return{}}add_output_body_line(t,e,s){var i;const r=t.io.inputs.named_input(s),n=t.variable_for_input(s),a=this.variable_config(s);let _=null;if(r)_=o.a.vector3(n);else if(a.default_from_attribute()){const r=t.io.inputs.named_input_connection_points_by_name(s);if(r){const n=r.type,o=null===(i=this.globals_handler)||void 0===i?void 0:i.read_attribute(t,n,s,e);o&&(_=o)}}else{const t=a.default();t&&(_=t)}if(_){const s=a.prefix(),i=a.suffix(),r=a.if_condition();r&&e.add_body_lines(t,[`#if ${r}`]),e.add_body_lines(t,[`${s}${_}${i}`]),r&&e.add_body_lines(t,["#endif"])}}set_node_lines_output(t,e){var s;const i=e.current_shader_name,r=null===(s=this.shader_config(i))||void 0===s?void 0:s.input_names();if(r)for(let s of r)this.add_output_body_line(t,e,s)}set_node_lines_attribute(t,e){var s;const i=t.gl_type(),r=null===(s=this.globals_handler)||void 0===s?void 0:s.read_attribute(t,i,t.attribute_name,e),n=t.gl_var_name(t.output_name);e.add_body_lines(t,[`${i} ${n} = ${r}`])}handle_gl_FragCoord(t,e,s){e==a.b.FRAGMENT&&t.push(`vec4 ${s} = gl_FragCoord`)}handle_resolution(t,e,s){e==a.b.FRAGMENT&&t.push(`vec2 ${s} = resolution`)}set_node_lines_globals(t,e){var s;const i=[],r=e.current_shader_name,n=this.shader_config(r);if(!n)return;const o=n.dependencies(),u=new Map,h=new Map;let d,p;for(let n of t.io.outputs.used_output_names()){const m=t.gl_var_name(n),f=e.current_shader_name;switch(n){case"time":d=new _.d(t,c.c.FLOAT,n),f&&l.a.push_on_array_at_entry(u,f,d),p=`float ${m} = ${n}`;for(let t of o)l.a.push_on_array_at_entry(u,t,d),l.a.push_on_array_at_entry(h,t,p);i.push(p),this.set_uniforms_time_dependent();break;case"gl_FragCoord":this.handle_gl_FragCoord(i,r,m);break;case"resolution":this.handle_resolution(i,r,m),d=new _.d(t,c.c.VEC2,n),f&&l.a.push_on_array_at_entry(u,f,d);for(let t of o)l.a.push_on_array_at_entry(u,t,d);this.set_resolution_dependent();break;case"gl_PointCoord":r==a.b.FRAGMENT&&i.push(`vec2 ${m} = gl_PointCoord`);break;default:null===(s=this.globals_handler)||void 0===s||s.handle_globals_node(t,n,e)}}u.forEach((s,i)=>{e.add_definitions(t,s,i)}),h.forEach((s,i)=>{e.add_body_lines(t,s,i)}),e.add_body_lines(t,i)}}},345:function(t,e,s){"use strict";s.d(e,"a",(function(){return c}));var i=s(385),r=s(359),n=s(331),o=s(119),a=s(333);const _={position:"vec3( position )"};class c extends i.a{handle_globals_node(t,e,s){var i;const r=t.io.outputs.named_output_connection_points_by_name(e);if(!r)return;const o=t.gl_var_name(e),a=r.type,_=new n.e(t,a,o);s.add_definitions(t,[_]);const c=null===(i=t.material_node)||void 0===i?void 0:i.assembler_controller.assembler;if(!c)return;const l=c.shader_config(s.current_shader_name);if(!l)return;const u=l.dependencies(),h=`${o} = ${a}(${e})`;for(let e of u)s.add_definitions(t,[_],e),s.add_body_lines(t,[h],e);0==u.length&&s.add_body_lines(t,[h])}static variable_config_default(t){return _[t]}variable_config_default(t){return c.variable_config_default(t)}read_attribute(t,e,s,i){return c.read_attribute(t,e,s,i)}static read_attribute(t,e,s,i){var _;c.PRE_DEFINED_ATTRIBUTES.indexOf(s)<0&&i.add_definitions(t,[new n.a(t,e,s)],a.b.VERTEX);const l=i.current_shader_name;switch(l){case a.b.VERTEX:return s;case a.b.FRAGMENT:{if(!(t instanceof r.a))return;const c="varying_"+t.gl_var_name(t.output_name),u=new n.e(t,e,c),h=new Map;h.set(a.b.FRAGMENT,[]);const d=new Map;d.set(a.b.FRAGMENT,[]),o.a.push_on_array_at_entry(h,l,u);const p=`${c} = ${e}(${s})`,m=null===(_=t.material_node)||void 0===_?void 0:_.assembler_controller.assembler.shader_config(l);if(m){const e=m.dependencies();for(let t of e)o.a.push_on_array_at_entry(h,t,u),o.a.push_on_array_at_entry(d,t,p);h.forEach((e,s)=>{i.add_definitions(t,e,s)}),d.forEach((e,s)=>{i.add_body_lines(t,e,s)})}return c}}}handle_attribute_node(t,e,s,i){return c.read_attribute(t,e,s,i)}}c.PRE_DEFINED_ATTRIBUTES=["position","color","normal","uv","uv2","morphTarget0","morphTarget1","morphTarget2","morphTarget3","skinIndex","skinWeight"],c.IF_RULE={uv:"defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )"}},347:function(t,e,s){"use strict";s.d(e,"b",(function(){return m})),s.d(e,"a",(function(){return f}));var i=s(58),r=s(39);class n extends r.b{set_content(t){super.set_content(t)}texture(){return this._content}core_content(){return this._content}core_content_cloned(){var t;console.log("clone",this._content);const e=null===(t=this._content)||void 0===t?void 0:t.clone();return e&&(e.needsUpdate=!0),e}object(){return this.texture()}infos(){if(null!=this._content)return[this._content]}resolution(){return this._content&&this._content.image?[this._content.image.width,this._content.image.height]:[-1,-1]}}var o=s(37),a=s(35),_=s(343),c=s(122),l=s(4);const u=["input texture","input texture","input texture","input texture"];for(var h=new Uint16Array(32),d=0;d<32;d++)h[d]=28898;const p=new c.a(h,32,1,l.cb,l.I);class m extends i.b{constructor(t){super(t,"BaseCopNode"),this.container_controller=new o.a(this,n),this.flags=new _.a(this)}static node_context(){return a.a.COP}static displayed_input_names(){return u}initialize_base_node(){this.io.outputs.set_has_one_output()}node_sibbling(t){return super.node_sibbling(t)}set_texture(t){t.name=this.full_path(),this.set_container(t)}clear_texture(){this.set_container(p)}}class f extends m{}},348:function(t,e,s){"use strict";s.d(e,"a",(function(){return n}));var i=s(45),r=s(118);class n{constructor(t){this.node=t,this._input_name_function=t=>`in${t}`,this._output_name_function=t=>0==t?"val":`val${t}`,this._expected_input_types_function=()=>{const t=this.first_input_connection_type()||i.c.FLOAT;return[t,t]},this._expected_output_types_function=()=>[this._expected_input_types_function()[0]],this._update_signature_if_required_bound=this.update_signature_if_required.bind(this),this._initialized=!1}set_input_name_function(t){this._input_name_function=t}set_output_name_function(t){this._output_name_function=t}set_expected_input_types_function(t){this._expected_input_types_function=t}set_expected_output_types_function(t){this._expected_output_types_function=t}output_name(t){return this._output_name_function(t)}initialize_node(){this._initialized?console.warn("already initialized",this.node):(this._initialized=!0,this.node.io.inputs.add_on_set_input_hook("_update_signature_if_required",this._update_signature_if_required_bound),this.node.params.add_on_scene_load_hook("_update_signature_if_required",this._update_signature_if_required_bound),this.node.params.set_post_create_params_hook(this._update_signature_if_required_bound),this.node.add_post_dirty_hook("_update_signature_if_required",this._update_signature_if_required_bound))}update_signature_if_required(t){this.node.lifecycle.creation_completed&&this._connections_match_inputs()||(this.update_connection_types(),this.node.remove_dirty_state(),this.make_successors_update_signatures())}make_successors_update_signatures(){for(let t of this.node.graph_all_successors()){const e=t;e.gl_connections_controller&&e.gl_connections_controller.update_signature_if_required(this.node)}}update_connection_types(){const t=this._expected_input_types_function(),e=this._expected_output_types_function(),s=t.map((t,e)=>new r.a(this._input_name_function(e),t)),i=e.map((t,e)=>new r.a(this._output_name_function(e),t));this.node.io.inputs.set_named_input_connection_points(s),this.node.io.outputs.set_named_output_connection_points(i,!1),this.node.spare_params_controller.create_spare_parameters()}_connections_match_inputs(){const t=this.node.io.inputs.named_input_connection_points.map(t=>t.type),e=this.node.io.outputs.named_output_connection_points.map(t=>t.type),s=this._expected_input_types_function(),i=this._expected_output_types_function();if(s.length!=t.length)return!1;if(i.length!=e.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!=s[e])return!1;for(let t=0;t<e.length;t++)if(e[t]!=i[t])return!1;return!0}first_input_connection_type(){const t=this.node.io.connections.input_connections();if(t){const e=t[0];if(e)return this.connection_type_from_connection(e)}}connection_type_from_connection(t){const e=t.node_src,s=t.output_index;return e.io.outputs.named_output_connection_points[s].type}}},350:function(t,e,s){"use strict";s.d(e,"a",(function(){return _}));var i=s(2),r=s(21),n=s(29),o=s(140),a=s(10);class _{constructor(){this._translation_matrix=new n.a,this._translation_matrix_q=new r.a,this._translation_matrix_s=new i.a(1,1,1),this._matrix=(new n.a).identity(),this._matrix_q=new r.a,this._matrix_e=new o.a,this._matrix_s=new i.a,this._rotate_geometry_m=new n.a,this._rotate_geometry_q=new r.a,this._rotate_geometry_vec_dest=new i.a}static set_params_from_matrix(t,e,s={}){let n=s.scale;null==n&&(n=!0);const a=new i.a,_=new r.a,c=new i.a;t.decompose(a,_,c);const l=(new o.a).setFromQuaternion(_).toVector3();l.divideScalar(Math.PI/180),e.scene.batch_update(()=>{e.params.set_vector3("r",l.toArray()),e.params.set_vector3("t",a.toArray()),e.params.set_vector3("s",c.toArray()),n&&e.params.set_float("scale",1)})}static set_params_from_object(t,e){const s=t.position.toArray(),i=t.rotation.toArray().map(t=>t*(180/Math.PI));e.scene.batch_update(()=>{e.params.set_vector3("t",s),e.params.set_vector3("r",i)})}translation_matrix(t){return this._translation_matrix.compose(t,this._translation_matrix_q,this._translation_matrix_s),this._translation_matrix}static matrix_quaternion(t){const e=new i.a,s=new r.a,n=new i.a;return t.decompose(e,s,n),s}matrix(t,e,s,i){return this._matrix_e.set(a.a.degToRad(e.x),a.a.degToRad(e.y),a.a.degToRad(e.z),"XYZ"),this._matrix_q.setFromEuler(this._matrix_e),this._matrix_s.copy(s).multiplyScalar(i),this._matrix.compose(t,this._matrix_q,this._matrix_s),this._matrix}rotate_geometry(t,e,s){this._rotate_geometry_vec_dest.copy(s),this._rotate_geometry_vec_dest.normalize(),this._rotate_geometry_q.setFromUnitVectors(e,this._rotate_geometry_vec_dest),this._rotate_geometry_m.makeRotationFromQuaternion(this._rotate_geometry_q),t.applyMatrix4(this._rotate_geometry_m)}}},351:function(t,e,s){"use strict";s.d(e,"a",(function(){return T}));var i,r=s(1),n=s(346),o=s(4),a=s(347),_=s(379),c=s(6),l=s(11);!function(t){t.EXR="exr",t.BASIS="basis",t.HDR="hdr"}(i||(i={}));class u{constructor(t,e){this._node=t,this._param=e}load_texture_from_url_or_op(t){return Object(r.a)(this,void 0,void 0,(function*(){let e,s=null;if("op:"==t.substring(0,3)){const i=t.substring(3);if(e=c.a.find_node(this._node,i),e)if(e instanceof a.a){s=(yield e.request_container()).texture()}else this._node.states.error.set("found node is not a texture node");else this._node.states.error.set(`no node found in path '${i}'`)}else s=yield this.load_url(t),s?this._param.options.texture_as_env()||(s=u.set_texture_for_mapping(s)):this._node.states.error.set(`could not load texture ${t}`);return e&&this._param.graph_predecessors()[0]!=e&&(this._param.graph_disconnect_predecessors(),this._param.add_graph_input(e)),s}))}load_url(t){return Object(r.a)(this,void 0,void 0,(function*(){return new Promise((e,s)=>Object(r.a)(this,void 0,void 0,(function*(){const i=u._ext(t);if(u.VIDEO_EXTENSIONS.includes(i)){return yield this._load_as_video(t)}this.loader_for_ext(i).then(i=>{i.load(t,e,void 0,t=>{console.warn("error",t),s()})})})))}))}loader_for_ext(t){return Object(r.a)(this,void 0,void 0,(function*(){switch(t.toLowerCase()){case i.EXR:{const{EXRLoader:t}=yield s.e(2).then(s.bind(null,621));return new t}case i.HDR:{const{RGBELoader:t}=yield s.e(3).then(s.bind(null,610)),e=new t;return e.setDataType(o.Wc),e}case i.BASIS:{const{BasisTextureLoader:t}=yield s.e(4).then(s.bind(null,622)),e=new t;e.setTranscoderPath("/three/js/libs/basis/");const i=yield l.a.instance().renderers_controller.wait_for_renderer();return i?e.detectSupport(i):console.warn("texture loader found no renderer for basis texture loader"),e}}return new _.a}))}_load_as_video(t){return new Promise((e,s)=>{const i=document.createElement("video");i.setAttribute("crossOrigin","anonymous"),i.setAttribute("autoplay","true"),i.setAttribute("loop","true"),i.onloadedmetadata=function(){i.pause();const t=new n.a(i);e(t)};const r=document.createElement("source"),o=u._ext(t);let a=u.VIDEO_SOURCE_TYPE_BY_EXT[o];a=a||u._default_video_source_type(t),r.setAttribute("type",a),r.setAttribute("src",t),i.appendChild(r)})}static _default_video_source_type(t){return`video/${this._ext(t)}`}static pixel_data(t){const e=t.image,s=document.createElement("canvas");s.width=e.width,s.height=e.height;const i=s.getContext("2d");if(i)return i.drawImage(e,0,0,e.width,e.height),i.getImageData(0,0,e.width,e.height)}static _ext(t){const e=t.split(".");return e[e.length-1].toLowerCase()}static set_texture_for_mapping(t){return t}}u.PARAM_DEFAULT="/examples/textures/uv.jpg",u.PARAM_ENV_DEFAULT="/examples/textures/piz_compressed.exr",u.VIDEO_EXTENSIONS=["mp4","webm","ogv"],u.VIDEO_SOURCE_TYPE_BY_EXT={ogg:'video/ogg; codecs="theora, vorbis"',ogv:'video/ogg; codecs="theora, vorbis"',mp4:'video/mp4; codecs="avc1.42E01E, mp4a.40.2"'};var h=s(0),d=s(7),p=s(44);const m=[{UVMapping:o.Uc},{CubeReflectionMapping:o.m},{CubeRefractionMapping:o.n},{EquirectangularReflectionMapping:o.A},{EquirectangularRefractionMapping:o.B},{SphericalReflectionMapping:o.Ic},{CubeUVReflectionMapping:o.o},{CubeUVRefractionMapping:o.p}],f=[{ClampToEdgeWrapping:o.l},{RepeatWrapping:o.rc},{MirroredRepeatWrapping:o.gb}],b=[{LinearFilter:o.R},{NearestFilter:o.kb}],g=[{NearestFilter:o.kb},{NearestMipMapNearestFilter:o.mb},{NearestMipMapLinearFilter:o.lb},{LinearFilter:o.R},{LinearMipMapNearestFilter:o.T},{LinearMipMapLinearFilter:o.S}],v=["mapping","wrapS","wrapT","minFilter","magFilter"],y={mapping:"mapping",wrapS:"wrap_s",wrapT:"wrap_t",minFilter:"min_filter",magFilter:"mag_filter"};class x extends p.a{constructor(){super(...arguments),this.url=p.b.STRING(u.PARAM_DEFAULT,{desktop_browse:{file_type:"texture"}}),this.reload=p.b.BUTTON(null,{callback:(t,e)=>{T.PARAM_CALLBACK_reload(t,e)}}),this.mapping=p.b.INTEGER(o.Uc,{menu:{entries:m.map(t=>({name:Object.keys(t)[0],value:Object.values(t)[0]}))}}),this.wrap_s=p.b.INTEGER(Object.values(f[0])[0],{menu:{entries:f.map(t=>({name:Object.keys(t)[0],value:Object.values(t)[0]}))}}),this.wrap_t=p.b.INTEGER(Object.values(f[0])[0],{menu:{entries:f.map(t=>({name:Object.keys(t)[0],value:Object.values(t)[0]}))}}),this.mag_filter=p.b.INTEGER(Object.values(b[0])[0],{menu:{entries:b.map(t=>({name:Object.keys(t)[0],value:Object.values(t)[0]}))}}),this.min_filter=p.b.INTEGER(Object.values(g[0])[0],{menu:{entries:g.map(t=>({name:Object.keys(t)[0],value:Object.values(t)[0]}))}})}}const E=new x;class T extends a.b{constructor(){super(...arguments),this.params_config=E}static type(){return"file"}cook(){return Object(r.a)(this,void 0,void 0,(function*(){this._is_static_image_url(this.pv.url)?yield this.cook_for_image():yield this.cook_for_video()}))}_is_static_image_url(t){return!0}cook_for_image(){return Object(r.a)(this,void 0,void 0,(function*(){const t=yield this._load_texture(this.pv.url);t?(this._update_texture_params(t),this.set_texture(t)):this.clear_texture()}))}cook_for_video(){return Object(r.a)(this,void 0,void 0,(function*(){if(this._param_url_changed()){const t=yield this._load_texture(this.pv.url);t&&this._add_video_spare_params_if_required(t),this._previous_param_url=this.pv.url,this._set_video_current_time(),t?(this._update_texture_params(t),this.set_texture(t)):this.cook_controller.end_cook()}}))}resolved_url(){return this.pv.url}_update_texture_params(t){for(let e of v){const s=y[e],i=this.params.float(s);null!=i&&t&&t[e]!=i&&(t[e]=i,t.needsUpdate=!0)}}static PARAM_CALLBACK_reload(t,e){t.param_callback_reload()}param_callback_reload(){this._previous_param_url=void 0,this.p.url.set_successors_dirty()}_set_video_current_time(){this._video&&this.params.has("video_time")&&(this._video.currentTime=this.params.float("video_time"))}_add_video_spare_params_if_required(t){if(t){if(t.constructor==n.a){if(this._video=t.image,this._video&&!this.params.has_param(T.VIDEO_TIME_PARAM_NAME)){const t=this._video.duration;this.add_param(h.a.FLOAT,T.VIDEO_TIME_PARAM_NAME,"$T",{spare:!0,cook:!0,range:[0,t],range_locked:[!0,!0]}),this.emit(d.a.PARAMS_UPDATED)}}else this._remove_spare_params()}else this._remove_spare_params()}_remove_spare_params(){this.params.has_param(T.VIDEO_TIME_PARAM_NAME)&&this.params.update_params({names_to_delete:[T.VIDEO_TIME_PARAM_NAME]})}_param_url_changed(){return this._previous_param_url!=this.pv.url}_load_texture(t){return Object(r.a)(this,void 0,void 0,(function*(){let e=null;const s=this.params.get("url");if(t&&s){this._texture_loader=this._texture_loader||new u(this,s);try{e=yield this._texture_loader.load_texture_from_url_or_op(t)}catch(t){}e||this.states.error.set(`could not load texture '${t}'`)}else this.states.error.set("not url given to Mat/Base._load_texture");return e}))}}T.VIDEO_TIME_PARAM_NAME="video_time",T.DEFAULT_NODE_PATH={UV:"/COP/file_uv",ENV_MAP:"/COP/env_map"}},352:function(t,e,s){"use strict";s.d(e,"e",(function(){return i})),s.d(e,"a",(function(){return r})),s.d(e,"b",(function(){return n})),s.d(e,"c",(function(){return o})),s.d(e,"d",(function(){return a})),s.d(e,"f",(function(){return _}));const i={LIGHT:"lights",MANAGER:"managers",GEOMETRY:"geometries",CAMERA:"cameras",MISC:"misc"},r={INPUT:"inputs",ADVANCED:"advanced",MISC:"misc"},n={CAMERA:"cameras",MISC:"misc"},o={COLOR:"color",CONVERSION:"conversion",DYNAMICS:"dynamics",GEOMETRY:"geometry",GLOBALS:"globals",LOGIC:"logic",MATH:"math",QUAT:"quat",TRIGO:"trigo",UTIL:"util",INSTANCE:"instance"},a={ADVANCED:"advanced",MESH:"meshes",POINTS:"points",LINE:"lines",VOLUME:"volumes",INSTANCE:"instances"},_={ADVANCED:"advanced",ANIMATION:"animation",ATTRIBUTE:"attributes",DYNAMICS:"dynamics",INPUT:"inputs",MISC:"misc",MODIFIER:"modifiers",PRIMITIVES:"primitives",RENDER:"render"}},354:function(t,e,s){"use strict";s.d(e,"a",(function(){return i}));class i{constructor(t){this.node=t}add_params(){}update(){}get material(){return this.node.material}}},355:function(t,e,s){"use strict";s.d(e,"b",(function(){return _})),s.d(e,"a",(function(){return c}));var i=s(354),r=s(4),n=s(330),o=s(339),a=s(44);function _(t){return class extends t{constructor(){super(...arguments),this.double_sided=a.b.BOOLEAN(0),this.front=a.b.BOOLEAN(1,{visible_if:{double_sided:!1}})}}}n.a;_(a.a);o.a;class c extends i.a{static update(t){const e=t.pv.front?r.E:r.h,s=t.pv.double_sided?r.w:e;s!=t.material.side&&(t.material.side=s,t.material.needsUpdate=!0)}}},359:function(t,e,s){"use strict";s.d(e,"a",(function(){return d}));var i=s(129),r=s.n(i),n=s(334),o=s(45),a=s(0),_=s(348),c=s(44);const l=[o.c.FLOAT,o.c.VEC2,o.c.VEC3,o.c.VEC4];class u extends c.a{constructor(){super(...arguments),this.name=c.b.STRING(""),this.type=c.b.INTEGER(0,{menu:{entries:l.map((t,e)=>({name:t,value:e}))}})}}const h=new u;class d extends n.b{constructor(){super(...arguments),this.params_config=h,this._on_create_set_name_if_none_bound=this._on_create_set_name_if_none.bind(this),this.gl_connections_controller=new _.a(this)}static type(){return"attribute"}initialize_node(){this.add_post_dirty_hook("_set_mat_to_recompile",this._set_mat_to_recompile_if_is_exporting.bind(this)),this.lifecycle.add_on_create_hook(this._on_create_set_name_if_none_bound),this.gl_connections_controller.initialize_node(),this.gl_connections_controller.set_expected_input_types_function(()=>[]),this.gl_connections_controller.set_expected_output_types_function(()=>[l[this.pv.type]])}create_params(){var t;(null===(t=this.material_node)||void 0===t?void 0:t.assembler_controller.allow_attribute_exports())&&this.add_param(a.a.BOOLEAN,"export_when_connected",0)}get input_name(){return d.INPUT_NAME}get output_name(){return d.OUTPUT_NAME}set_lines(t){var e;null===(e=this.material_node)||void 0===e||e.assembler_controller.assembler.set_node_lines_attribute(this,t)}get attribute_name(){return r()(this.pv.name)}gl_type(){return this.io.outputs.named_output_connection_points[0].type}connected_input_node(){return this.io.inputs.named_input(d.INPUT_NAME)}connected_input_connection_point(){return this.io.inputs.named_input_connection_point(d.INPUT_NAME)}output_connection_point(){return this.io.outputs.named_output_connection_points_by_name(this.input_name)}get is_importing(){return this.io.outputs.used_output_names().length>0}get is_exporting(){if(this.pv.export_when_connected){return null!=this.io.inputs.named_input(d.INPUT_NAME)}return!1}_set_mat_to_recompile_if_is_exporting(){this.is_exporting&&this._set_mat_to_recompile()}_on_create_set_name_if_none(){""==this.pv.name&&this.p.name.set(this.name)}}d.INPUT_NAME="export",d.OUTPUT_NAME="val"},360:function(t,e,s){"use strict";s.d(e,"a",(function(){return i}));class i{constructor(t,e,s){this._name=t,this._input_names=e,this._dependencies=s}name(){return this._name}input_names(){return this._input_names}dependencies(){return this._dependencies}}},361:function(t,e,s){"use strict";s.d(e,"a",(function(){return i}));class i{constructor(t,e={}){this._name=t,this._options=e}name(){return this._name}default_from_attribute(){return this._options.default_from_attribute||!1}default(){return this._options.default}if_condition(){return this._options.if}prefix(){return this._options.prefix||""}suffix(){return this._options.suffix||""}}},362:function(t,e,s){"use strict";s.d(e,"b",(function(){return a})),s.d(e,"a",(function(){return _}));var i=s(354),r=s(330),n=s(44),o=s(339);function a(t){return class extends t{constructor(){super(...arguments),this.skinning=n.b.BOOLEAN(0)}}}r.a;a(n.a);o.a;class _ extends i.a{static update(t){const e=t.pv.skinning;e!=t.material.skinning&&(t.material.skinning=e,t.material.needsUpdate=!0)}}},363:function(t,e,s){"use strict";s.d(e,"b",(function(){return c})),s.d(e,"a",(function(){return l}));var i=s(1),r=s(330),n=s(351),o=s(339),a=s(389),_=s(44);function c(t){return class extends t{constructor(){super(...arguments),this.use_map=_.b.BOOLEAN(0,Object(a.b)(l)),this.map=_.b.OPERATOR_PATH(n.a.DEFAULT_NODE_PATH.UV,Object(a.c)(l,"use_map"))}}}r.a;c(_.a);o.a;class l extends a.a{constructor(t,e){super(t,e)}initialize_node(){this.add_hooks(this.node.p.use_map,this.node.p.map)}update(){return Object(i.a)(this,void 0,void 0,(function*(){this._update(this.node.material,"map",this.node.p.use_map,this.node.p.map)}))}static update(t){return Object(i.a)(this,void 0,void 0,(function*(){t.texture_map_controller.update()}))}}},364:function(t,e,s){"use strict";s.d(e,"b",(function(){return c})),s.d(e,"a",(function(){return l}));var i=s(1),r=s(330),n=s(351),o=s(339),a=s(389),_=s(44);function c(t){return class extends t{constructor(){super(...arguments),this.use_alpha_map=_.b.BOOLEAN(0,Object(a.b)(l)),this.alpha_map=_.b.OPERATOR_PATH(n.a.DEFAULT_NODE_PATH.UV,Object(a.c)(l,"use_alpha_map"))}}}r.a;c(_.a);o.a;class l extends a.a{constructor(t,e){super(t,e)}initialize_node(){this.add_hooks(this.node.p.use_alpha_map,this.node.p.alpha_map)}update(){return Object(i.a)(this,void 0,void 0,(function*(){this._update(this.node.material,"alphaMap",this.node.p.use_alpha_map,this.node.p.alpha_map)}))}static update(t){return Object(i.a)(this,void 0,void 0,(function*(){t.texture_alpha_map_controller.update()}))}}},365:function(t,e,s){"use strict";s.d(e,"a",(function(){return A}));var i=s(1),r=s(397),n=s.n(r),o=s(384),a=s.n(o),_=s(137),c=s.n(_),l=s(12),u=s(58),h=s(345),d=s(15);class p{constructor(t){this._scene=t,this._data={}}data(){this._scene.nodes_controller.reset_node_context_signatures();const t=O.dispatch_node(this._scene.root),e=t.data(),s=t.ui_data();return this._data={properties:{frame:this._scene.frame||1,frame_range:this._scene.frame_range,frame_range_locked:this._scene.time_controller.frame_range_locked,master_camera_node_path:this._scene.cameras_controller.master_camera_node_path},root:e,ui:s},this._data}static sanitize_string(t){return t=t.replace(/'/g,"'"),t=d.a.escape_line_breaks(t)}}class m{constructor(t){this._node=t}data(){var t,e,s,i;this.is_root()||this._node.scene.nodes_controller.register_node_context_signature(this._node),this._data={type:this._node.type};const r=this.nodes_data();if(Object.keys(r).length>0){this._data.nodes=r;const e=null===(t=this._node.children_controller)||void 0===t?void 0:t.context;e&&(this._data.children_context=e)}if(this.is_root()||(this._data.params=this.params_data(),this._data.inputs=this.inputs_data()),this._node.flags&&(this._data.flags={},this._node.flags.has_bypass()&&(null===(e=this._node.flags.bypass)||void 0===e?void 0:e.active)&&(this._data.flags.bypass=this._node.flags.bypass.active),this._node.flags.has_display()&&(this._data.flags.display=null===(s=this._node.flags.display)||void 0===s?void 0:s.active)),this._node.children_allowed()){const t=null===(i=this._node.children_controller)||void 0===i?void 0:i.selection;if(t&&this._node.children().length>0){const e=[],s={};for(let e of t.nodes())s[e.graph_node_id]=!0;for(let t of this._node.children())t.graph_node_id in s&&e.push(t);this._data.selection=e.map(t=>t.name)}}if(this._node.io.inputs.override_clonable_state_allowed()){const t=this._node.io.inputs.override_clonable_state();t&&(this._data.override_clonable_state=t)}return this.add_custom(),this._data}ui_data(){const t={};if(!this.is_root()){const e=this._node.ui_data;t.pos=e.position.toArray();const s=e.comment;s&&(t.comment=p.sanitize_string(s))}const e=this._node.children();return e.length>0&&(t.nodes={},e.forEach(e=>{const s=O.dispatch_node(e);t.nodes[e.name]=s.ui_data()})),t}is_root(){return null===this._node.parent&&this._node.graph_node_id==this._node.root.graph_node_id}inputs_data(){const t=[];return this._node.io.inputs.inputs().forEach((e,s)=>{if(e){const i=this._node.io.connections.input_connection(s);if(this._node.io.inputs.has_named_inputs){const r=this._node.io.inputs.named_input_connection_points[s].name,n=i.output_index,o=e.io.outputs.named_output_connection_points[n].name;t.push({name:r,node:e.name,output:o})}else t.push(e.name)}}),t}params_data(){const t={};for(let e of this._node.params.names){const s=this._node.params.get(e);if(s&&!s.parent_param){const e=O.dispatch_param(s);if(e.required){const i=e.data();t[s.name]=i}}}return t}nodes_data(){const t={};for(let e of this._node.children()){const s=O.dispatch_node(e);t[e.name]=s.data()}return t}add_custom(){}}class f{constructor(t){this._param=t,this._complex_data={}}get required(){const t=this._param.options.is_spare&&!this._param.parent_param,e=!this._param.is_default;return t||e}data(){if(this._param.parent_param)throw console.warn("no component should be saved"),"no component should be saved";return this._require_data_complex()?this._data_complex():this._data_simple()}_data_simple(){return this._param.raw_input_serialized}_data_complex(){if(this._complex_data={},this._param.options.is_spare&&!this._param.parent_param&&(this._complex_data.type=this._param.type,this._complex_data.default_value=this._param.default_value_serialized,this._complex_data.raw_input=this._param.raw_input_serialized,this._complex_data.options=this._param.options.current),this._param.is_default||this.add_main(),this._param.options.has_options_overridden){const t={},e=this._param.options.overridden_options;for(let s of Object.keys(e)){const i=e[s];t[s]=JSON.stringify(i)}this._complex_data.overriden_options=t}return this._complex_data}_require_data_complex(){return!!this._param.options.is_spare||!!this._param.options.has_options_overridden}add_main(){}}class b extends f{add_main(){if(!this._require_data_complex())return this._param.raw_input_serialized;this._complex_data.raw_input=this._param.raw_input_serialized}}class g extends f{add_main(){let t=this._param.raw_input;if(t=p.sanitize_string(t),!this._require_data_complex())return t;this._complex_data.raw_input=t}}class v extends f{add_main(){let t=this._param.raw_input;if(t=p.sanitize_string(t),!this._require_data_complex())return t;this._complex_data.raw_input=t}}class y extends f{add_main(){if(!this._require_data_complex())return this._param.raw_input_serialized;this._complex_data.raw_input=this._param.raw_input_serialized}}var x=s(43),E=s(139),T=s(67),w=s(28);class O{static dispatch_node(t){return new m(t)}static dispatch_param(t){return t instanceof x.a?new b(t):t instanceof E.a?new g(t):t instanceof T.a?new v(t):t instanceof w.a?new y(t):new f(t)}}u.b;class A{constructor(t,e){this.node=t,this._globals_handler=new h.a,this._compile_required=!0,this._deleted_params_data=new Map,this._assembler=new e(this.node)}set_assembler_globals_handler(t){(this._globals_handler?this._globals_handler.id():null)!=(t?t.id():null)&&(this._globals_handler=t,this.set_compilation_required_and_dirty(),this._assembler.reset_configs())}get assembler(){return this._assembler}get globals_handler(){return this._globals_handler}add_output_params(t){this._assembler.add_output_params(t)}add_globals_params(t){this._assembler.add_globals_params(t)}allow_attribute_exports(){return this._assembler.allow_attribute_exports()}on_create(){const t=this.node.create_node("globals"),e=this.node.create_node("output");t.ui_data.set_position(new l.a(-200,0)),e.ui_data.set_position(new l.a(200,0))}set_compilation_required(t=!0){this._compile_required=t}set_compilation_required_and_dirty(t){this.set_compilation_required(),this.node.set_dirty(t)}compile_required(){return this._compile_required}post_compile(){return Object(i.a)(this,void 0,void 0,(function*(){this.create_spare_parameters(),this.set_compilation_required(!1)}))}assign_uniform_values(){return Object(i.a)(this,void 0,void 0,(function*(){if(this._assembler)for(let t of this._assembler.param_configs())yield t.set_uniform_value(this.node)}))}create_spare_parameters(){const t=this.node.params.spare_names,e=this._assembler.param_configs(),s=e.map(t=>t.name),i=c()(s,t),r=c()(t,s),o={},_=this.node.params.names,l=a()(i,_);if(l.length>0){const t=`${this.node.full_path()} attempts to create spare params called '${l.join(", ")}' with same name as params`;console.warn(t),this.node.states.error.set(t)}r.forEach(t=>{const e=this.node.params.get(t);if(e){const t=O.dispatch_param(e);if(t.required){const s=t.data();this._deleted_params_data.set(e.name,s)}}o.names_to_delete=o.names_to_delete||[],o.names_to_delete.push(t)});for(let t of e)if(i.indexOf(t.name)>=0){const e=n()(t.param_options,{spare:!0,cook:!0});o.to_add=o.to_add||[],o.to_add.push({name:t.name,type:t.type,init_value:t.default_value,options:e})}this.node.params.update_params(o)}}},366:function(t,e,s){"use strict";s.d(e,"a",(function(){return S}));var i,r=s(1),n=s(12);!function(t){t.FUNCTION_DECLARATION="function_declaration",t.DEFINE="define",t.BODY="body"}(i||(i={}));var o=s(360),a=s(361),_=s(30),c=s.n(_),l=s(386),u=s(119),h=s(331),d=s(371),p=s(376);class m{constructor(t){this._shader_name=t,this._definitions_by_node_id=new Map,this._body_lines_by_node_id=new Map}get shader_name(){return this._shader_name}add_definitions(t,e){for(let s of e)u.a.push_on_array_at_entry(this._definitions_by_node_id,t.graph_node_id,s)}definitions(t){return this._definitions_by_node_id.get(t.graph_node_id)}add_body_lines(t,e){for(let s of e)u.a.push_on_array_at_entry(this._body_lines_by_node_id,t.graph_node_id,s)}body_lines(t){return this._body_lines_by_node_id.get(t.graph_node_id)}}class f{constructor(t,e){this._shader_names=t,this._current_shader_name=e,this._lines_controller_by_shader_name=new Map;for(let t of this._shader_names)this._lines_controller_by_shader_name.set(t,new m(t))}get shader_names(){return this._shader_names}set_current_shader_name(t){this._current_shader_name=t}get current_shader_name(){return this._current_shader_name}add_definitions(t,e,s){if(0==e.length)return;s=s||this._current_shader_name;const i=this._lines_controller_by_shader_name.get(s);i&&i.add_definitions(t,e)}definitions(t,e){const s=this._lines_controller_by_shader_name.get(t);if(s)return s.definitions(e)}add_body_lines(t,e,s){if(0==e.length)return;s=s||this._current_shader_name;const i=this._lines_controller_by_shader_name.get(s);i&&i.add_body_lines(t,e)}body_lines(t,e){const s=this._lines_controller_by_shader_name.get(t);if(s)return s.body_lines(e)}}const b={[i.FUNCTION_DECLARATION]:"",[i.DEFINE]:";",[i.BODY]:";"},g={[i.FUNCTION_DECLARATION]:"",[i.DEFINE]:"",[i.BODY]:"\t"};class v{static node_comment(t,e){let s=`// ${t.full_path()}`;return e==i.BODY&&(s=`\t${s}`),s}static line_wrap(t,e){let s=!0;return 0!=t.indexOf("#if")&&0!=t.indexOf("#endif")||(s=!1),s?`${g[e]}${t}${b[e]}`:`${g[e]}${t}`}static post_line_separator(t){return t==i.BODY?"\t":""}}class y{constructor(t,e){this._assembler=t,this._gl_parent_node=e,this._param_configs_controller=new p.a,this._param_configs_set_allowed=!0,this._lines=new Map,this._function_declared=new Map}build_from_nodes(t){return Object(r.a)(this,void 0,void 0,(function*(){const e=new l.a(this._assembler,this._gl_parent_node);e.traverse(t);const s=new Map;for(let t of this.shader_names())s.set(t,e.nodes_for_shader_name(t));const i=e.sorted_nodes();for(let t of this.shader_names()){const e=this._assembler.root_nodes_by_shader_name(t);for(let i of e)u.a.push_on_array_at_entry(s,t,i)}const r=new Map;for(let t of i)r.set(t.graph_node_id,!0);for(let e of t)r.get(e.graph_node_id)||(i.push(e),r.set(e.graph_node_id,!0));for(let t of i)t.reset_code();for(let t of i)yield t.params.eval_all();this._shaders_collection_controller=new f(this.shader_names(),this.shader_names()[0]),this.reset();for(let t of this.shader_names()){const e=c()(s.get(t));if(this._shaders_collection_controller.set_current_shader_name(t),e)for(let t of e)this._param_configs_set_allowed&&t.set_param_configs(),t.set_lines(this._shaders_collection_controller)}this._param_configs_set_allowed&&this.set_param_configs(i),this.set_code_lines(i)}))}disallow_new_param_configs(){this._param_configs_set_allowed=!1}allow_new_param_configs(){this._param_configs_set_allowed=!0}shader_names(){return this._assembler.shader_names}reset(){for(let t of this.shader_names()){const e=new Map;this._lines.set(t,e),this._function_declared.set(t,new Map)}}param_configs(){return this._param_configs_controller.list||[]}lines(t,e){return this._lines.get(t).get(e)}all_lines(){return this._lines}set_param_configs(t){this._param_configs_controller.reset();for(let e of t){const t=e.param_configs();if(t)for(let e of t)this._param_configs_controller.push(e)}}set_code_lines(t){for(let e of this.shader_names())this.add_code_lines(t,e)}add_code_lines(t,e){this.add_definitions(t,e,h.c.FUNCTION,i.FUNCTION_DECLARATION),this.add_definitions(t,e,h.c.UNIFORM,i.DEFINE),this.add_definitions(t,e,h.c.VARYING,i.DEFINE),this.add_definitions(t,e,h.c.ATTRIBUTE,i.DEFINE),this.add_code_line_for_nodes_and_line_type(t,e,i.BODY)}add_definitions(t,e,s,i){if(!this._shaders_collection_controller)return;const r=[];for(let i of t){let t=this._shaders_collection_controller.definitions(e,i);if(t){t=t.filter(t=>t.definition_type==s);for(let e of t)r.push(e)}}if(r.length>0){const t=new d.a(r),s=t.uniq();if(t.errored)throw`code builder error: ${t.error_message}`;const n=new Map,o=new Map;for(let t of s){const e=t.node.graph_node_id;o.has(e)||o.set(e,!0),u.a.push_on_array_at_entry(n,e,t)}const a=this._lines.get(e);o.forEach((t,e)=>{const s=n.get(e);if(s){const t=s[0];if(t){const e=v.node_comment(t.node,i);u.a.push_on_array_at_entry(a,i,e);for(let t of s){const e=v.line_wrap(t.line,i);u.a.push_on_array_at_entry(a,i,e)}const r=v.post_line_separator(i);u.a.push_on_array_at_entry(a,i,r)}}})}}add_code_line_for_nodes_and_line_type(t,e,s){var i=(t=t.filter(t=>{if(this._shaders_collection_controller){const s=this._shaders_collection_controller.body_lines(e,t);return s&&s.length>0}})).length;for(let r=0;r<i;r++){const i=r==t.length-1;this.add_code_line_for_node_and_line_type(t[r],e,s,i)}}add_code_line_for_node_and_line_type(t,e,s,r){if(!this._shaders_collection_controller)return;const n=this._shaders_collection_controller.body_lines(e,t);if(n&&n.length>0){const o=this._lines.get(e),a=v.node_comment(t,s);if(u.a.push_on_array_at_entry(o,s,a),c()(n).forEach(t=>{t=v.line_wrap(t,s),u.a.push_on_array_at_entry(o,s,t)}),s!=i.BODY||!r){const t=v.post_line_separator(s);u.a.push_on_array_at_entry(o,s,t)}}}}var x=s(345);var E=s(333),T=s(0),w=s(118),O=s(45),A=s(387),R=s(359);const N=new Map([[E.b.VERTEX,"#include <common>"],[E.b.FRAGMENT,"#include <common>"]]),j=new Map([[E.b.VERTEX,"#include <color_vertex>"],[E.b.FRAGMENT,"vec4 diffuseColor = vec4( diffuse, opacity );"]]),I=new Map([[E.b.VERTEX,["#include <begin_vertex>","#include <beginnormal_vertex>"]],[E.b.FRAGMENT,[]]]);class S extends class{}{constructor(t){super(),this._gl_parent_node=t,this._shaders_by_name=new Map,this._lines=new Map,this._root_nodes=[],this._leaf_nodes=[],this._uniforms_time_dependent=!1,this._resolution_dependent=!1}compile(){return Object(r.a)(this,void 0,void 0,(function*(){}))}_template_shader_for_shader_name(t){var e,s;switch(t){case E.b.VERTEX:return null===(e=this._template_shader)||void 0===e?void 0:e.vertexShader;case E.b.FRAGMENT:return null===(s=this._template_shader)||void 0===s?void 0:s.fragmentShader}}get globals_handler(){return this._gl_parent_node.assembler_controller.globals_handler}compile_allowed(){return null!=this._gl_parent_node.assembler_controller.globals_handler}shaders_by_name(){return this._shaders_by_name}_build_lines(){for(let t of this.shader_names){const e=this._template_shader_for_shader_name(t);e&&this._replace_template(e,t)}}set_root_nodes(t){this._root_nodes=t}get _template_shader(){}add_uniforms(t){for(let e of this.param_configs())t[e.uniform_name]=e.uniform;this.uniforms_time_dependent()&&(t.time={value:this._gl_parent_node.scene.time}),this.resolution_dependent()&&(t.resolution={value:new n.a(1e3,1e3)})}root_nodes_by_shader_name(t){const e=[];for(let t of this._root_nodes)switch(t.type){case"output":e.push(t)}return e}leaf_nodes_by_shader_name(t){const e=[];for(let t of this._leaf_nodes)switch(t.type){case A.a.type():e.push(t);break;case R.a.type():}return e}set_node_lines_globals(t,e){}set_node_lines_output(t,e){}set_node_lines_attribute(t,e){}get code_builder(){return this._code_builder=this._code_builder||new y(this,this._gl_parent_node)}build_code_from_nodes(t){return Object(r.a)(this,void 0,void 0,(function*(){yield this.code_builder.build_from_nodes(t)}))}allow_new_param_configs(){this.code_builder.allow_new_param_configs()}disallow_new_param_configs(){this.code_builder.disallow_new_param_configs()}builder_param_configs(){return this.code_builder.param_configs()}builder_lines(t,e){return this.code_builder.lines(t,e)}all_builder_lines(){return this.code_builder.all_lines()}param_configs(){return(this._param_config_owner||this.code_builder).param_configs()}set_param_configs_owner(t){this._param_config_owner=t,this._param_config_owner?this.code_builder.disallow_new_param_configs():this.code_builder.allow_new_param_configs()}static add_output_params(t){t.params.add_param(T.a.VECTOR3,"position",[0,0,0],{hidden:!0}),t.params.add_param(T.a.VECTOR3,"normal",[0,0,0],{hidden:!0}),t.params.add_param(T.a.COLOR,"color",[1,1,1],{hidden:!0}),t.params.add_param(T.a.FLOAT,"alpha",1,{hidden:!0}),t.params.add_param(T.a.VECTOR2,"uv",[0,0],{hidden:!0})}add_output_params(t){S.add_output_params(t)}static create_globals_node_output_connections(){return[new w.a("position",O.c.VEC3),new w.a("normal",O.c.VEC3),new w.a("color",O.c.VEC3),new w.a("uv",O.c.VEC2),new w.a("gl_FragCoord",O.c.VEC4),new w.a("resolution",O.c.VEC2),new w.a("time",O.c.FLOAT)]}create_globals_node_output_connections(){return S.create_globals_node_output_connections()}add_globals_params(t){t.io.outputs.set_named_output_connection_points(this.create_globals_node_output_connections())}allow_attribute_exports(){return!1}reset_configs(){this._reset_shader_configs(),this._reset_variable_configs(),this._reset_uniforms_time_dependency(),this._reset_resolution_dependency()}get shader_configs(){return this._shader_configs=this._shader_configs||this.create_shader_configs()}set_shader_configs(t){this._shader_configs=t}get shader_names(){var t;return(null===(t=this.shader_configs)||void 0===t?void 0:t.map(t=>t.name()))||[]}_reset_shader_configs(){this._shader_configs=void 0}create_shader_configs(){return[new o.a(E.b.VERTEX,["position","normal","uv"],[]),new o.a(E.b.FRAGMENT,["color","alpha"],[E.b.VERTEX])]}shader_config(t){var e;return null===(e=this.shader_configs)||void 0===e?void 0:e.filter(e=>e.name()==t)[0]}variable_configs(){return this._variable_configs=this._variable_configs||this.create_variable_configs()}set_variable_configs(t){this._variable_configs=t}variable_config(t){return this.variable_configs().filter(e=>e.name()==t)[0]}static create_variable_configs(){return[new a.a("position",{default_from_attribute:!0,prefix:"vec3 transformed = "}),new a.a("normal",{default_from_attribute:!0,prefix:"vec3 objectNormal = "}),new a.a("color",{prefix:"diffuseColor.xyz = "}),new a.a("alpha",{prefix:"diffuseColor.a = "}),new a.a("uv",{prefix:"vUv = ",if:x.a.IF_RULE.uv})]}create_variable_configs(){return S.create_variable_configs()}_reset_variable_configs(){this._variable_configs=void 0,this.variable_configs()}input_names_for_shader_name(t,e){var s;return(null===(s=this.shader_config(e))||void 0===s?void 0:s.input_names())||[]}_reset_uniforms_time_dependency(){this._uniforms_time_dependent=!1}set_uniforms_time_dependent(){this._uniforms_time_dependent=!0}uniforms_time_dependent(){return this._uniforms_time_dependent}_reset_resolution_dependency(){this._resolution_dependent=!1}set_resolution_dependent(){this._resolution_dependent=!0}resolution_dependent(){return this._resolution_dependent}insert_define_after(t){return N.get(t)}insert_body_after(t){return j.get(t)}lines_to_remove(t){return I.get(t)}_replace_template(t,e){const s=this.builder_lines(e,i.FUNCTION_DECLARATION),r=this.builder_lines(e,i.DEFINE),n=this.builder_lines(e,i.BODY);let o=t.split("\n");const a=[],_=this.insert_define_after(e),c=this.insert_body_after(e),l=this.lines_to_remove(e);let u=!1,h=!1;for(let t of o){1==u&&(s&&this._insert_lines(a,s),r&&this._insert_lines(a,r),u=!1),1==h&&(n&&this._insert_lines(a,n),h=!1);let e=!1;if(l)for(let s of l)t.indexOf(s)>=0&&(e=!0);e?(a.push("// removed:"),a.push(`//${t}`)):a.push(t),_&&t.indexOf(_)>=0&&(u=!0),c&&t.indexOf(c)>=0&&(h=!0)}this._lines.set(e,a)}_insert_lines(t,e){if(e.length>0){for(let e=0;e<3;e++)t.push("");for(let s of e)t.push(s);for(let e=0;e<3;e++)t.push("")}}get_custom_materials(){return Object(r.a)(this,void 0,void 0,(function*(){return new Map}))}}},371:function(t,e,s){"use strict";s.d(e,"a",(function(){return i}));class i{constructor(t=[]){this._definitions=t,this._errored=!1}get errored(){return this._errored}get error_message(){return this._error_message}uniq(){const t=new Map,e=[];for(let s of this._definitions)if(!this._errored){const i=s.name,r=t.get(i);r?r.data_type!=s.data_type&&(this._errored=!0,this._error_message=`attempt to create ${s.name} with types ${s.data_type}`,console.warn("emitting error message",this._error_message)):(t.set(i,s),e.push(i))}const s=[];for(let i of e){const e=t.get(i);e&&s.push(e)}return s}}},376:function(t,e,s){"use strict";s.d(e,"a",(function(){return d}));var i=s(1),r=s(346),n=s(36),o=s(2),a=s(12),_=s(0),c=s(141),l=s(35),u=s(130);class h{constructor(t,e,s,i){this._type=t,this._name=e,this._default_value=s,this._uniform_name=i}static from_param(t,e){return new h(t.type,t.name,t.default_value,e)}get type(){return this._type}get name(){return this._name}get default_value(){return this._default_value}get uniform_name(){return this._uniform_name}get uniform(){return this._uniform=this._uniform||this._create_uniform()}_create_uniform(){return h.uniform_by_type(this._type)}get param_options(){const t=this._callback.bind(this);switch(this._type){case _.a.OPERATOR_PATH:return{callback:t,node_selection:{context:l.a.COP}};default:return{callback:t}}}_callback(t,e){this.uniform.value=e.value}static uniform_by_type(t){switch(t){case _.a.BOOLEAN:case _.a.BUTTON:return{value:0};case _.a.COLOR:return{value:new o.a(0,0,0)};case _.a.FLOAT:case _.a.FOLDER:case _.a.INTEGER:case _.a.OPERATOR_PATH:return{value:0};case _.a.RAMP:return{value:null};case _.a.SEPARATOR:return{value:0};case _.a.STRING:return{value:null};case _.a.VECTOR2:return{value:new a.a(0,0)};case _.a.VECTOR3:return{value:new o.a(0,0,0)};case _.a.VECTOR4:return{value:new n.a(0,0,0,0)}}u.a.unreachable(t)}set_uniform_value(t){return Object(i.a)(this,void 0,void 0,(function*(){const e=this.uniform,s=t.params.get(this._name);if(s){yield s.compute();const t=s.value;if(null!=t&&this.has_value_changed(t)||this.is_video_texture())switch(this._type){case _.a.OPERATOR_PATH:yield this.set_uniform_value_from_texture(s,e);break;case _.a.RAMP:this.set_uniform_value_from_ramp(s,e);break;default:e.value=s.value}}}))}set_uniform_value_from_texture(t,e){return Object(i.a)(this,void 0,void 0,(function*(){const s=t.found_node();if(s){const t=(yield s.request_container()).texture();e.value=t}else e.value=null}))}set_uniform_value_from_ramp(t,e){e.value=t.ramp_texture()}has_value_changed(t){const e=c.a[this._type];if(this._cached_param_value){const s=!e.are_values_equal(t,this._cached_param_value);return s&&(this._cached_param_value=e.clone_value(t)),s}return this._cached_param_value=e.clone_value(t),!1}is_video_texture(){let t=!1;const e=this.uniform;if(e){const s=e.value;s&&(t=s.constructor==r.a)}return t}}class d{constructor(){this._param_configs=[]}reset(){this._param_configs=[]}push(t){this._param_configs.push(t)}create_and_push(t,e,s,i){const r=new h(t,e,s,i);this._param_configs.push(r)}get list(){return this._param_configs}}},385:function(t,e,s){"use strict";s.d(e,"a",(function(){return i}));class i{constructor(){this._id=i.__next_id++}id(){return this._id}handle_globals_node(t,e,s){}}i.__next_id=0},386:function(t,e,s){"use strict";s.d(e,"a",(function(){return c}));var i=s(27),r=s.n(i),n=s(30),o=s.n(n),a=s(119),_=s(333);class c{constructor(t,e){this._assembler=t,this._gl_parent_node=e,this._leaves_graph_id=new Map,this._graph_ids_by_shader_name=new Map,this._outputs_by_graph_id=new Map,this._depth_by_graph_id=new Map,this._graph_id_by_depth=new Map,this._graph=this._gl_parent_node.scene.graph}reset(){this._leaves_graph_id.clear(),this._outputs_by_graph_id.clear(),this._depth_by_graph_id.clear(),this._graph_id_by_depth.clear(),this.shader_names().forEach(t=>{this._graph_ids_by_shader_name.set(t,new Map)})}shader_names(){return this._assembler.shader_names}input_names_for_shader_name(t,e){return this._assembler.input_names_for_shader_name(t,e)}traverse(t){this.reset();for(let t of this.shader_names())this._leaves_graph_id.set(t,new Map);for(let e of this.shader_names()){this._shader_name=e;for(let e of t)this.find_leaves_from_root_node(e),this.set_nodes_depth()}this._depth_by_graph_id.forEach((t,e)=>{null!=t&&a.a.push_on_array_at_entry(this._graph_id_by_depth,t,e)})}leaves_from_nodes(t){var e;this._shader_name=_.b.LEAVES_FROM_NODES_SHADER,this._graph_ids_by_shader_name.set(this._shader_name,new Map),this._leaves_graph_id.set(this._shader_name,new Map);for(let e of t)this.find_leaves(e);const s=[];return null===(e=this._leaves_graph_id.get(this._shader_name))||void 0===e||e.forEach((t,e)=>{s.push(e)}),this._graph.nodes_from_ids(s)}nodes_for_shader_name(t){const e=[];this._graph_id_by_depth.forEach((t,s)=>{e.push(s)}),e.sort((t,e)=>t-e);const s=[];return e.forEach(e=>{const i=this._graph_id_by_depth.get(e);i&&i.forEach(e=>{var i;if(null===(i=this._graph_ids_by_shader_name.get(t))||void 0===i?void 0:i.get(e)){const t=this._graph.node_from_id(e);s.push(t)}})}),s}sorted_nodes(){const t=[];this._graph_id_by_depth.forEach((e,s)=>{t.push(s)}),t.sort((t,e)=>t-e);const e=[];return t.forEach(t=>{const s=this._graph_id_by_depth.get(t);if(s)for(let t of s){const s=this._graph.node_from_id(t);s&&e.push(s)}}),e}find_leaves_from_root_node(t){var e;null===(e=this._graph_ids_by_shader_name.get(this._shader_name))||void 0===e||e.set(t.graph_node_id,!0);const s=this.input_names_for_shader_name(t,this._shader_name);if(s)for(let e of s){const s=t.io.inputs.named_input(e);s&&(a.a.push_on_array_at_entry(this._outputs_by_graph_id,s.graph_node_id,t.graph_node_id),this.find_leaves(s))}this._outputs_by_graph_id.forEach((t,e)=>{this._outputs_by_graph_id.set(e,o()(t))})}find_leaves(t){var e;null===(e=this._graph_ids_by_shader_name.get(this._shader_name))||void 0===e||e.set(t.graph_node_id,!0);const s=r()(t.io.inputs.inputs()),i=o()(s.map(t=>t.graph_node_id)).map(t=>this._graph.node_from_id(t));if(i.length>0)for(let e of i)a.a.push_on_array_at_entry(this._outputs_by_graph_id,e.graph_node_id,t.graph_node_id),this.find_leaves(e);else this._leaves_graph_id.get(this._shader_name).set(t.graph_node_id,!0)}set_nodes_depth(){this._leaves_graph_id.forEach((t,e)=>{t.forEach((t,e)=>{this.set_node_depth(e)})})}set_node_depth(t,e=0){const s=this._depth_by_graph_id.get(t);null!=s?this._depth_by_graph_id.set(t,Math.max(s,e)):this._depth_by_graph_id.set(t,e);const i=this._outputs_by_graph_id.get(t);i&&i.forEach(t=>{this.set_node_depth(t,e+1)})}}},387:function(t,e,s){"use strict";s.d(e,"a",(function(){return a}));var i=s(334),r=s(44);class n extends r.a{}const o=new n;class a extends i.b{constructor(){super(...arguments),this.params_config=o}static type(){return"globals"}create_params(){var t;null===(t=this.material_node)||void 0===t||t.assembler_controller.add_globals_params(this)}set_lines(t){var e,s;null===(s=null===(e=this.material_node)||void 0===e?void 0:e.assembler_controller)||void 0===s||s.assembler.set_node_lines_globals(this,t)}}},388:function(t,e,s){"use strict";s.d(e,"a",(function(){return i}));class i{static find_output_nodes(t){return t.nodes_by_type("output")}static find_attribute_export_nodes(t){return t.nodes_by_type("attribute").filter(t=>t.is_exporting)}}},389:function(t,e,s){"use strict";s.d(e,"b",(function(){return o})),s.d(e,"c",(function(){return a})),s.d(e,"a",(function(){return _}));var i=s(1),r=s(354),n=(s(351),s(44),s(35));function o(t){return{cook:!1,callback:(e,s)=>{t.update(e)}}}function a(t,e){return{visible_if:{[e]:1},node_selection:{context:n.a.COP},cook:!1,callback:(e,s)=>{t.update(e)}}}class _ extends r.a{constructor(t,e){super(t),this.node=t,this._update_options=e,null==this._update_options.define&&(this._update_options.define=!0)}add_hooks(t,e){t.add_post_dirty_hook("TextureController",()=>{this.update()}),e.add_post_dirty_hook("TextureController",()=>{this.update()})}static update(t){}_update(t,e,s,r){return Object(i.a)(this,void 0,void 0,(function*(){if(this._update_options.uniforms){const i=t,n=e;yield this._update_texture_on_uniforms(i,n,s,r)}if(this._update_options.direct_params){const i=t,n=e;yield this._update_texture_on_material(i,n,s,r)}}))}_update_texture_on_uniforms(t,e,s,r){return Object(i.a)(this,void 0,void 0,(function*(){this._update_required_attribute(t,t.uniforms,e,s,r,this._apply_texture_on_uniforms.bind(this),this._remove_texture_from_uniforms.bind(this))}))}_apply_texture_on_uniforms(t,e,s,i){const r=null!=e[s]&&null!=e[s].value;let n=!1;if(r){e[s].value.uuid!=i.uuid&&(n=!0)}if(!r||n){if(e[s].value=i,this._do_update_define()){const e=this._define_name(`${s}`);t.defines[e]=1}t.defines.USE_UV=1,t.needsUpdate=!0}}_remove_texture_from_uniforms(t,e,s){if(e[s].value){if(e[s].value=null,this._do_update_define()){const e=this._define_name(`${s}`);delete t.defines[e]}t.needsUpdate=!0}}_define_name(t){return"USE_"+t.replace("_","").toUpperCase()}_update_texture_on_material(t,e,s,r){return Object(i.a)(this,void 0,void 0,(function*(){this._update_required_attribute(t,t,e,s,r,this._apply_texture_on_material.bind(this),this._remove_texture_from_material.bind(this))}))}_apply_texture_on_material(t,e,s,i){const r=null!=e[s];let n=!1;if(r){e[s].uuid!=i.uuid&&(n=!0)}r&&!n||(e[s]=i,t.needsUpdate=!0)}_remove_texture_from_material(t,e,s){e[s]&&(e[s]=null,t.needsUpdate=!0)}_update_required_attribute(t,e,s,r,o,a,_){return Object(i.a)(this,void 0,void 0,(function*(){if(r.is_dirty&&(yield r.compute()),r.value){o.is_dirty&&(yield o.compute());const i=o.found_node();if(i)if(i.node_context()==n.a.COP){const r=i,n=(yield r.request_container()).texture();if(n)return void a(t,e,s,n);this.node.states.error.set("found node has no texture")}else this.node.states.error.set("found map node is not a COP node");else this.node.states.error.set(`could not find map node ${o.name} with path ${o.value}`)}_(t,e,s)}))}_do_update_define(){return null==this._update_options.define||this._update_options.define}}},390:function(t,e,s){"use strict";s.d(e,"a",(function(){return a})),s.d(e,"b",(function(){return _}));var i=s(354),r=s(339),n=s(330),o=s(44);function a(t){return class extends t{constructor(){super(...arguments),this.transparent=o.b.BOOLEAN(0),this.opacity=o.b.FLOAT(1),this.alpha_test=o.b.FLOAT(0),this.use_fog=o.b.BOOLEAN(0)}}}n.a;a(o.a);r.a;class _ extends i.a{static update(t){const e=t.material,s=t.pv;e.uniforms.opacity&&(e.uniforms.opacity.value=s.opacity),e.transparent=s.transparent||s.opacity<1,e.depthTest=!0,e.alphaTest=s.alpha_test,e.fog=s.use_fog}}},391:function(t,e,s){"use strict";s.d(e,"a",(function(){return o}));var i=s(1),r=s(339),n=s(35);class o extends r.a{constructor(){super(...arguments),this._children_controller_context=n.a.GL}initialize_base_node(){var t;super.initialize_base_node(),this.lifecycle.add_on_create_hook(this.assembler_controller.on_create.bind(this.assembler_controller)),null===(t=this.children_controller)||void 0===t||t.init()}create_material(){return this.assembler_controller.assembler.create_material()}get assembler_controller(){return this._assembler_controller=this._assembler_controller||this._create_assembler_controller()}create_node(t){return super.create_node(t)}children(){return super.children()}nodes_by_type(t){return super.nodes_by_type(t)}compile_if_required(){return Object(i.a)(this,void 0,void 0,(function*(){this.assembler_controller.compile_required()&&this._compile()}))}_compile(){return Object(i.a)(this,void 0,void 0,(function*(){this.material&&(yield this.assembler_controller.assembler.compile_material(this.material),yield this.assembler_controller.post_compile())}))}}},414:function(t,e,s){"use strict";e.a="uniform float mNear;\nuniform float mFar;\n\nvarying float vViewZDepth;\n\nvoid main() {\n\n\tfloat color = 1.0 - smoothstep( mNear, mFar, vViewZDepth );\n\tgl_FragColor = vec4( vec3( color ), 1.0 );\n\n}\n"},435:function(t,e,s){"use strict";s.d(e,"a",(function(){return i}));class i{static filter(t){const e=t.split("\n"),s=[];for(let t of e)t.match(/import {.*} from '.*'/)||(t=t.replace("export ","return "),s.push(t));return s.join("\n")}}},436:function(t,e,s){"use strict";s.d(e,"a",(function(){return u}));var i=s(334),r=s(332),n=s(45),o=s(44),a=s(348);function _(t){return{visible_if:{type:n.e.indexOf(t)}}}class c extends o.a{constructor(){super(...arguments),this.type=o.b.INTEGER(n.e.indexOf(n.c.FLOAT),{menu:{entries:n.e.map((t,e)=>({name:t,value:e}))}}),this.bool=o.b.BOOLEAN(0,_(n.c.BOOL)),this.int=o.b.INTEGER(0,_(n.c.INT)),this.float=o.b.FLOAT(0,_(n.c.FLOAT)),this.vec2=o.b.VECTOR2([0,0],_(n.c.VEC2)),this.vec3=o.b.VECTOR3([0,0,0],_(n.c.VEC3)),this.vec4=o.b.VECTOR4([0,0,0,0],_(n.c.VEC4))}}const l=new c;class u extends i.b{constructor(){super(...arguments),this.params_config=l,this.gl_connections_controller=new a.a(this),this._allow_inputs_created_from_params=!1}static type(){return"constant"}initialize_node(){this.gl_connections_controller.initialize_node(),this.gl_connections_controller.set_output_name_function(t=>u.OUTPUT_NAME),this.gl_connections_controller.set_expected_input_types_function(()=>[]),this.gl_connections_controller.set_expected_output_types_function(()=>[this._current_connection_type])}set_lines(t){const e=this._current_param;if(e){const s=this._current_connection_type,i=r.a.any(e.value),n=`${s} ${this._current_var_name} = ${i}`;t.add_body_lines(this,[n])}else console.warn(`no param found for constant node for type '${this.pv.type}'`)}get _current_connection_type(){null==this.pv.type&&console.warn("constant gl node type if not valid");const t=n.e[this.pv.type];return null==t&&console.warn("constant gl node type if not valid"),t}get _current_param(){this._params_by_type=this._params_by_type||new Map([[n.c.BOOL,this.p.bool],[n.c.INT,this.p.int],[n.c.FLOAT,this.p.float],[n.c.VEC2,this.p.vec2],[n.c.VEC3,this.p.vec3],[n.c.VEC4,this.p.vec4]]);const t=n.e[this.pv.type];return this._params_by_type.get(t)}get _current_var_name(){return this.gl_var_name(u.OUTPUT_NAME)}}u.OUTPUT_NAME="val"},450:function(t,e){},452:function(t,e,s){"use strict";s.d(e,"a",(function(){return D}));var i=s(1),r=s(44),n=s(390),o=s(355),a=s(362),_=s(363),c=s(364),l=s(338),u=s(336),h=s(342),d=s(344),p=s(360),m=s(361),f=s(366),b=s(4),g=s(333);const v=new Map([[g.b.VERTEX,"// INSERT DEFINES"]]),y=new Map([[g.b.VERTEX,"// INSERT BODY"]]);class x extends d.b{get _template_shader(){const t=h.a.depth,e=l.a.clone(t.uniforms);return e.size={value:1},e.scale={value:1},{vertexShader:"uniform float size;\nuniform float scale;\n#include <common>\n#include <clipping_planes_pars_vertex>\nvarying float vViewZDepth;\n\n// INSERT DEFINES\n\n\n\nvoid main() {\n\n\t// INSERT BODY\n\n\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n\tvViewZDepth = - mvPosition.z;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\n}\n\n\n",fragmentShader:t.fragmentShader,uniforms:e}}insert_define_after(t){return v.get(t)}insert_body_after(t){return y.get(t)}create_material(){const t=this._template_shader;return new u.a({defines:{USE_SIZEATTENUATION:1,DEPTH_PACKING:[b.Cb,b.i][0]},uniforms:l.a.clone(t.uniforms),vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})}}const E=new Map([[g.b.VERTEX,"// INSERT DEFINES"]]),T=new Map([[g.b.VERTEX,"// INSERT BODY"]]);class w extends d.b{get _template_shader(){const t=h.a.distanceRGBA,e=l.a.clone(t.uniforms);return e.size={value:1},e.scale={value:1},{vertexShader:"uniform float size;\nuniform float scale;\n#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <clipping_planes_pars_vertex>\nvarying float vViewZDepth;\n\n// INSERT DEFINES\n\n\n\nvoid main() {\n\n\t// INSERT BODY\n\n\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\tvWorldPosition = worldPosition.xyz;\n}\n\n// #define DISTANCE\n// varying vec3 vWorldPosition;\n// #include <common>\n// #include <uv_pars_vertex>\n// #include <displacementmap_pars_vertex>\n// #include <morphtarget_pars_vertex>\n// #include <skinning_pars_vertex>\n// #include <clipping_planes_pars_vertex>\n// void main() {\n// \t#include <uv_vertex>\n// \t#include <skinbase_vertex>\n// \t#ifdef USE_DISPLACEMENTMAP\n// \t\t#include <beginnormal_vertex>\n// \t\t#include <morphnormal_vertex>\n// \t\t#include <skinnormal_vertex>\n// \t#endif\n// \t#include <begin_vertex>\n// \t#include <morphtarget_vertex>\n// \t#include <skinning_vertex>\n// \t#include <displacementmap_vertex>\n// \t#include <project_vertex>\n// \t#include <worldpos_vertex>\n// \t#include <clipping_planes_vertex>\n// \tvWorldPosition = worldPosition.xyz;\n// }\n\n\n",fragmentShader:t.fragmentShader,uniforms:e}}insert_define_after(t){return E.get(t)}insert_body_after(t){return T.get(t)}create_material(){const t=this._template_shader;return new u.a({defines:{USE_SIZEATTENUATION:1,DEPTH_PACKING:[b.Cb,b.i][0]},uniforms:l.a.clone(t.uniforms),vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})}}var O=s(414);const A=new Map([[g.b.VERTEX,"// INSERT DEFINES"]]),R=new Map([[g.b.VERTEX,"// INSERT BODY"]]);class N extends d.b{get _template_shader(){return{vertexShader:"uniform float size;\nuniform float scale;\n#include <common>\n\nvarying float vViewZDepth;\n\n// INSERT DEFINES\n\n\n\nvoid main() {\n\n\t// INSERT BODY\n\n\n\t#include <project_vertex>\n\n\tvViewZDepth = - mvPosition.z;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\n}\n\n",fragmentShader:O.a,uniforms:{size:{value:1},scale:{value:1},mNear:{value:0},mFar:{value:10}}}}insert_define_after(t){return A.get(t)}insert_body_after(t){return R.get(t)}create_material(){const t=this._template_shader;return new u.a({depthTest:!0,defines:{USE_SIZEATTENUATION:1},uniforms:l.a.clone(t.uniforms),vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})}}var j=s(0),I=s(118),S=s(45);const M=new Map([[g.b.VERTEX,["#include <begin_vertex>","gl_PointSize = size;"]],[g.b.FRAGMENT,[]]]),k=new Map;k.set(d.a.DISTANCE,w),k.set(d.a.DEPTH,x),k.set(d.a.DEPTH_DOF,N);class z extends d.b{custom_assembler_class_by_custom_name(){return k}get _template_shader(){const t=h.a.points;return{vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms}}create_material(){const t=this._template_shader,e=new u.a({transparent:!0,fog:!0,defines:{USE_SIZEATTENUATION:1},uniforms:l.a.clone(t.uniforms),vertexShader:t.vertexShader,fragmentShader:t.fragmentShader});return this._add_custom_materials(e),e}add_output_params(t){f.a.add_output_params(t),t.add_param(j.a.FLOAT,"gl_PointSize",1)}create_globals_node_output_connections(){return f.a.create_globals_node_output_connections().concat([new I.a("gl_PointCoord",S.c.VEC2)])}create_shader_configs(){return[new p.a(g.b.VERTEX,["position","normal","uv","gl_PointSize"],[]),new p.a(g.b.FRAGMENT,["color","alpha"],[g.b.VERTEX])]}create_variable_configs(){return f.a.create_variable_configs().concat([new m.a("gl_PointSize",{default:"1.0",prefix:"gl_PointSize = ",suffix:" * size * 10.0"})])}lines_to_remove(t){return M.get(t)}}var C=s(391),L=s(365);class P extends(Object(c.b)(Object(_.b)(Object(a.b)(Object(o.b)(Object(n.a)(r.a)))))){}const F=new P;class D extends C.a{constructor(){super(...arguments),this.params_config=F}static type(){return"points_builder"}initialize_node(){}_create_assembler_controller(){return new L.a(this,z)}cook(){return Object(i.a)(this,void 0,void 0,(function*(){yield this.compile_if_required(),n.b.update(this),o.a.update(this),a.a.update(this),this.set_material(this.material)}))}}},615:function(t,e,s){"use strict";s.r(e),s.d(e,"SopRegister",(function(){return jo}));var i,r=s(352),n=s(417),o=s.n(n),a=s(329),_=s(328),c=s(121),l=s.n(c),u=s(58),h=s(467),d=s(126),p=s(407),m=s(25),f=s(340),b=s(375),g=s(120),v=s(4),y=s(24),x=s(468),E=s(374),T=s(380),w=s(392),O=s(356);!function(t){t.MESH="MESH",t.POINTS="POINTS",t.LINE_SEGMENTS="LINE_SEGMENTS"}(i||(i={}));const A=[i.MESH,i.POINTS,i.LINE_SEGMENTS],R=[{name:"Mesh",value:A.indexOf(i.MESH)},{name:"Points",value:A.indexOf(i.POINTS)},{name:"LineSegments",value:A.indexOf(i.LINE_SEGMENTS)}];const N={MeshStandard:new T.a({color:16777215,side:v.E,metalness:.5,roughness:.9}),[i.MESH]:new w.a({color:new y.a(.5,.5,1),side:v.E,vertexColors:!1,transparent:!0,depthTest:!0}),[i.POINTS]:new E.a({color:16777215,size:.1,depthTest:!0}),[i.LINE_SEGMENTS]:new O.a({color:16777215,linewidth:1})};var j;!function(t){t[t.VERTEX=0]="VERTEX",t[t.OBJECT=1]="OBJECT"}(j||(j={}));const I=[{name:"vertex",value:j.VERTEX},{name:"object",value:j.OBJECT}];var S;!function(t){t[t.NUMERIC=0]="NUMERIC",t[t.STRING=1]="STRING"}(S||(S={}));const M=[{name:"numeric",value:S.NUMERIC},{name:"string",value:S.STRING}],k={ATTRIB_CLASS:{VERTEX:j.VERTEX,OBJECT:j.OBJECT},ATTRIB_TYPE:{NUMERIC:0,STRING:1},OBJECT_TYPE:{MESH:i.MESH,POINTS:i.POINTS,LINE_SEGMENTS:i.LINE_SEGMENTS},OBJECT_TYPES:A,CONSTRUCTOR_NAMES_BY_CONSTRUCTOR_NAME:{[d.a.name]:"Scene",[g.a.name]:"Group",[m.a.name]:"Object3D",[f.a.name]:"Mesh",[p.a.name]:"Points",[b.a.name]:"LineSegments",[x.a.name]:"Bone",[h.a.name]:"SkinnedMesh"},CONSTRUCTORS_BY_NAME:{[i.MESH]:f.a,[i.POINTS]:p.a,[i.LINE_SEGMENTS]:b.a},MATERIALS:N};var z=s(30),C=s.n(z),L=s(27),P=s.n(L),F=s(134),D=s.n(F),B=s(129),V=s.n(B),G=s(47),U=s.n(G),$=s(416),q=s.n($),Y=s(2),H=s(377),X=s(12),J=s(408),K=s(91),W=s.n(K),Z=s(469),Q=s.n(Z),tt=s(54),et=s.n(tt),st=s(65),it=s.n(st),rt=s(3),nt=s.n(rt),ot=s(9),at=s.n(ot),_t=s(36),ct=s(127);class lt{constructor(t){this._index=t}get index(){return this._index}}const ut="position",ht="normal";var dt;!function(t){t.x="x",t.y="y",t.z="z",t.w="w",t.r="r",t.g="g",t.b="b"}(dt||(dt={}));const pt={x:0,y:1,z:2,w:3,r:0,g:1,b:2};class mt extends lt{constructor(t,e){super(e),this._core_geometry=t,this._geometry=this._core_geometry.geometry()}geometry_wrapper(){return this._core_geometry}geometry(){return this._geometry=this._geometry||this._core_geometry.geometry()}attrib_size(t){return t=ct.a.remap_name(t),this._geometry.getAttribute(t).itemSize}has_attrib(t){const e=ct.a.remap_name(t);return this._core_geometry.has_attrib(e)}attrib_value(t){if("ptnum"===t)return this.index;{let e=null,s=null;"."===t[t.length-2]&&(e=t[t.length-1],s=pt[e],t=t.substring(0,t.length-2));const i=ct.a.remap_name(t),r=this._geometry.getAttribute(i);if(!r){const e=`attrib ${t} not found. availables are: ${Object.keys(this._geometry.attributes||{}).join(",")}`;throw console.warn(e),e}{const{array:t}=r;if(this._core_geometry.is_attrib_indexed(i)){const t=this.attrib_value_index(i);return this._core_geometry.user_data_attrib(i)[t]}{const e=r.itemSize,i=this._index*e;if(null==s)switch(e){case 1:return t[i];case 2:return new X.a(t[i+0],t[i+1]);case 3:return new Y.a(t[i+0],t[i+1],t[i+2]);case 4:return new _t.a(t[i+0],t[i+1],t[i+2],t[i+3]);default:throw`size not valid (${e})`}else switch(e){case 1:return t[i];default:return t[i+s]}}}}}attrib_value_index(t){return this._core_geometry.is_attrib_indexed(t)?this._geometry.getAttribute(t).array[this._index]:-1}position(){const{array:t}=this._geometry.getAttribute(ut);return this._position=this._position||new Y.a,this._position.fromArray(t,3*this._index)}set_position(t){this.set_attrib_value_vector3(ut,t)}normal(){const{array:t}=this._geometry.getAttribute(ht);return this._normal=this._normal||new Y.a,this._normal.fromArray(t,3*this._index)}set_normal(t){return this.set_attrib_value_vector3(ht,t)}set_attrib_value(t,e){if(null==e)return;if(null==t)throw"Point.set_attrib_value requires a name";const s=this._geometry.getAttribute(t),i=s.array,r=s.itemSize;switch(r){case 1:i[this._index]=e;break;case 2:const t=e;i[2*this._index+0]=t.x,i[2*this._index+1]=t.y;break;case 3:if(null!=e.r){const t=e;i[3*this._index+0]=t.r,i[3*this._index+1]=t.g,i[3*this._index+2]=t.b}else{const t=e;i[3*this._index+0]=t.x,i[3*this._index+1]=t.y,i[3*this._index+2]=t.z}break;default:throw console.warn(`Point.set_attrib_value does not yet allow attrib size ${r}`),`attrib size ${r} not implemented`}}set_attrib_value_vector3(t,e){if(null==e)return;if(null==t)throw"Point.set_attrib_value requires a name";const s=this._geometry.getAttribute(t).array,i=3*this._index;s[i]=e.x,s[i+1]=e.y,s[i+2]=e.z}set_attrib_index(t,e){return this._geometry.getAttribute(t).array[this._index]=e}}var ft=s(138),bt=s(125);class gt{constructor(t,e){this._core_geometry=t,this._index=e,this._geometry=this._core_geometry.geometry()}get index(){return this._index}get points(){return this._points=this._points||this._get_points()}_get_points(){var t;const e=(null===(t=this._geometry.index)||void 0===t?void 0:t.array)||[],s=3*this._index;return[new mt(this._core_geometry,e[s+0]),new mt(this._core_geometry,e[s+1]),new mt(this._core_geometry,e[s+2])]}get positions(){return this._positions=this._positions||this._get_positions()}_get_positions(){const t=this.points;return[t[0].position(),t[1].position(),t[2].position()]}get triangle(){return this._triangle=this._triangle||this._get_triangle()}_get_triangle(){const t=this.positions;return new ft.a(t[0],t[1],t[2])}get deltas(){return this._deltas=this._deltas||this._get_deltas()}_get_deltas(){return[this.positions[1].clone().sub(this.positions[0]),this.positions[2].clone().sub(this.positions[0])]}get area(){return this.triangle.getArea()}center(t){const e=this.positions;return t.x=(e[0].x+e[1].x+e[2].x)/3,t.y=(e[0].y+e[1].y+e[2].y)/3,t.z=(e[0].z+e[1].z+e[2].z)/3,t}random_position(t){let e=[bt.a.rand_float(t),bt.a.rand_float(6541*t)];return e[0]+e[1]>1&&(e[0]=1-e[0],e[1]=1-e[1]),this.positions[0].clone().add(this.deltas[0].clone().multiplyScalar(e[0])).add(this.deltas[1].clone().multiplyScalar(e[1]))}attrib_value_at_position(t,e){const s=new Y.a;this.triangle.getBarycoord(e,s);const i=s.toArray(),r=this._geometry.attributes[t].itemSize,n=this.points.map(e=>e.attrib_value(t));let o,a,_=0;switch(r){case 1:a=0;for(let t of n)a+=t*i[_],_++;o=a;break;default:for(let t of n){const e=t.multiplyScalar(i[_]);a?a.add(e):a=e,_++}o=a}return o}static interpolated_value(t,e,s,i){const r=[e.a,e.b,e.c],n=t.getAttribute("position").array,o=r.map(t=>new Y.a(n[3*t+0],n[3*t+1],n[3*t+2])),a=i.itemSize,_=i.array;let c=[];switch(a){case 1:c=r.map(t=>_[t]);break;case 2:c=r.map(t=>new X.a(_[2*t+0],_[2*t+1]));break;case 3:c=r.map(t=>new Y.a(_[3*t+0],_[3*t+1],_[3*t+2]))}const l=r.map((t,e)=>s.distanceTo(o[e])),u=q()([l[0]*l[1],l[0]*l[2],l[1]*l[2]]),h=[l[1]*l[2]/u,l[0]*l[2]/u,l[0]*l[1]/u];let d;switch(a){case 1:d=q()(r.map((t,e)=>h[e]*c[e]));break;default:var p=r.map((t,e)=>c[e].multiplyScalar(h[e]));d=null;for(let t of p)d?d.add(t):d=t}return d}}class vt{static patch(t){Object.assign(t,{clone:function(){return new J.a(t.data.clone(),t.itemSize,t.offset,t.normalized)}})}}var yt,xt=s(438),Et={computeTangents:function(t){var e=t.index,s=t.attributes;if(null!==e&&void 0!==s.position&&void 0!==s.normal&&void 0!==s.uv){var i=e.array,r=s.position.array,n=s.normal.array,o=s.uv.array,a=r.length/3;void 0===s.tangent&&t.setAttribute("tangent",new _.a(new Float32Array(4*a),4));for(var c=s.tangent.array,l=[],u=[],h=0;h<a;h++)l[h]=new Y.a,u[h]=new Y.a;var d=new Y.a,p=new Y.a,m=new Y.a,f=new X.a,b=new X.a,g=new X.a,v=new Y.a,y=new Y.a,x=t.groups;0===x.length&&(x=[{start:0,count:i.length}]);h=0;for(var E=x.length;h<E;++h)for(var T=k=(M=x[h]).start,w=k+M.count;T<w;T+=3)z(i[T+0],i[T+1],i[T+2]);var O,A,R,N=new Y.a,j=new Y.a,I=new Y.a,S=new Y.a;for(h=0,E=x.length;h<E;++h){var M,k;for(T=k=(M=x[h]).start,w=k+M.count;T<w;T+=3)C(i[T+0]),C(i[T+1]),C(i[T+2])}}else console.warn("THREE.BufferGeometry: Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");function z(t,e,s){d.fromArray(r,3*t),p.fromArray(r,3*e),m.fromArray(r,3*s),f.fromArray(o,2*t),b.fromArray(o,2*e),g.fromArray(o,2*s),p.sub(d),m.sub(d),b.sub(f),g.sub(f);var i=1/(b.x*g.y-g.x*b.y);isFinite(i)&&(v.copy(p).multiplyScalar(g.y).addScaledVector(m,-b.y).multiplyScalar(i),y.copy(m).multiplyScalar(b.x).addScaledVector(p,-g.x).multiplyScalar(i),l[t].add(v),l[e].add(v),l[s].add(v),u[t].add(y),u[e].add(y),u[s].add(y))}function C(t){I.fromArray(n,3*t),S.copy(I),A=l[t],N.copy(A),N.sub(I.multiplyScalar(I.dot(A))).normalize(),j.crossVectors(S,A),R=j.dot(u[t]),O=R<0?-1:1,c[4*t]=N.x,c[4*t+1]=N.y,c[4*t+2]=N.z,c[4*t+3]=O}},mergeBufferGeometries:function(t,e){for(var s=null!==t[0].index,i=new Set(Object.keys(t[0].attributes)),r=new Set(Object.keys(t[0].morphAttributes)),n={},o={},_=t[0].morphTargetsRelative,c=new a.a,l=0,u=0;u<t.length;++u){var h=t[u];if(s!==(null!==h.index))return null;for(var d in h.attributes){if(!i.has(d))return null;void 0===n[d]&&(n[d]=[]),n[d].push(h.attributes[d])}if(_!==h.morphTargetsRelative)return null;for(var d in h.morphAttributes){if(!r.has(d))return null;void 0===o[d]&&(o[d]=[]),o[d].push(h.morphAttributes[d])}if(c.userData.mergedUserData=c.userData.mergedUserData||[],c.userData.mergedUserData.push(h.userData),e){var p;if(s)p=h.index.count;else{if(void 0===h.attributes.position)return null;p=h.attributes.position.count}c.addGroup(l,p,u),l+=p}}if(s){var m=0,f=[];for(u=0;u<t.length;++u){for(var b=t[u].index,g=0;g<b.count;++g)f.push(b.getX(g)+m);m+=t[u].attributes.position.count}c.setIndex(f)}for(var d in n){var v=this.mergeBufferAttributes(n[d]);if(!v)return null;c.setAttribute(d,v)}for(var d in o){var y=o[d][0].length;if(0===y)break;c.morphAttributes=c.morphAttributes||{},c.morphAttributes[d]=[];for(u=0;u<y;++u){var x=[];for(g=0;g<o[d].length;++g)x.push(o[d][g][u]);var E=this.mergeBufferAttributes(x);if(!E)return null;c.morphAttributes[d].push(E)}}return c},mergeBufferAttributes:function(t){for(var e,s,i,r=0,n=0;n<t.length;++n){var o=t[n];if(o.isInterleavedBufferAttribute)return null;if(void 0===e&&(e=o.array.constructor),e!==o.array.constructor)return null;if(void 0===s&&(s=o.itemSize),s!==o.itemSize)return null;if(void 0===i&&(i=o.normalized),i!==o.normalized)return null;r+=o.array.length}var a=new e(r),c=0;for(n=0;n<t.length;++n)a.set(t[n].array,c),c+=t[n].array.length;return new _.a(a,s,i)},interleaveAttributes:function(t){for(var e,s=0,i=0,r=0,n=t.length;r<n;++r){var o=t[r];if(void 0===e&&(e=o.array.constructor),e!==o.array.constructor)return console.warn("AttributeBuffers of different types cannot be interleaved"),null;s+=o.array.length,i+=o.itemSize}var a=new xt.a(new e(s),i),_=0,c=[],l=["getX","getY","getZ","getW"],u=["setX","setY","setZ","setW"],h=0;for(n=t.length;h<n;h++){var d=(o=t[h]).itemSize,p=o.count,m=new J.a(a,d,_,o.normalized);c.push(m),_+=d;for(var f=0;f<p;f++)for(var b=0;b<d;b++)m[u[b]](f,o[l[b]](f))}return c},estimateBytesUsed:function(t){var e=0;for(var s in t.attributes){var i=t.getAttribute(s);e+=i.count*i.itemSize*i.array.BYTES_PER_ELEMENT}var r=t.getIndex();return e+=r?r.count*r.itemSize*r.array.BYTES_PER_ELEMENT:0},mergeVertices:function(t,e=1e-4){e=Math.max(e,Number.EPSILON);for(var s={},i=t.getIndex(),r=t.getAttribute("position"),n=i?i.count:r.count,o=0,a=Object.keys(t.attributes),c={},l={},u=[],h=["getX","getY","getZ","getW"],d=0,p=a.length;d<p;d++){c[y=a[d]]=[],(w=t.morphAttributes[y])&&(l[y]=new Array(w.length).fill().map(()=>[]))}var m=Math.log10(1/e),f=Math.pow(10,m);for(d=0;d<n;d++){var b=i?i.getX(d):d,g="",v=0;for(p=a.length;v<p;v++)for(var y=a[v],x=(T=t.getAttribute(y)).itemSize,E=0;E<x;E++)g+=`${~~(T[h[E]](b)*f)},`;if(g in s)u.push(s[g]);else{for(v=0,p=a.length;v<p;v++){y=a[v];var T=t.getAttribute(y),w=t.morphAttributes[y],O=(x=T.itemSize,c[y]),A=l[y];for(E=0;E<x;E++){var R=h[E];if(O.push(T[R](b)),w)for(var N=0,j=w.length;N<j;N++)A[N].push(w[N][R](b))}}s[g]=o,u.push(o),o++}}const I=t.clone();for(d=0,p=a.length;d<p;d++){y=a[d];var S=t.getAttribute(y),M=new S.array.constructor(c[y]);T=new _.a(M,S.itemSize,S.normalized);if(I.setAttribute(y,T),y in l)for(v=0;v<l[y].length;v++){var k=t.morphAttributes[y][v],z=(M=new k.array.constructor(l[y][v]),new _.a(M,k.itemSize,k.normalized));I.morphAttributes[y][v]=z}}return I.setIndex(u),I},toTrianglesDrawMode:function(t,e){if(e===v.Tc)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),t;if(e===v.Rc||e===v.Sc){var s=t.getIndex();if(null===s){var i=[],r=t.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),t;for(var n=0;n<r.count;n++)i.push(n);t.setIndex(i),s=t.getIndex()}var o=s.count-2,a=[];if(e===v.Rc)for(n=1;n<=o;n++)a.push(s.getX(0)),a.push(s.getX(n)),a.push(s.getX(n+1));else for(n=0;n<o;n++)n%2==0?(a.push(s.getX(n)),a.push(s.getX(n+1)),a.push(s.getX(n+2))):(a.push(s.getX(n+2)),a.push(s.getX(n+1)),a.push(s.getX(n)));a.length/3!==o&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var _=t.clone();return _.setIndex(a),_.clearGroups(),_}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),t}};class Tt{constructor(t){this._geometry=t}geometry(){return this._geometry}uuid(){return this._geometry.uuid}bounding_box(){return this._bounding_box=this._bounding_box||this._create_bounding_box()}_create_bounding_box(){if(this._geometry.computeBoundingBox(),this._geometry.boundingBox)return this._geometry.boundingBox}mark_as_instance(){this._geometry.userData.is_instance=!0}static marked_as_instance(t){return!0===t.userData.is_instance}marked_as_instance(){return Tt.marked_as_instance(this._geometry)}position_attrib_name(){let t="position";return this.marked_as_instance()&&(t="instancePosition"),t}compute_vertex_normals(){this._geometry.computeVertexNormals()}user_data_attribs(){const t="indexed_attrib_values";return this._geometry.userData[t]=this._geometry.userData[t]||{}}indexed_attribute_names(){return Object.keys(this.user_data_attribs()||{})}user_data_attrib(t){return t=ct.a.remap_name(t),this.user_data_attribs()[t]}is_attrib_indexed(t){return t=ct.a.remap_name(t),null!=this.user_data_attrib(t)}has_attrib(t){return"ptnum"===t||(t=ct.a.remap_name(t),null!=this._geometry.attributes[t])}attrib_type(t){return this.is_attrib_indexed(t)?k.ATTRIB_TYPE.STRING:k.ATTRIB_TYPE.NUMERIC}attrib_names(){return Object.keys(this._geometry.attributes)}attrib_sizes(){const t={};for(let e of this.attrib_names())t[e]=this._geometry.attributes[e].itemSize;return t}attrib_size(t){let e;return t=ct.a.remap_name(t),null!=(e=this._geometry.attributes[t])?e.itemSize:"ptnum"===t?1:0}set_indexed_attribute_values(t,e){this.user_data_attribs()[t]=e}set_indexed_attribute(t,e,s){this.set_indexed_attribute_values(t,e),this._geometry.setAttribute(t,new _.c(s,1))}add_numeric_attrib(t,e=1,s=0){const i=[];let r=!1;if(at()(s)){for(let t=0;t<this.points_count();t++)for(let t=0;t<e;t++)i.push(s);r=!0}else if(e>1)if(nt()(s)){for(let t=0;t<this.points_count();t++)for(let t=0;t<e;t++)i.push(s[t]);r=!0}else{const t=s;if(2==e&&null!=t.x&&null!=t.y){for(let e=0;e<this.points_count();e++)i.push(t.x),i.push(t.y);r=!0}const n=s;if(3==e&&null!=n.x&&null!=n.y&&null!=n.z){for(let t=0;t<this.points_count();t++)i.push(n.x),i.push(n.y),i.push(n.z);r=!0}const o=s;if(3==e&&null!=o.r&&null!=o.g&&null!=o.b){for(let t=0;t<this.points_count();t++)i.push(o.r),i.push(o.g),i.push(o.b);r=!0}const a=s;if(4==e&&null!=a.x&&null!=a.y&&null!=a.z&&null!=a.w){for(let t=0;t<this.points_count();t++)i.push(a.x),i.push(a.y),i.push(a.z),i.push(a.w);r=!0}}if(!r)throw"no other default value allowed for now in add_numeric_attrib";this._geometry.setAttribute(t,new _.b(i,e))}init_position_attribute(t,e){const s=[];null==e&&(e=new Y.a);for(let i=0;i<t;i++)s.push(e.x),s.push(e.y),s.push(e.z);return this._geometry.setAttribute("position",new _.b(s,3))}add_attribute(t,e){switch(e.type()){case k.ATTRIB_TYPE.STRING:return console.log("TODO: to implement");case k.ATTRIB_TYPE.NUMERIC:return this.add_numeric_attrib(t,e.size())}}rename_attribute(t,e){this.is_attrib_indexed(t)&&(this.user_data_attribs()[e]=it()(this.user_data_attribs()[t]),delete this.user_data_attribs()[t]);const s=this._geometry.getAttribute(t);return this._geometry.setAttribute(e,new _.b(s.array,s.itemSize)),this._geometry.deleteAttribute(t)}delete_attribute(t){return this.is_attrib_indexed(t)&&delete this.user_data_attribs()[t],this._geometry.deleteAttribute(t)}clone(){return Tt.clone(this._geometry)}static clone(t){let e;for(let e of Object.keys(t.attributes)){const s=t.getAttribute(e);s.constructor.name==J.a.name&&vt.patch(s)}const s=t.clone();return null!=(e=t.userData)&&(s.userData=et()(e)),s}points_count(){return Tt.points_count(this._geometry)}static points_count(t){let e,s=0;let i="position";if(new this(t).marked_as_instance()&&(i="instancePosition"),null!=(e=t.getAttribute(i))){let t;null!=(t=e.array)&&(s=t.length/3)}return s}points(){return this._points=this._points||this.points_from_geometry()}reset_points(){this._points=void 0}points_from_geometry(){const t=[],e=this._geometry.getAttribute(this.position_attrib_name());if(null!=e){const s=e.array.length/3;for(let e=0;e<s;e++){const s=new mt(this,e);t.push(s)}}return t}static geometry_from_points(t,e){const s=new a.a,i=new this(s),r=t[0];if(null!=r){const n=r.geometry(),o=r.geometry_wrapper(),a={};W()(t,(t,e)=>a[t.index]=e);const c=this._indices_from_points(a,n,e);null!=c&&0!==c.length&&s.setIndex(c);const{attributes:l}=n;for(let e of Object.keys(l)){if(null!=o.user_data_attribs()[e]){const r=C()(t.map(t=>t.attrib_value(e))),n={};W()(r,(t,e)=>n[t]=e),i.user_data_attribs()[e]=r;const o=[];for(let s of t){const t=n[s.attrib_value(e)];o.push(t)}s.setAttribute(e,new _.b(o,1))}else{const i=[],r=l[e].itemSize;for(let s of t){const t=s.attrib_value(e);switch(r){case 1:i.push(t);case 3:i.push(t.x),i.push(t.y),i.push(t.z)}}s.setAttribute(e,new _.b(i,r))}}}return s}static _indices_from_points(t,e,s){const i=e.index;if(null!=i){const e=i.array,r=[];switch(s){case k.OBJECT_TYPE.POINTS:W()(e,(function(e,s){const i=t[e];null!=i&&r.push(i)}));break;case k.OBJECT_TYPE.MESH:W()(e,(function(s,i){if(i%3==0){const s=e[i],n=e[i+1],o=e[i+2],a=t[s],_=t[n],c=t[o];null!=a&&null!=_&&null!=c&&(r.push(a),r.push(_),r.push(c))}}));break;case k.OBJECT_TYPE.LINE_SEGMENTS:W()(e,(function(s,i){if(i%2==0){const s=e[i],n=e[i+1],o=t[s],a=t[n];null!=o&&null!=a&&(r.push(o),r.push(a))}}))}return r}}static merge_geometries(t){if(0===t.length)return;const e=t.map(t=>new Tt(t)),s=e[0].indexed_attribute_names(),i={};for(let t of s){const s={},r=[];for(let i of e){const e=i.points();for(let i of e){r.push(i);const e=i.attrib_value(t);null!=s[e]?s[e]:s[e]=Object.keys(s).length}}const n=Object.keys(s);for(let e of r){const i=s[e.attrib_value(t)];e.set_attrib_index(t,i)}i[t]=n}const r=Et.mergeBufferGeometries(t),n=new this(r);return Object.keys(i).forEach(t=>{const e=i[t];n.set_indexed_attribute_values(t,e)}),r&&delete r.userData.mergedUserData,r}segments(){var t;const e=(null===(t=this.geometry().index)||void 0===t?void 0:t.array)||[];return Q()(e,2)}faces(){return this.faces_from_geometry()}faces_from_geometry(){var t;const e=((null===(t=this.geometry().index)||void 0===t?void 0:t.array)||[]).length/3;return l()(e).map(t=>new gt(this,t))}}!function(t){t.customDistanceMaterial="customDistanceMaterial",t.customDepthMaterial="customDepthMaterial",t.customDepthDOFMaterial="customDepthDOFMaterial"}(yt||(yt={}));class wt{static node(t,e){return t.node(e.name)}static clone(t){return nt()(t)?t.map(t=>this.clone_single(t)):this.clone_single(t)}static clone_single(t){const e=t.clone();return e.linewidth=t.linewidth,e}static apply_custom_materials(t,e){const s=e;if(s.custom_materials)for(let e of Object.keys(s.custom_materials)){const i=e,r=s.custom_materials[i];r&&(t[i]=r,r.needsUpdate=!0)}}static assign_custom_uniforms(t,e,s){const i=t;if(i.custom_materials)for(let t of Object.keys(i.custom_materials)){const r=t,n=i.custom_materials[r];n&&(n.uniforms[e].value=s)}}static init_custom_material_uniforms(t,e,s){const i=t;if(i.custom_materials)for(let t of Object.keys(i.custom_materials)){const r=t,n=i.custom_materials[r];n&&(n.uniforms[e]=n.uniforms[e]||s)}}}var Ot=s(15),At=s(5),Rt=s.n(At);class Nt extends lt{constructor(t,e){super(e),this._object=t,null==this._object.userData.attributes&&(this._object.userData.attributes={})}object(){return this._object}geometry(){return this._object.geometry}core_geometry(){const t=this.geometry();return t?new Tt(t):null}points(){var t;return(null===(t=this.core_geometry())||void 0===t?void 0:t.points())||[]}points_from_group(t){if(t){const e=Ot.a.indices(t);if(e){const t=this.points();return e.map(e=>t[e])}return[]}return this.points()}compute_vertex_normals(){var t;null===(t=this.core_geometry())||void 0===t||t.compute_vertex_normals()}add_attribute(t,e){let s;s=at()(e)||nt()(e)||Rt()(e)?e:e.toArray(),this._object.userData.attributes[t]=s}add_numeric_attrib(t,e){this.add_attribute(t,e)}set_attrib_value(t,e){this.add_attribute(t,e)}add_numeric_vertex_attrib(t,e,s){var i;null==s&&(s=ct.a.default_value(e)),null===(i=this.core_geometry())||void 0===i||i.add_numeric_attrib(t,e,s)}attribute_names(){return Object.keys(this._object.userData.attributes)}attrib_names(){return this.attribute_names()}has_attrib(t){return this.attribute_names().includes(t)}rename_attribute(t,e){this.add_attribute(e,this.attrib_value(t)),this.delete_attribute(t)}delete_attribute(t){delete this._object.userData.attributes[t]}attrib_value(t){if("ptnum"===t)return this.index;{let e=this._object.userData.attributes[t];return null==e&&"name"==t&&(e=this._object.name),e}}name(){return this.attrib_value("name")}human_type(){return k.CONSTRUCTOR_NAMES_BY_CONSTRUCTOR_NAME[this._object.constructor.name]}attrib_type(t){const e=this.attrib_value(t);return Rt()(e)?k.ATTRIB_TYPE.STRING:k.ATTRIB_TYPE.NUMERIC}attrib_size(t){const e=this.attrib_value(t);if(null==e)return 0;if(Rt()(e)||at()(e))return 1;switch(e.constructor){case X.a:return 2;case Y.a:return 3;default:return 0}}clone(){return Nt.clone(this._object)}static clone(t){const e=t.clone();var s=new Map,i=new Map;return Nt.parallelTraverse(t,e,(function(t,e){s.set(e,t),i.set(t,e)})),e.traverse((function(e){const r=s.get(e),n=e;if(n.geometry){const t=r.geometry;n.geometry=Tt.clone(t);const e=n.geometry;e.userData&&(e.userData=et()(t.userData))}if(n.material){n.material=r.material,wt.apply_custom_materials(e,n.material);const t=n.material;null==t.color&&(t.color=new y.a(1,1,1))}t.userData&&(e.userData=et()(r.userData));const o=r;o.animations&&(e.animations=o.animations.map(t=>t.clone()));const a=e;if(a.isSkinnedMesh){var _=a,c=r,l=c.skeleton.bones;_.skeleton=c.skeleton.clone(),_.bindMatrix.copy(c.bindMatrix);const t=l.map((function(t){return i.get(t)}));_.skeleton.bones=t,_.bind(_.skeleton,_.bindMatrix)}})),e}static parallelTraverse(t,e,s){s(t,e);for(var i=0;i<t.children.length;i++)this.parallelTraverse(t.children[i],e.children[i],s)}}class jt{constructor(){this.touch()}timestamp(){return this._timestamp}touch(){this._timestamp=performance.now(),this.reset()}reset(){this._bounding_box=void 0,this._core_geometries=void 0,this._core_objects=void 0}clone(){const t=new jt;if(this._objects){const e=[];for(let t of this._objects)e.push(Nt.clone(t));t.set_objects(e)}return t}set_objects(t){this._objects=t,this.touch()}objects(){return this._objects}core_objects(){return this._core_objects=this._core_objects||this._create_core_objects()}_create_core_objects(){const t=[];if(this._objects)for(let e=0;e<this._objects.length;e++)this._objects[e].traverse(s=>{const i=new Nt(s,e);t.push(i)});return t}geometries(){const t=[];for(let e of this.core_objects()){const s=e.object().geometry;s&&t.push(s)}return t}core_geometries(){return this._core_geometries=this._core_geometries||this.create_core_geometries()}create_core_geometries(){const t=[];for(let e of this.geometries())t.push(new Tt(e));return t}__geometry_from_object(t,e){if(e.geometry)return t.push(e.geometry)}static geometry_from_object(t){return t.isMesh||t.isLine||t.isPoints?t.geometry:null}faces(){return U()(this.core_geometries().map(t=>t.faces()))}points(){return U()(this.core_geometries().map(t=>t.points()))}points_count(){return q()(this.core_geometries().map(t=>t.points_count()))}points_from_group(t){if(t){const e=Ot.a.indices(t),s=this.points();return P()(e.map(t=>s[t]))}return this.points()}static from_objects(t){const e=new jt;return e.set_objects(t),e}objects_from_group(t){return this.core_objects_from_group(t).map(t=>t.object())}core_objects_from_group(t){if(""!==(t=V()(t))){const e=parseInt(t);return D()(e)?this.core_objects().filter(e=>Ot.a.match_mask(t,e.name())):P()([this.core_objects()[e]])}return this.core_objects()}bounding_box(){return this._bounding_box=this._bounding_box||this._compute_bounding_box()}center(){const t=new Y.a;return this.bounding_box().getCenter(t),t}size(){const t=new Y.a;return this.bounding_box().getSize(t),t}_compute_bounding_box(){let t;if(this._objects)for(let e of this._objects){const s=e.geometry;s&&(s.computeBoundingBox(),t?t.expandByObject(e):s.boundingBox&&(t=s.boundingBox.clone()))}return t=t||new H.a(new Y.a(-1,-1,-1),new Y.a(1,1,1)),t}compute_vertex_normals(){for(let t of this.core_objects())t.compute_vertex_normals()}has_attrib(t){let e;return null!=(e=this.core_geometries()[0])&&e.has_attrib(t)}attrib_type(t){const e=this.core_geometries()[0];return null!=e?e.attrib_type(t):null}rename_attrib(t,e,s){switch(s){case k.ATTRIB_CLASS.VERTEX:if(this.has_attrib(t)&&this._objects)for(let s of this._objects)s.traverse(s=>{const i=jt.geometry_from_object(s);if(i){new Tt(i).rename_attribute(t,e)}});break;case k.ATTRIB_CLASS.OBJECT:if(this.has_attrib(t)&&this._objects)for(let s of this._objects)s.traverse(s=>{new Nt(s,0).rename_attribute(t,e)})}}attrib_names(){let t;return null!=(t=this.core_geometries()[0])?t.attrib_names():[]}object_attrib_names(){let t;return null!=(t=this.core_objects()[0])?t.attrib_names():[]}attrib_names_matching_mask(t){const e=Ot.a.attrib_names(t),s=[];for(let t of this.attrib_names())for(let i of e)Ot.a.match_mask(t,i)&&s.push(t);return C()(s)}attrib_sizes(){let t;return null!=(t=this.core_geometries()[0])?t.attrib_sizes():{}}attrib_size(t){let e;return null!=(e=this.core_geometries()[0])?e.attrib_size(t):0}add_numeric_vertex_attrib(t,e,s){null==s&&(s=ct.a.default_value(e));for(let i of this.core_geometries())i.add_numeric_attrib(t,e,s)}add_numeric_object_attrib(t,e,s){null==s&&(s=ct.a.default_value(e));for(let e of this.core_objects())e.add_numeric_attrib(t,s)}static clone(t){const e=new g.a;return t.children.forEach(t=>{const s=Nt.clone(t);e.add(s)}),e}}var It=s(39);class St extends It.b{set_objects(t){}core_content_cloned(){if(this._content)return this._content.clone()}set_content(t){super.set_content(t)}first_object(){if(this._content)return this._content.objects()[0]}first_geometry(){const t=this.first_object();return t?t.geometry:null}objects_count(){return this._content?this._content.objects().length:0}objects_visible_count(){let t=0;return this._content&&(t=this._content.objects().filter(t=>t.visible).length),t}objects_count_by_type(){const t={},e=this._content;if(this._content&&e)for(let s of e.core_objects()){const e=s.human_type();null==t[e]&&(t[e]=0),t[e]+=1}return t}objects_names_by_type(){const t={},e=this._content;if(this._content&&e)for(let s of e.core_objects()){const e=s.human_type();t[e]=t[e]||[],t[e].push(s.name())}return t}vertex_attribute_names(){let t=[];const e=this.first_geometry();return e&&(t=Object.keys(e.attributes)),t}vertex_attribute_sizes_by_name(){let t={};const e=this.first_geometry();return e&&Object.keys(e.attributes).forEach(s=>{const i=e.attributes[s];t[s]=i.itemSize}),t}vertex_attribute_types_by_name(){let t={};const e=this.first_geometry();if(e){const s=new Tt(e);Object.keys(e.attributes).forEach(e=>{t[e]=s.attrib_type(e)})}return t}object_attribute_names(){let t=[];const e=this.first_object();return e&&(t=Object.keys(e.userData.attributes||{})),t}points_count(){return this._content?this._content.points_count():0}bounding_box(){return this._content.bounding_box()}center(){return this._content.center()}size(){return this._content.size()}}var Mt,kt=s(37),zt=s(35),Ct=s(343);!function(t){t.FROM_SET_CORE_GROUP="from set_core_group",t.FROM_SET_GROUP="from set_group",t.FROM_SET_OBJECTS="from set_objects",t.FROM_SET_OBJECT="from set_object",t.FROM_SET_GEOMETRIES="from set_geometries",t.FROM_SET_GEOMETRY="from set_geometry"}(Mt||(Mt={}));const Lt=["input geometry","input geometry","input geometry","input geometry"];class Pt extends u.b{constructor(){super(...arguments),this.container_controller=new kt.a(this,St),this.flags=new Ct.c(this)}static node_context(){return zt.a.SOP}static displayed_input_names(){return Lt}initialize_base_node(){this.flags.display&&(this.flags.display.set(!1),this.flags.display.add_hook(()=>{if(this.flags.display.active){const t=this.parent;t&&t.display_node_controller&&t.display_node_controller.set_display_node(this)}})),this.io.outputs.set_has_one_output()}set_core_group(t){const e=t.objects();for(let t of e)this._set_object_attributes(t);this.set_container(t,Mt.FROM_SET_CORE_GROUP)}set_object(t){this._set_object_attributes(t),this.set_container_objects([t],Mt.FROM_SET_OBJECT)}set_objects(t){for(let e of t)this._set_object_attributes(e);this.set_container_objects(t,Mt.FROM_SET_OBJECTS)}set_geometry(t,e){const s=this.create_object(t,e);this.set_container_objects([s],Mt.FROM_SET_GEOMETRY)}set_geometries(t,e){const s=[];let i;t.forEach(t=>{i=this.create_object(t,e),this._set_object_attributes(i),s.push(i)}),this.set_container_objects(s,Mt.FROM_SET_GEOMETRIES)}set_container_objects(t,e){const s=this.container_controller.container.core_content()||new jt;s.set_objects(t),s.touch(),this.set_container(s)}create_object(t,e){if(!t.index){const e=t.getAttribute("position").array;t.setIndex(l()(e.length/3))}null==e&&(e=k.OBJECT_TYPE.MESH);const s=new(0,k.CONSTRUCTORS_BY_NAME[e])(t,k.MATERIALS[e].clone());return s.castShadow=!0,s.receiveShadow=!0,s.frustumCulled=!1,s}_set_object_attributes(t){const e=t.material;if(e){if(!this.scene)throw console.log("no scene"),"no scene";const s=wt.node(this.scene,e);s&&s.add_render_hook(t)}}_add_index(t){const e=t.getAttribute("position").array.length/3,s=[];o()(e,t=>s.push(t)),t.setIndex(s)}}var Ft=s(44);class Dt extends Ft.a{constructor(){super(...arguments),this.create_point=Ft.b.BOOLEAN(1),this.points_count=Ft.b.INTEGER(1,{range:[1,100],range_locked:[!0,!1],visible_if:{create_point:!0}}),this.position=Ft.b.VECTOR3([0,0,0],{visible_if:{create_point:!0}}),this.open=Ft.b.BOOLEAN(0),this.connect_to_last_point=Ft.b.BOOLEAN(0)}}const Bt=new Dt;class Vt extends Pt{constructor(){super(...arguments),this.params_config=Bt}static type(){return"add"}static displayed_input_names(){return["geometry to create polygons from (optional)"]}initialize_node(){this.io.inputs.set_count(0,1)}cook(t){this._objects=[],this._create_point(),this.set_objects(this._objects)}_create_point(){if(this.pv.create_point){const t=new a.a,e=[];o()(this.pv.points_count,t=>{this.pv.position.toArray(e,3*t)}),t.setAttribute("position",new _.a(new Float32Array(e),3));const s=this.create_object(t,k.OBJECT_TYPE.POINTS);this._objects&&this._objects.push(s)}}}var Gt=s(34);class Ut extends Ft.a{}const $t=new Ut;class qt extends Pt{constructor(){super(...arguments),this.params_config=$t}static type(){return"animation_copy"}static displayed_input_names(){return["geometry to copy animation to","geometry to copy animation from"]}initialize_node(){this.io.inputs.set_count(2),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE,Gt.a.NEVER])}cook(t){const e=t[0],s=t[1].objects()[0],i=e.objects()[0],r=s.animations;r?(i.animations=r.map(t=>t.clone()),this.set_core_group(e)):this.states.error.set("no animation found")}}var Yt=s(1),Ht=s(608),Xt=s(0),Jt=s(7);class Kt extends Ft.a{constructor(){super(...arguments),this.time=Ft.b.FLOAT("$T",{range:[0,10]}),this.prepare=Ft.b.BUTTON(null,{callback:(t,e)=>{Zt.PARAM_CALLBACK_prepare(t,e)}})}}const Wt=new Kt;class Zt extends Pt{constructor(){super(...arguments),this.params_config=Wt,this._previous_time=null,this._mixer=null,this._actions_by_name={},this._values_by_param_name={}}static type(){return"animation_mixer"}static displayed_input_names(){return["geometry to be animated"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){this._mixer?(this._update_mixer(),this.cook_controller.end_cook()):this.create_mixer(t[0])}create_mixer(t){this._animation_target=t.objects()[0],this._mixer=new Ht.a(this._animation_target),this._remove_spare_params(),this._actions_by_name={},this._animation_target.animations&&this._animation_target.animations.forEach((t,e)=>{const s=t.name;let i=this._values_by_param_name[s];null==i&&(i=0==e?1:0);const r=this.add_param(Xt.a.FLOAT,s,i,{spare:!0});if(r){const t=this._values_by_param_name[s];t&&r.set(t)}if(this._mixer){const e=this._mixer.clipAction(t);this._actions_by_name[t.name]=e}}),this.emit(Jt.a.PARAMS_UPDATED),Object.keys(this._actions_by_name).forEach(t=>{this._actions_by_name[t].play()});const e={};this._animation_target.traverse(t=>{const s=t;s.material&&(nt()(s.material)||(e[s.material.uuid]=s.material))}),Object.keys(e).forEach(t=>{const s=e[t];s.skinning=!0,s.morphTargets=!0}),this._previous_time=null,this._update_mixer(),this._update_mixer_weights(),this.set_object(this._animation_target)}_remove_spare_params(){this._values_by_param_name={};const t=this.params.spare_names,e=[];t.forEach(t=>{const s=this.params.get_float(t);s&&(this._values_by_param_name[t]=s.value,e.push(t))}),e.length>0&&this.params.update_params({names_to_delete:e})}_update_mixer(){this.pv.time!=this._previous_time?this._update_mixer_time():this._update_mixer_weights()}_update_mixer_time(){const t=this.pv.time-(this._previous_time||0);this._mixer&&this._mixer.update(t),this._previous_time=this.pv.time}_update_mixer_weights(){for(let t of Object.keys(this._actions_by_name)){const e=this._actions_by_name[t],s=this.params.get_float(t).value;null!=s&&e.setEffectiveWeight(s)}}static PARAM_CALLBACK_prepare(t,e){t.prepare_animation_mixer()}prepare_animation_mixer(){return Object(Yt.a)(this,void 0,void 0,(function*(){this._mixer=null;const t=yield this.io.inputs.eval_required_input(0);this.create_mixer(t.core_content_cloned()),this.set_dirty()}))}}class Qt extends Ft.a{constructor(){super(...arguments),this.name=Ft.b.STRING(""),this.pre_add=Ft.b.FLOAT(0,{range:[0,1]}),this.mult=Ft.b.FLOAT(1,{range:[0,1]}),this.post_add=Ft.b.FLOAT(0,{range:[0,1]})}}const te=new Qt;class ee extends Pt{constructor(){super(...arguments),this.params_config=te}static type(){return"attrib_add_mult"}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){const e=t[0],s=e.attrib_names_matching_mask(this.pv.name);for(let t of s){const s=e.geometries();for(let e of s)this._update_attrib(t,e)}this.set_core_group(e)}_update_attrib(t,e){const s=e.getAttribute(t);if(s){const t=s.array,e=this.pv.pre_add,i=this.pv.mult,r=this.pv.post_add;for(let s=0;s<t.length;s++){const n=t[s];t[s]=(n+e)*i+r}this.io.inputs.input_cloned(0)||(s.needsUpdate=!0)}}}class se extends Ft.a{constructor(){super(...arguments),this.name=Ft.b.STRING(""),this.tnew_name=Ft.b.BOOLEAN(0),this.new_name=Ft.b.STRING("",{visible_if:{tnew_name:1}})}}const ie=new se;class re extends Pt{constructor(){super(...arguments),this.params_config=ie}static type(){return"attrib_copy"}static displayed_input_names(){return["geometry to copy attributes to","geometry to copy attributes from"]}initialize_node(){this.io.inputs.set_count(2),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE,Gt.a.NEVER])}create_params(){}cook(t){const e=t[0],s=t[1],i=s.attrib_names_matching_mask(this.pv.name);for(let t of i)this.copy_vertex_attribute_between_core_groups(e,s,t);return this.set_core_group(e)}copy_vertex_attribute_between_core_groups(t,e,s){const i=e.objects(),r=t.objects();if(r.length>i.length)this.states.error.set("second input does not have enough objects to copy attributes from");else for(let t=0;t<r.length;t++){const e=r[t].geometry,i=r[t].geometry;this.copy_vertex_attribute_between_geometries(e,i,s)}}copy_vertex_attribute_between_geometries(t,e,s){const i=e.getAttribute(s);if(i){const r=i.itemSize,n=e.getAttribute("position").array.length/3,o=t.getAttribute("position").array.length/3;o>n&&this.states.error.set("not enough points in second input");const a=i.array.slice(0,o*r),c=this.pv.tnew_name?this.pv.new_name:s;t.setAttribute(c,new _.b(a,r))}else this.states.error.set(`attribute '${s}' does not exist on second input`)}}class ne extends Ft.a{constructor(){super(...arguments),this.group=Ft.b.STRING(""),this.class=Ft.b.INTEGER(j.VERTEX,{menu:{entries:I}}),this.type=Ft.b.INTEGER(S.NUMERIC,{menu:{entries:M}}),this.name=Ft.b.STRING("new_attrib"),this.size=Ft.b.INTEGER(1,{range:[1,4],range_locked:[!0,!0],visible_if:{type:k.ATTRIB_TYPE.NUMERIC}}),this.value1=Ft.b.FLOAT(0,{visible_if:{type:k.ATTRIB_TYPE.NUMERIC,size:1},expression:{for_entities:!0}}),this.value2=Ft.b.VECTOR2([0,0],{visible_if:{type:k.ATTRIB_TYPE.NUMERIC,size:2},expression:{for_entities:!0}}),this.value3=Ft.b.VECTOR3([0,0,0],{visible_if:{type:k.ATTRIB_TYPE.NUMERIC,size:3},expression:{for_entities:!0}}),this.value4=Ft.b.VECTOR4([0,0,0,0],{visible_if:{type:k.ATTRIB_TYPE.NUMERIC,size:4},expression:{for_entities:!0}}),this.string=Ft.b.STRING("",{visible_if:{type:k.ATTRIB_TYPE.STRING},expression:{for_entities:!0}})}}const oe=new ne;class ae extends Pt{constructor(){super(...arguments),this.params_config=oe,this._x_arrays_by_geometry_uuid={},this._y_arrays_by_geometry_uuid={},this._z_arrays_by_geometry_uuid={},this._w_arrays_by_geometry_uuid={}}static type(){return"attrib_create"}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){const e=t[0];if(this.pv.name&&""!=V()(this.pv.name))switch(this.pv.class){case j.VERTEX:this.add_point_attribute(e);break;case j.OBJECT:this.add_object_attribute(e)}else this.states.error.set("attribute name is not valid")}add_point_attribute(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t.core_objects();for(let t=0;t<e.length;t++){const s=e[t];switch(this.pv.type){case k.ATTRIB_TYPE.NUMERIC:yield this.add_numeric_attribute_to_points(s);break;case k.ATTRIB_TYPE.STRING:yield this.add_string_attribute_to_points(s)}}this.set_core_group(t)}))}add_object_attribute(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t.core_objects_from_group(this.pv.group);switch(this.pv.type){case k.ATTRIB_TYPE.NUMERIC:yield this.add_numeric_attribute_to_object(e);break;case k.ATTRIB_TYPE.STRING:yield this.add_string_attribute_to_object(e)}this.set_core_group(t)}))}add_numeric_attribute_to_points(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t.core_geometry();if(!e)return;const s=t.points_from_group(this.pv.group),i=[this.p.value1,this.p.value2,this.p.value3,this.p.value4][this.pv.size-1];if(i.has_expression()){e.has_attrib(this.pv.name)||e.add_numeric_attrib(this.pv.name,this.pv.size,i.value);const t=e.geometry(),r=t.getAttribute(this.pv.name).array;if(1==this.pv.size)this.p.value1.expression_controller&&(yield this.p.value1.expression_controller.compute_expression_for_points(s,(t,e)=>{r[t.index*this.pv.size+0]=e}));else{let e=[this.p.value2,this.p.value3,this.p.value4][this.pv.size-2].components;const i=new Array(e.length);let n;const o=[this._x_arrays_by_geometry_uuid,this._y_arrays_by_geometry_uuid,this._z_arrays_by_geometry_uuid,this._w_arrays_by_geometry_uuid];for(let a=0;a<e.length;a++)if(n=e[a],n.has_expression()&&n.expression_controller)i[a]=this._init_array_if_required(t,o[a],s.length),yield n.expression_controller.compute_expression_for_points(s,(t,e)=>{i[a][t.index]=e});else{const t=n.value;for(let e of s)r[e.index*this.pv.size+a]=t}for(let t=0;t<i.length;t++){const e=i[t];if(e)for(let s=0;s<e.length;s++)r[s*this.pv.size+t]=e[s]}}}else t.add_numeric_vertex_attrib(this.pv.name,this.pv.size,i.value)}))}add_numeric_attribute_to_object(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=[this.p.value1,this.p.value2,this.p.value3,this.p.value4][this.pv.size-1];if(e.has_expression())if(1==this.pv.size)this.p.value1.expression_controller&&(yield this.p.value1.expression_controller.compute_expression_for_objects(t,(t,e)=>{t.set_attrib_value(this.pv.name,e)}));else{let e=[this.p.value2,this.p.value3,this.p.value4][this.pv.size-2].components,s={};for(let e of t)s[e.index]=[];for(let i=0;i<e.length;i++){const r=e[i];if(r.has_expression()&&r.expression_controller)yield r.expression_controller.compute_expression_for_objects(t,(t,e)=>{s[t.index][i]=e});else for(let e of t)s[e.index][i]=r.value}for(let e=0;e<t.length;e++){const i=t[e],r=s[i.index];i.set_attrib_value(this.pv.name,r)}}else for(let s of t)s.set_attrib_value(this.pv.name,e.value)}))}add_string_attribute_to_points(t){var e;return Object(Yt.a)(this,void 0,void 0,(function*(){const s=t.points_from_group(this.pv.group),i=this.p.string,r=[];i.has_expression()&&i.expression_controller?yield i.expression_controller.compute_expression_for_points(s,(t,e)=>{r[t.index]=e}):r.push(i.value);const n=ct.a.array_to_indexed_arrays(r);null===(e=t.core_geometry())||void 0===e||e.set_indexed_attribute(this.pv.name,n.values,n.indices)}))}add_string_attribute_to_object(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=this.p.string;if(e.has_expression()&&e.expression_controller)yield e.expression_controller.compute_expression_for_objects(t,(t,e)=>{t.set_attrib_value(this.pv.name,e)});else for(let s of t)s.set_attrib_value(this.pv.name,e.value)}))}_init_array_if_required(t,e,s){const i=t.uuid,r=e[i];return r?r.length<s&&(e[i]=new Array(s)):e[i]=new Array(s),e[i]}}class _e extends Ft.a{constructor(){super(...arguments),this.class=Ft.b.INTEGER(j.VERTEX,{menu:{entries:I}}),this.name=Ft.b.STRING("")}}const ce=new _e;class le extends Pt{constructor(){super(...arguments),this.params_config=ce}static type(){return"attrib_delete"}static displayed_input_names(){return["geometry to delete attributes from"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){const e=t[0],s=e.attrib_names_matching_mask(this.pv.name);for(let t of s)switch(this.pv.class){case j.VERTEX:this.delete_vertex_attribute(e,t);case j.OBJECT:this.delete_object_attribute(e,t)}this.set_core_group(e)}delete_vertex_attribute(t,e){for(let s of t.objects())s.traverse(t=>{const s=t;if(s.geometry){new Tt(s.geometry).delete_attribute(e)}})}delete_object_attribute(t,e){for(let s of t.objects()){let t=0;s.traverse(s=>{new Nt(s,t).delete_attribute(e),t++})}}}var ue=s(418),he=s.n(ue),de=s(439),pe=s.n(de);class me extends Ft.a{constructor(){super(...arguments),this.name=Ft.b.STRING(""),this.change_name=Ft.b.BOOLEAN(!1),this.new_name=Ft.b.STRING("",{visible_if:{change_name:1}})}}const fe=new me;class be extends Pt{constructor(){super(...arguments),this.params_config=fe}static type(){return"attrib_normalize"}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){const e=t[0];this._normalize_attribute(e),this.set_core_group(e)}_normalize_attribute(t){const e=t.points();if(0===e.length)return;if(""===this.pv.name)return;const s=e[0].attrib_size(this.pv.name),i=e.map(t=>t.attrib_value(this.pv.name));let r,n,o=[];switch(s){case 1:if(r=pe()(i),n=he()(i),at()(r)&&at()(n))for(let t of i){const e=n>r?(t-r)/(n-r):1;o.push(e)}break;case 3:if(r=new Y.a(pe()(i.map(t=>t.x)),pe()(i.map(t=>t.y)),pe()(i.map(t=>t.z))),n=new Y.a(he()(i.map(t=>t.x)),he()(i.map(t=>t.y)),he()(i.map(t=>t.z))),r instanceof Y.a&&n instanceof Y.a)for(let t of i){const e=new Y.a((t.x-r.x)/(n.x-r.x),(t.y-r.y)/(n.y-r.y),(t.z-r.z)/(n.z-r.z));o.push(e)}}let a=this.pv.name;this.pv.change_name&&(a=this.pv.new_name,t.has_attrib(a)||t.add_numeric_vertex_attrib(a,s,0)),o.forEach((t,s)=>{e[s].set_attrib_value(a,t)})}}var ge;!function(t){t[t.MIN=0]="MIN",t[t.MAX=1]="MAX",t[t.FIRST_FOUND=2]="FIRST_FOUND"}(ge||(ge={}));const ve=[{name:"min",value:ge.MIN},{name:"max",value:ge.MAX},{name:"first_found",value:ge.FIRST_FOUND}];class ye extends Ft.a{constructor(){super(...arguments),this.class_from=Ft.b.INTEGER(j.VERTEX,{menu:{entries:I}}),this.class_to=Ft.b.INTEGER(j.OBJECT,{menu:{entries:I}}),this.mode=Ft.b.INTEGER(ge.FIRST_FOUND,{menu:{entries:ve}}),this.name=Ft.b.STRING("")}}const xe=new ye;class Ee extends Pt{constructor(){super(...arguments),this.params_config=xe,this._values_per_attrib_name={},this._filtered_values_per_attrib_name={}}static type(){return"attrib_promote"}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}create_params(){}cook(t){this._core_group=t[0],this._values_per_attrib_name={},this._filtered_values_per_attrib_name={};for(let t of this._core_group.core_objects())this._core_object=t,this.find_values(),this.filter_values(),this.set_values();this.set_core_group(this._core_group)}find_values(){const t=Ot.a.attrib_names(this.pv.name);for(let e of t)switch(this.pv.class_from){case j.VERTEX:return this.find_values_from_points(e);case j.OBJECT:return this.find_values_from_object(e)}}find_values_from_points(t){if(this._core_object){const e=this._core_object.points();this._values_per_attrib_name[t]=e.map(e=>e.attrib_value(t))}}find_values_from_object(t){this._values_per_attrib_name[t]=[],this._core_object&&this._values_per_attrib_name[t].push(this._core_object.attrib_value(t))}filter_values(){const t=Object.keys(this._values_per_attrib_name);for(let e of t){const t=this._values_per_attrib_name[e];switch(this.pv.mode){case ge.MIN:this._filtered_values_per_attrib_name[e]=pe()(t);break;case ge.MAX:this._filtered_values_per_attrib_name[e]=he()(t);break;case ge.FIRST_FOUND:this._filtered_values_per_attrib_name[e]=t[0]}}}set_values(){const t=Object.keys(this._filtered_values_per_attrib_name);for(let e of t){const t=this._filtered_values_per_attrib_name[e];if(null!=t)switch(this.pv.class_to){case j.VERTEX:this.set_values_to_points(e,t);break;case j.OBJECT:this.set_values_to_object(e,t)}}}set_values_to_points(t,e){if(this._core_group&&this._core_object){if(!this._core_group.has_attrib(t)){const s=1;this._core_group.add_numeric_vertex_attrib(t,s,e)}this._core_object.points().forEach(s=>s.set_attrib_value(t,e))}}set_values_to_object(t,e){var s;null===(s=this._core_object)||void 0===s||s.set_attrib_value(t,e)}}var Te=s(31),we=s.n(Te);class Oe extends Ft.a{constructor(){super(...arguments),this.name=Ft.b.STRING(),this.ramp=Ft.b.RAMP(),this.change_name=Ft.b.BOOLEAN(0),this.new_name=Ft.b.STRING("",{visible_if:{change_name:1}})}}const Ae=new Oe;class Re extends Pt{constructor(){super(...arguments),this.params_config=Ae}static type(){return"attrib_remap"}initialize_node(){this.io.inputs.set_count(1)}cook(t){const e=t[0];this._remap_attribute(e),this.set_core_group(e)}_remap_attribute(t){const e=t.points();if(0===e.length)return;if(""===this.pv.name)return;const s=e[0].attrib_size(this.pv.name),i=e.map(t=>t.attrib_value(this.pv.name));let r,n,o=new Array(e.length);switch(s){case 1:if(this.pv.only_integer_values){const t=C()(we()(i)),e={};t.forEach((t,s)=>e[t]=s),o=i.map(t=>e[t])}else if(r=pe()(i),n=he()(i),at()(r)&&at()(n))for(let t=0;t<i.length;t++){const e=i[t],s=n>r?(e-r)/(n-r):1;o[t]=s}break;case 3:if(r=new Y.a(pe()(i.map(t=>t.x)),pe()(i.map(t=>t.y)),pe()(i.map(t=>t.z))),n=new Y.a(he()(i.map(t=>t.x)),he()(i.map(t=>t.y)),he()(i.map(t=>t.z))),r instanceof Y.a&&n instanceof Y.a)for(let t=0;t<i.length;t++){const e=i[t],s=new Y.a((e.x-r.x)/(n.x-r.x),(e.y-r.y)/(n.y-r.y),(e.z-r.z)/(n.z-r.z));o[t]=s}}let a=this.pv.name;this.pv.change_name&&(a=this.pv.new_name,t.has_attrib(a)||t.add_numeric_vertex_attrib(a,s,0)),o.forEach((t,s)=>{e[s].set_attrib_value(a,t)})}}class Ne extends Ft.a{constructor(){super(...arguments),this.class=Ft.b.INTEGER(j.VERTEX,{menu:{entries:I}}),this.old_name=Ft.b.STRING(),this.new_name=Ft.b.STRING()}}const je=new Ne;class Ie extends Pt{constructor(){super(...arguments),this.params_config=je}static type(){return"attrib_rename"}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){const e=t[0];e.rename_attrib(this.pv.old_name,this.pv.new_name,this.pv.class),this.set_core_group(e)}}var Se=s(358);class Me{constructor(t,e=0){this._bbox=t,this._level=e,this._leaves_by_octant={},this._points_by_octant_id={},this._leaves=[],this._bounding_boxes_by_octant={},this._bounding_boxes_by_octant_prepared=!1,this._center=this._bbox.max.clone().add(this._bbox.min).multiplyScalar(.5)}level(){return this._level}traverse(t){t(this),Object.values(this._leaves_by_octant).forEach(e=>{e.traverse(t)})}intersects_sphere(t){return!!this._bbox&&this._bbox.intersectsSphere(t)}points_in_sphere(t,e){if(0==this._leaves.length){U()(Object.values(this._points_by_octant_id)).filter(e=>t.containsPoint(e.position())).forEach(t=>{e.push(t)})}else{this._leaves.filter(e=>e.intersects_sphere(t)).forEach(s=>s.points_in_sphere(t,e))}}bounding_box(){return this._bbox}set_points(t){this._points_by_octant_id={};for(let e of t)this.add_point(e);const e=Object.keys(this._points_by_octant_id);e.length>1&&e.forEach(t=>{this.create_leaf(t)})}create_leaf(t){const e=this._leaf_bbox(t),s=new Me(e,this._level+1);this._leaves_by_octant[t]=s,this._leaves.push(s),s.set_points(this._points_by_octant_id[t])}add_point(t){const e=this._octant_id(t.position());null==this._points_by_octant_id[e]&&(this._points_by_octant_id[e]=[]),this._points_by_octant_id[e].push(t)}_octant_id(t){return`${t.x>this._center.x?1:0}${t.y>this._center.y?1:0}${t.z>this._center.z?1:0}`}_leaf_bbox(t){return this._bounding_boxes_by_octant_prepared||(this._prepare_leaves_bboxes(),this._bounding_boxes_by_octant_prepared=!0),this._bounding_boxes_by_octant[t]}_bbox_center(t,e,s){const i=this._bbox.min.clone();return t&&(i.x=this._bbox.max.x),e&&(i.y=this._bbox.max.y),s&&(i.z=this._bbox.max.z),i.clone().add(this._center).multiplyScalar(.5)}_prepare_leaves_bboxes(){const t=[];t.push(this._bbox_center(0,0,0)),t.push(this._bbox_center(0,0,1)),t.push(this._bbox_center(0,1,0)),t.push(this._bbox_center(0,1,1)),t.push(this._bbox_center(1,0,0)),t.push(this._bbox_center(1,0,1)),t.push(this._bbox_center(1,1,0)),t.push(this._bbox_center(1,1,1));const e=this._bbox.max.clone().sub(this._bbox.min).multiplyScalar(.25);for(let s of t){const t=this._octant_id(s),i=new H.a(s.clone().sub(e),s.clone().add(e));this._bounding_boxes_by_octant[t]=i}}}class ke{constructor(t){this._root=new Me(t)}set_points(t){this._root.set_points(t)}traverse(t){this._root.traverse(t)}find_points(t,e,s){const i=new Se.a(t,e);let r=[];return this._root.intersects_sphere(i)&&this._root.points_in_sphere(i,r),null==s||r.length>s&&(r=we()(r,e=>e.position().distanceTo(t)),r=r.slice(0,s)),r}}class ze{constructor(t={}){this._array_index=0,this._count=0,this._current_count_index=0,this._resolve=null,this._max_time_per_chunk=t.max_time_per_chunk||10,this._check_every_interations=t.check_every_interations||100}start_with_count(t,e){return Object(Yt.a)(this,void 0,void 0,(function*(){if(this._count=t,this._current_count_index=0,this._iteratee_method_count=e,this._bound_next_with_count=this.next_with_count.bind(this),this._resolve)throw"an iterator cannot be started twice";return new Promise((t,e)=>{this._resolve=t,this.next_with_count()})}))}next_with_count(){const t=performance.now();if(this._iteratee_method_count&&this._bound_next_with_count)for(;this._current_count_index<this._count;)if(this._iteratee_method_count(this._current_count_index),this._current_count_index++,this._current_count_index%this._check_every_interations==0&&performance.now()-t>this._max_time_per_chunk){setTimeout(this._bound_next_with_count,1);break}this._current_count_index>=this._count&&this._resolve&&this._resolve()}start_with_array(t,e){return Object(Yt.a)(this,void 0,void 0,(function*(){if(this._array=t,this._array_index=0,this._iteratee_method_array=e,this._bound_next_with_array=this.next_with_array.bind(this),this._resolve)throw"an iterator cannot be started twice";return new Promise((t,e)=>{this._resolve=t,this.next_with_array()})}))}next_with_array(){const t=performance.now();if(this._iteratee_method_array&&this._bound_next_with_array&&this._array)for(;this._current_array_element=this._array[this._array_index];)if(this._iteratee_method_array(this._current_array_element,this._array_index),this._array_index++,this._array_index%this._check_every_interations==0&&performance.now()-t>this._max_time_per_chunk){setTimeout(this._bound_next_with_array,1);break}void 0===this._current_array_element&&this._resolve&&this._resolve()}}class Ce extends Ft.a{constructor(){super(...arguments),this.src_group=Ft.b.STRING(),this.dest_group=Ft.b.STRING(),this.name=Ft.b.STRING(),this.max_samples_count=Ft.b.INTEGER(1,{range:[1,10],range_locked:[!0,!1]}),this.distance_threshold=Ft.b.FLOAT(1),this.blend_width=Ft.b.FLOAT(0)}}const Le=new Ce;class Pe extends Pt{constructor(){super(...arguments),this.params_config=Le}static type(){return"attrib_transfer"}static displayed_input_names(){return["geometry to transfer attributes to","geometry to transfer attributes from"]}initialize_node(){this.io.inputs.set_count(2),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE,Gt.a.NEVER])}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){this._core_group_dest=t[0];const e=this._core_group_dest.points_from_group(this.pv.dest_group);this._core_group_src=t[1],this._attrib_names=this._core_group_src.attrib_names_matching_mask(this.pv.name),this._error_if_attribute_not_found_on_second_input(),this._build_octree_if_required(this._core_group_src),this._add_attribute_if_required(),yield this._transfer_attributes(e),this.set_core_group(this._core_group_dest)}))}_error_if_attribute_not_found_on_second_input(){for(let t of this._attrib_names)this._core_group_src.has_attrib(t)||this.states.error.set(`attribute '${t}' not found on second input`)}_build_octree_if_required(t){const e=null==this._octree_timestamp||this._octree_timestamp!==t.timestamp();if(this._prev_param_src_group!==this.pv.src_group||e){this._octree_timestamp=t.timestamp(),this._prev_param_src_group=this.pv.src_group;const e=this._core_group_src.points_from_group(this.pv.src_group);this._octree=new ke(this._core_group_src.bounding_box()),this._octree.set_points(e)}}_add_attribute_if_required(){this._attrib_names.forEach(t=>{if(!this._core_group_dest.has_attrib(t)){const e=this._core_group_src.attrib_size(t);this._core_group_dest.add_numeric_vertex_attrib(t,e,0)}})}_transfer_attributes(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=new ze;yield e.start_with_array(t,this._transfer_attributes_for_point.bind(this))}))}_transfer_attributes_for_point(t){var e;const s=this.pv.distance_threshold+this.pv.blend_width,i=(null===(e=this._octree)||void 0===e?void 0:e.find_points(t.position(),s,this.pv.max_samples_count))||[];for(let e of this._attrib_names)this._interpolate_points(t,i,e)}_interpolate_points(t,e,s){let i;i=class{static perform(t,e,s,i,r){switch(e.length){case 0:return 0;case 1:return this._interpolate_with_1_point(t,e[0],s,i,r);default:return this._interpolate_with_multiple_points(t,e,s,i,r)}}static _interpolate_with_1_point(t,e,s,i,r){const n=t.position(),o=e.position(),a=n.distanceTo(o),_=e.attrib_value(s);return this._weighted_value_from_distance(t,_,s,a,i,r)}static _weight_from_distance(t,e,s){return(t-e)/s}static _weighted_value_from_distance(t,e,s,i,r,n){if(i<=r)return e;{const o=t.attrib_value(s),a=this._weight_from_distance(i,r,n);return a*o+(1-a)*e}}static _interpolate_with_multiple_points(t,e,s,i,r){const n=e.map(e=>this._interpolate_with_1_point(t,e,s,i,r));return he()(n)||0}static weights(t,e){switch(e.length){case 1:return 1;case 2:return this._weights_from_2(t,e);default:return e=e.slice(0,3),this._weights_from_3(t,e)}}static _weights_from_2(t,e){const s=e.map(e=>t.distanceTo(e)),i=q()(s);return[s[1]/i,s[0]/i]}static _weights_from_3(t,e){const s=e.map(e=>t.distanceTo(e)),i=q()([s[0]*s[1],s[0]*s[2],s[1]*s[2]]);return[s[1]*s[2]/i,s[0]*s[2]/i,s[0]*s[1]/i]}}.perform(t,e,s,this.pv.distance_threshold,this.pv.blend_width),null!=i&&t.set_attrib_value(s,i)}}class Fe extends Ft.a{constructor(){super(...arguments),this.step_size=Ft.b.FLOAT(.1)}}const De=new Fe;class Be extends Pt{constructor(){super(...arguments),this.params_config=De}static type(){return"bbox_scatter"}static displayed_input_names(){return["geometry to create points from"]}initialize_node(){this.io.inputs.set_count(1)}cook(t){const e=t[0],s=this.pv.step_size,i=e.bounding_box(),r={x:l()(i.min.x,i.max.x,s),y:l()(i.min.y,i.max.y,s),z:l()(i.min.z,i.max.z,s)},n=[];r.x.forEach(t=>{r.y.forEach(e=>{r.z.forEach(s=>{n.push(t),n.push(e),n.push(s)})})});const o=new a.a;o.setAttribute("position",new _.a(new Float32Array(n),3)),this.set_geometry(o,k.OBJECT_TYPE.POINTS)}}class Ve extends Ft.a{constructor(){super(...arguments),this.attrib_name=Ft.b.STRING(),this.blend=Ft.b.FLOAT(.5,{range:[0,1],range_locked:[!0,!0]})}}const Ge=new Ve;class Ue extends Pt{constructor(){super(...arguments),this.params_config=Ge}static type(){return"blend"}static displayed_input_names(){return["geometry to blend from","geometry to blend to"]}initialize_node(){this.io.inputs.set_count(2),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE,Gt.a.NEVER])}cook(t){const e=t[0],s=t[1],i=e.objects(),r=s.objects();let n,o;for(let t=0;t<i.length;t++)n=i[t],o=r[t],this.blend(n,o,this.pv.blend);this.set_core_group(e)}blend(t,e,s){const i=t.geometry,r=e.geometry;if(null==i||null==r)return;const n=i.getAttribute(this.pv.attrib_name),o=r.getAttribute(this.pv.attrib_name);if(null==n||null==o)return;const a=n.array,_=o.array;let c,l;for(let t=0;t<a.length;t++)c=a[t],l=_[t],null!=l&&(a[t]=(1-s)*c+s*l);i.computeVertexNormals()}}var $e=s(350),qe=s(395);class Ye extends Ft.a{constructor(){super(...arguments),this.size=Ft.b.FLOAT(1),this.divisions=Ft.b.INTEGER(1,{range:[1,10],range_locked:[!0,!1]}),this.center=Ft.b.VECTOR3([0,0,0])}}const He=new Ye;class Xe extends Pt{constructor(){super(...arguments),this.params_config=He,this._core_transform=new $e.a}static type(){return"box"}static displayed_input_names(){return["geometry to create bounding box from (optional)"]}initialize_node(){this.io.inputs.set_count(0,1),this.io.inputs.init_inputs_clonable_state([Gt.a.NEVER])}cook(t){const e=t[0];e?this._cook_with_input(e):this._cook_without_input()}_cook_without_input(){const t=this.pv.divisions,e=this.pv.size,s=new qe.a(e,e,e,t,t,t);s.translate(this.pv.center.x,this.pv.center.y,this.pv.center.z),s.computeVertexNormals(),this.set_geometry(s)}_cook_with_input(t){const e=this.pv.divisions,s=t.bounding_box(),i=s.max.clone().sub(s.min),r=s.max.clone().add(s.min).multiplyScalar(.5),n=new qe.a(i.x,i.y,i.z,e,e,e),o=this._core_transform.translation_matrix(r);n.applyMatrix4(o),this.set_geometry(n)}}var Je=s(503);class Ke extends Ft.a{constructor(){super(...arguments),this.cache=Ft.b.STRING("",{hidden:!0}),this.reset=Ft.b.BUTTON(null,{callback:(t,e)=>{Ze.PARAM_CALLBACK_reset(t,e)}})}}const We=new Ke;class Ze extends Pt{constructor(){super(...arguments),this.params_config=We}static type(){return"cache"}static displayed_input_names(){return["geometry to cache"]}initialize_node(){this.io.inputs.set_count(0,1)}cook(t){const e=""==this.pv.cache||null==this.pv.cache,s=t[0];if(e&&s){const t=[];for(let e of s.objects())t.push(e.toJSON());this.set_core_group(s),this.p.cache.set(JSON.stringify(t))}else if(this.pv.cache){const t=new Je.a,e=JSON.parse(this.pv.cache),s=[];for(let i of e){const e=t.parse(i);s.push(e)}this.set_objects(s)}else this.set_objects([])}static PARAM_CALLBACK_reset(t,e){t.param_callback_PARAM_CALLBACK_reset()}param_callback_PARAM_CALLBACK_reset(){return Object(Yt.a)(this,void 0,void 0,(function*(){this.p.cache.set(""),this.request_container()}))}}var Qe=s(427);class ts{static positions(t,e,s=360){const i=bt.a.degrees_to_radians(s)/e,r=[];for(let s=0;s<e;s++){const e=i*s,n=t*Math.cos(e),o=t*Math.sin(e);r.push(new X.a(n,o))}return r}static create(t,e,s=360){const i=this.positions(t,e,s),r=[],n=[];let o;for(let t=0;t<i.length;t++)o=i[t],r.push(o.x),r.push(o.y),r.push(0),t>0&&(n.push(t-1),n.push(t));n.push(e-1),n.push(0);const c=new a.a;return c.setAttribute("position",new _.b(r,3)),c.setIndex(n),c}}const es=new Y.a(0,0,1);class ss extends Ft.a{constructor(){super(...arguments),this.radius=Ft.b.FLOAT(1),this.segments=Ft.b.INTEGER(12,{range:[1,50],range_locked:[!0,!1]}),this.open=Ft.b.BOOLEAN(1),this.arc_angle=Ft.b.FLOAT(360,{range:[0,360],range_locked:[!1,!1],visible_if:{open:1}}),this.direction=Ft.b.VECTOR3([0,1,0])}}const is=new ss;class rs extends Pt{constructor(){super(...arguments),this.params_config=is,this._core_transform=new $e.a}static type(){return"circle"}initialize_node(){}cook(){this.pv.open?this._create_circle():this._create_disk()}_create_circle(){const t=ts.create(this.pv.radius,this.pv.segments,this.pv.arc_angle);this._core_transform.rotate_geometry(t,es,this.pv.direction),this.set_geometry(t,i.LINE_SEGMENTS)}_create_disk(){const t=new Qe.a(this.pv.radius,this.pv.segments);this._core_transform.rotate_geometry(t,es,this.pv.direction),this.set_geometry(t)}}var ns=s(110),os=s(143),as=s(435);class _s{constructor(){}set_node(t){this.node=t}cook(t){}set_core_group(t){this.node.set_core_group(t)}}class cs extends Ft.a{constructor(){super(...arguments),this.code_typescript=Ft.b.STRING("import {BaseCodeSopProcessor, CoreGroup} from 'polygonjs-engine'\nexport class CodeSopProcessor extends BaseCodeSopProcessor {\n\tconstructor(){\n\t\tsuper();\n\t}\n\tcook(core_groups: CoreGroup[]){\n\t\tconst core_group = core_groups[0];\n\t\tconst object = core_group.objects()[0];\n\t\tobject.position.y = 1;\n\t\tthis.set_core_group(core_groups[0]);\n\t}\n}\n\n\n",{label:!1,language:ns.b.TYPESCRIPT}),this.code_javascript=Ft.b.STRING("",{hidden:!0})}}const ls=new cs;class us extends Pt{constructor(){super(...arguments),this.params_config=ls}static type(){return"code"}initialize_node(){this.io.inputs.set_count(0,4),this.ui_data.set_width(100),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){this._compile_if_required(),this._processor?this._processor.cook(t):this.set_core_group(t[0])}_compile_if_required(){this._processor&&this._last_compiled_code==this.pv.code_javascript||this._compile()}_compile(){try{const t=`try {\n\t\t\t\t${as.a.filter(this.pv.code_javascript)}\n\t\t\t} catch(e) {\n\t\t\t\tthis.states.error.set(e)\n\t\t\t}`;console.log("function_body"),console.log(t);const e=new os.a("BaseCodeSopProcessor",t)(_s);e?(this._processor=new e,this._processor.set_node(this),this._last_compiled_code=this.pv.code_javascript):(this.states.error.set("cannot generate function"),this._processor=void 0)}catch(t){console.warn(t),this.states.error.set(`cannot generate function (${t})`),this._processor=void 0}}}var hs=s(10);class ds{static set_hsv(t,e,s,i){t=hs.a.euclideanModulo(t,1),e=hs.a.clamp(e,0,1),s=hs.a.clamp(s,0,1),i.setHSL(t,e*s/((t=(2-e)*s)<1?t:2-t),.5*t)}}const ps=new y.a(1,1,1);class ms extends Ft.a{constructor(){super(...arguments),this.from_attribute=Ft.b.BOOLEAN(0),this.attrib_name=Ft.b.STRING("",{visible_if:{from_attribute:1}}),this.color=Ft.b.COLOR([1,1,1],{visible_if:{from_attribute:0},expression:{for_entities:!0}}),this.as_hsv=Ft.b.BOOLEAN(0,{visible_if:{from_attribute:0}})}}const fs=new ms;class bs extends Pt{constructor(){super(...arguments),this.params_config=fs,this._r_arrays_by_geometry_uuid={},this._g_arrays_by_geometry_uuid={},this._b_arrays_by_geometry_uuid={}}static type(){return"color"}static displayed_input_names(){return["geometry to update color of"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t[0],s=e.core_objects();for(let t of s)if(this.pv.from_attribute)this._set_from_attribute(t);else{this.p.color.has_expression()?yield this._eval_expressions(t):this._eval_simple_values(t)}if(!this.io.inputs.input_cloned(0)){const t=e.geometries();for(let e of t)e.getAttribute("color").needsUpdate=!0}this.set_core_group(e)}))}_set_from_attribute(t){const e=t.core_geometry();if(!e)return;this._create_init_color(e,ps);const s=e.points(),i=e.attrib_size(this.pv.attrib_name),r=e.geometry(),n=r.getAttribute(this.pv.attrib_name).array,o=r.getAttribute("color").array;switch(i){case 1:for(let t=0;t<s.length;t++){const e=3*t;o[e+0]=n[t],o[e+1]=1-n[t],o[e+2]=0}break;case 2:for(let t=0;t<s.length;t++){const e=3*t,s=2*t;o[e+0]=n[s+0],o[e+1]=n[s+1],o[e+2]=0}break;case 3:for(let t=0;t<n.length;t++)o[t]=n[t];break;case 4:for(let t=0;t<s.length;t++){const e=3*t,s=4*t;o[e+0]=n[s+0],o[e+1]=n[s+1],o[e+2]=n[s+2]}}}_create_init_color(t,e){t.has_attrib("color")||t.add_numeric_attrib("color",3,ps)}_eval_simple_values(t){const e=t.core_geometry();if(!e)return;let s;this._create_init_color(e,ps),this.pv.as_hsv?(s=new y.a,ds.set_hsv(this.pv.color.r,this.pv.color.g,this.pv.color.b,s)):s=this.pv.color,e.add_numeric_attrib("color",3,s)}_eval_expressions(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t.points(),s=t.object(),i=t.core_geometry();i&&this._create_init_color(i,ps);const r=s.geometry;if(r){const t=r.getAttribute("color").array,s=yield this._update_from_param(r,t,e,0),i=yield this._update_from_param(r,t,e,1),n=yield this._update_from_param(r,t,e,2);if(s&&this._commit_tmp_values(s,t,0),i&&this._commit_tmp_values(i,t,1),n&&this._commit_tmp_values(n,t,2),this.pv.as_hsv){let s,i=new y.a,r=new y.a;for(let n of e)s=3*n.index,i.fromArray(t,s),ds.set_hsv(i.r,i.g,i.b,r),r.toArray(t,s)}}}))}_update_from_param(t,e,s,i){return Object(Yt.a)(this,void 0,void 0,(function*(){const r=this.p.color.components[i],n=[this.pv.color.r,this.pv.color.g,this.pv.color.b][i],o=[this._r_arrays_by_geometry_uuid,this._g_arrays_by_geometry_uuid,this._b_arrays_by_geometry_uuid][i];let a;if(r.has_expression()&&r.expression_controller)a=this._init_array_if_required(t,o,s.length),yield r.expression_controller.compute_expression_for_points(s,(t,e)=>{a[t.index]=e});else for(let t of s)e[3*t.index+i]=n;return a}))}_init_array_if_required(t,e,s){const i=t.uuid,r=e[i];return r?r.length<s&&(e[i]=new Array(s)):e[i]=new Array(s),e[i]}_commit_tmp_values(t,e,s){for(let i=0;i<t.length;i++)e[3*i+s]=t[i]}}var gs=s(426);const vs=new Y.a(0,1,0);class ys extends Ft.a{constructor(){super(...arguments),this.radius=Ft.b.FLOAT(1,{range:[0,1]}),this.height=Ft.b.FLOAT(1,{range:[0,1]}),this.segments_radial=Ft.b.INTEGER(12,{range:[3,20],range_locked:[!0,!1]}),this.segments_height=Ft.b.INTEGER(1,{range:[1,20],range_locked:[!0,!1]}),this.cap=Ft.b.BOOLEAN(1),this.theta_start=Ft.b.FLOAT(1,{range:[0,1]}),this.theta_length=Ft.b.FLOAT("2*$PI",{range:[0,1]}),this.center=Ft.b.VECTOR3([0,0,0]),this.direction=Ft.b.VECTOR3([0,0,1])}}const xs=new ys;class Es extends Pt{constructor(){super(...arguments),this.params_config=xs,this._core_transform=new $e.a}static type(){return"cone"}cook(){const t=new gs.a(this.pv.radius,this.pv.height,this.pv.segments_radial,this.pv.segments_height,!this.pv.cap,this.pv.theta_start,this.pv.theta_length);this._core_transform.rotate_geometry(t,vs,this.pv.direction),t.translate(this.pv.center.x,this.pv.center.y,this.pv.center.z),this.set_geometry(t)}}var Ts=s(21),ws=s(29),Os=s(479),As=s(447);const Rs={SCALE:new Y.a(1,1,1),PSCALE:1,EYE:new Y.a(0,0,0),UP:new Y.a(0,1,0)},Ns=new Y.a(1,1,1),js=new X.a(0,0);class Is{constructor(t){this._group_wrapper=t,this._matrices={},this._is_pscale_present=this._group_wrapper.has_attrib("pscale"),this._is_scale_present=this._group_wrapper.has_attrib("scale"),this._is_normal_present=this._group_wrapper.has_attrib("normal"),this._is_up_present=this._group_wrapper.has_attrib("up"),this._do_rotate_matrices=this._is_normal_present}matrices(){return this._matrices={},this._matrices.translate=new ws.a,this._matrices.rotate=new ws.a,this._matrices.scale=new ws.a,this._group_wrapper.points().map(t=>this._matrix_from_point(t))}_matrix_from_point(t){const e=t.position();let s=this._is_scale_present?t.attrib_value("scale"):Rs.SCALE;const i=this._is_pscale_present?t.attrib_value("pscale"):Rs.PSCALE;s=s.clone().multiplyScalar(i);const r=new ws.a;r.identity();const n=this._matrices.scale;n.makeScale(s.x,s.y,s.z);const o=this._matrices.translate;if(o.makeTranslation(e.x,e.y,e.z),r.multiply(o),this._do_rotate_matrices){const e=this._matrices.rotate,s=Rs.EYE,i=t.attrib_value("normal").multiplyScalar(-1),n=this._is_up_present?t.attrib_value("up"):Rs.UP;n.normalize(),e.lookAt(s,i,n),r.multiply(e)}return r.multiply(n),r}static create_instance_buffer_geo(t,e,s){const i=e.points(),r=new Os.a;r.copy(t);const n=i.length,o=new Float32Array(3*n),a=new Float32Array(3*n),_=new Float32Array(3*n),c=new Float32Array(4*n),l=e.has_attrib("color"),u=new Y.a(0,0,0),h=new Ts.a,d=new Y.a(1,1,1),p=new Is(e).matrices();i.forEach((t,e)=>{const s=3*e,i=4*e;p[e].decompose(u,h,d),u.toArray(o,s),h.toArray(c,i),d.toArray(_,s),(l?t.attrib_value("color"):Ns).toArray(a,s)});const m=e.has_attrib("uv");if(m){const t=new Float32Array(2*n);i.forEach((e,s)=>{const i=2*s;(m?e.attrib_value("uv"):js).toArray(t,i)}),r.setAttribute("instanceUv",new As.a(t,2))}return r.setAttribute("instancePosition",new As.a(o,3)),r.setAttribute("instanceScale",new As.a(_,3)),r.setAttribute("instanceOrientation",new As.a(c,4)),r.setAttribute("instanceColor",new As.a(a,3)),e.attrib_names_matching_mask(s).forEach(t=>{const s=e.attrib_size(t),o=new Float32Array(n*s);i.forEach((e,i)=>{const r=e.attrib_value(t);at()(r)?o[i]=r:r.toArray(o,i*s)}),r.setAttribute(t,new As.a(o,s))}),new Tt(r).mark_as_instance(),r}}var Ss=s(13);class Ms extends Ss.a{constructor(t){super(t,"CopyStamp"),this._global_index=0}set_point(t){this._point=t,this.set_dirty(),this.remove_dirty_state()}set_global_index(t){this._global_index=t,this.set_dirty(),this.remove_dirty_state()}value(t){return this._point?t?this._point.attrib_value(t):this._point.index:this._global_index}}class ks extends Ft.a{constructor(){super(...arguments),this.count=Ft.b.INTEGER(1,{range:[1,20],range_locked:[!0,!1]}),this.transform_only=Ft.b.BOOLEAN(0),this.copy_attributes=Ft.b.BOOLEAN(0),this.attributes_to_copy=Ft.b.STRING("",{visible_if:{copy_attributes:!0}}),this.use_copy_expr=Ft.b.BOOLEAN(0)}}const zs=new ks;class Cs extends Pt{constructor(){super(...arguments),this.params_config=zs,this._attribute_names_to_copy=[],this._objects=[]}static type(){return"copy"}static displayed_input_names(){return["geometry to be copied","points to copy to"]}initialize_node(){this.io.inputs.set_count(1,2),this.io.inputs.init_inputs_clonable_state([Gt.a.ALWAYS,Gt.a.NEVER])}cook(){return Object(Yt.a)(this,void 0,void 0,(function*(){let t;const e=yield this.container_controller.request_input_container(0);if(null!=e&&null!=(t=e.core_content()))if(this.io.inputs.has_input(1)){let e;const s=yield this.container_controller.request_input_container(1);null!=s&&null!=(e=s.core_content())?yield this.cook_with_template(t,e):this.states.error.set("second input required")}else this.cook_without_template(t);else this.states.error.set("first input required")}))}cook_with_template(t,e){return Object(Yt.a)(this,void 0,void 0,(function*(){this._objects=[];const s=e.points();let i=new Is(e).matrices();this._attribute_names_to_copy=Ot.a.attrib_names(this.pv.attributes_to_copy).filter(t=>e.has_attrib(t)),yield this._copy_moved_objects_on_template_points(t,i,s),this.set_objects(this._objects)}))}_copy_moved_objects_on_template_points(t,e,s){return Object(Yt.a)(this,void 0,void 0,(function*(){for(let i=0;i<s.length;i++)yield this._copy_moved_object_on_template_point(t,e,s,i)}))}_copy_moved_object_on_template_point(t,e,s,i){return new Promise((r,n)=>Object(Yt.a)(this,void 0,void 0,(function*(){const n=e[i],o=s[i];return this.stamp_node.set_point(o),(yield this._get_moved_objects_for_template_point(t,i)).forEach(t=>{if(this.pv.copy_attributes&&this._copy_attributes_from_template(t,o),this.pv.transform_only)t.applyMatrix4(n);else{t.geometry?t.geometry.applyMatrix4(n):t.applyMatrix4(n)}return this._objects.push(t)}),r()})))}_get_moved_objects_for_template_point(t,e){return new Promise((s,i)=>Object(Yt.a)(this,void 0,void 0,(function*(){if(yield this._stamp_instance_group_if_required(t)){const i=this.pv.transform_only?P()([t.objects()[e]]):t.clone().objects();s(i)}else s([])})))}_stamp_instance_group_if_required(t){return new Promise((e,s)=>Object(Yt.a)(this,void 0,void 0,(function*(){if(this.pv.use_copy_expr){const t=yield this.container_controller.request_input_container(0);let s;t&&null!=(s=t.core_content())?e(s):(this.states.error.set(`input failed for index ${this.stamp_value()}`),e())}else e(t)})))}_copy_moved_objects_for_each_instance(t){return Object(Yt.a)(this,void 0,void 0,(function*(){for(let e=0;e<this.pv.count;e++)yield this._copy_moved_objects_for_instance(t,e)}))}_copy_moved_objects_for_instance(t,e){return new Promise((s,i)=>Object(Yt.a)(this,void 0,void 0,(function*(){this.stamp_node.set_global_index(e);const i=yield this._stamp_instance_group_if_required(t);i&&i.objects().forEach(t=>{const e=Nt.clone(t);this._objects.push(e)}),s()})))}cook_without_template(t){this._objects=[],this._copy_moved_objects_for_each_instance(t).then(()=>{this.set_objects(this._objects)})}_copy_attributes_from_template(t,e){this._attribute_names_to_copy.forEach((s,i)=>{const r=e.attrib_value(s);new Nt(t,i).add_attribute(s,r)})}stamp_value(t){return this.stamp_node.value(t)}get stamp_node(){return this._stamp_node=this._stamp_node||this.create_stamp_node()}create_stamp_node(){const t=new Ms(this.scene);return this.dirty_controller.set_forbidden_trigger_nodes([t]),t}}var Ls=s(17),Ps=s.n(Ls);class Fs{constructor(t,e){this._size=t,this._type=e}size(){return this._size}type(){return this._type}static from_value(t){const e=Rt()(t)?k.ATTRIB_TYPE.STRING:k.ATTRIB_TYPE.NUMERIC;return new this(nt()(t)?t.length:1,e)}}const Ds={BufferGeometry:a.a,Float32BufferAttribute:_.b,Points:p.a};class Bs{constructor(t={}){this._attribute_datas_by_name={},this._options={},this._options.data_keys_prefix=t.data_keys_prefix,this._options.skip_entries=t.skip_entries,this._options.do_convert=t.do_convert||!1,this._options.convert_to_numeric=t.convert_to_numeric}load(t,e,s,i){fetch(t).then(t=>Object(Yt.a)(this,void 0,void 0,(function*(){this._json=yield t.json(),null!=this._options.data_keys_prefix&&""!=this._options.data_keys_prefix&&(this._json=this.get_prefixed_json(this._json,this._options.data_keys_prefix.split(".")));const s=this.create_object();e(s)}))).catch(t=>{console.log("error",t),i(t)})}get_prefixed_json(t,e){if(0==e.length)return t;{const s=e.shift();if(s)return this.get_prefixed_json(t[s],e)}return[]}set_json(t){return this._json=t}create_object(){const t=new Ds.BufferGeometry,e=new Tt(t);if(null!=this._json){const s=this._json.length;e.init_position_attribute(s),this._find_attributes();const i=Ot.a.attrib_names(this._options.convert_to_numeric||"");for(let s of Object.keys(this._attribute_datas_by_name)){let r=U()(this._attribute_values_for_name(s));const n=this._attribute_datas_by_name[s],o=n.size();if(n.type()===k.ATTRIB_TYPE.STRING)if(this._options.do_convert&&Ot.a.matches_one_mask(s,i)){const e=r.map(t=>Rt()(t)?parseFloat(t)||0:t);t.setAttribute(s,new Ds.Float32BufferAttribute(e,o))}else{const t=ct.a.array_to_indexed_arrays(r);e.set_indexed_attribute(s,t.values,t.indices)}else{const e=r;t.setAttribute(s,new Ds.Float32BufferAttribute(e,o))}}}return new Ds.Points(t,k.MATERIALS[Ds.Points.name])}_find_attributes(){let t;const e=Ot.a.attrib_names(this._options.skip_entries||"");if(this._json&&null!=(t=this._json[0]))for(let s of Object.keys(t)){const i=t[s];if(this._value_has_subentries(i))for(let t of Object.keys(i)){const r=[s,t].join(":"),n=i[s];Ot.a.matches_one_mask(r,e)||(this._attribute_datas_by_name[r]=Fs.from_value(n))}else Ot.a.matches_one_mask(s,e)||(this._attribute_datas_by_name[s]=Fs.from_value(i))}}_attribute_values_for_name(t){return this._json?this._json.map(e=>{const s=t.split(":")[0],i=e[s];if(this._value_has_subentries(i)){return i[t.substring(s.length+1)]||0}return i||0}):[]}_value_has_subentries(t){return Ps()(t)&&!nt()(t)}}const Vs=JSON.stringify([{value:-40},{value:-30},{value:-20},{value:-10},{value:0},{value:10},{value:20},{value:30},{value:40},{value:50},{value:60},{value:70},{value:80}]);class Gs extends Ft.a{constructor(){super(...arguments),this.data=Ft.b.STRING(Vs)}}const Us=new Gs;class $s extends Pt{constructor(){super(...arguments),this.params_config=Us}static type(){return"data"}cook(){let t=null;try{t=JSON.parse(this.pv.data)}catch(t){this.states.error.set("could not parse json")}if(t){const e=new Bs;e.set_json(t);const s=e.create_object();this.set_object(s)}else this.cook_controller.end_cook()}}class qs extends Ft.a{constructor(){super(...arguments),this.url=Ft.b.STRING("/examples/sop/data_url/basic.json"),this.json_data_keys_prefix=Ft.b.STRING(""),this.skip_entries=Ft.b.STRING(""),this.convert=Ft.b.BOOLEAN(0),this.convert_to_numeric=Ft.b.STRING("",{visible_if:{convert:1}}),this.reload=Ft.b.BUTTON(null,{callback:(t,e)=>{Hs.PARAM_CALLBACK_reload(t,e)}})}}const Ys=new qs;class Hs extends Pt{constructor(){super(...arguments),this.params_config=Ys}static type(){return"data_url"}cook(){return Object(Yt.a)(this,void 0,void 0,(function*(){new Bs({data_keys_prefix:this.pv.json_data_keys_prefix,skip_entries:this.pv.skip_entries,do_convert:this.pv.convert,convert_to_numeric:this.pv.convert_to_numeric}).load(this.pv.url,this._on_load.bind(this),void 0,this._on_error.bind(this))}))}_on_load(t){this.set_objects([t])}_on_error(t){this.states.error.set(`could not load geometry from ${this.pv.url} (${t})`),this.cook_controller.end_cook()}static PARAM_CALLBACK_reload(t,e){t.param_callback_reload()}param_callback_reload(){this.p.url.set_dirty()}}class Xs extends Ft.a{constructor(){super(...arguments),this.duration=Ft.b.INTEGER(1e3)}}const Js=new Xs;class Ks extends Pt{constructor(){super(...arguments),this.params_config=Js}static type(){return"delay"}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.ALWAYS])}cook(t){const e=t[0];setTimeout(()=>{this.set_core_group(e)},this.pv.duration)}}var Ws;!function(t){t[t["=="]=0]="==",t[t["<"]=1]="<",t[t["<="]=2]="<=",t[t[">="]=3]=">=",t[t[">"]=4]=">",t[t["!="]=5]="!="}(Ws||(Ws={}));const Zs=[{name:"==",value:Ws["=="]},{name:"<",value:Ws["<"]},{name:"<=",value:Ws["<="]},{name:">=",value:Ws[">="]},{name:">",value:Ws[">"]},{name:"!=",value:Ws["!="]}];class Qs extends Ft.a{constructor(){super(...arguments),this.class=Ft.b.INTEGER(j.VERTEX,{menu:{entries:I}}),this.invert=Ft.b.BOOLEAN(0),this.hide_objects=Ft.b.BOOLEAN(0),this.by_object_type=Ft.b.BOOLEAN(0),this.object_type=Ft.b.INTEGER(A.indexOf(i.MESH),{menu:{entries:R},visible_if:{by_object_type:!0}}),this.by_expression=Ft.b.BOOLEAN(0),this.expression=Ft.b.BOOLEAN("@ptnum==0",{visible_if:{by_expression:!0},expression:{for_entities:!0}}),this.by_attrib=Ft.b.BOOLEAN(0),this.attrib_name=Ft.b.STRING("",{visible_if:{by_attrib:!0}}),this.attrib_string=Ft.b.STRING("",{visible_if:{by_attrib:!0}}),this.attrib_numeric=Ft.b.VECTOR4([0,0,0,0],{visible_if:{by_attrib:!0}}),this.attrib_comparison_operator=Ft.b.INTEGER(Ws["=="],{menu:{entries:Zs},visible_if:{by_attrib:!0}}),this.by_bbox=Ft.b.BOOLEAN(0),this.bbox_size=Ft.b.VECTOR3([1,1,1],{visible_if:{by_bbox:!0}}),this.bbox_center=Ft.b.VECTOR3([0,0,0],{visible_if:{by_bbox:!0}}),this.by_visible=Ft.b.BOOLEAN(0),this.keep_points=Ft.b.BOOLEAN(1,{visible_if:{class:j.OBJECT}})}}const ti=new Qs;class ei extends Pt{constructor(){super(...arguments),this.params_config=ti,this._marked_for_deletion_per_object_index=new Map}static type(){return"delete"}static displayed_input_names(){return["geometry to delete from"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t[0];switch(this._bbox_cache=void 0,this.pv.class){case j.VERTEX:yield this._eval_for_points(e);break;case j.OBJECT:yield this._eval_for_objects(e)}}))}_eval_for_objects(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=[],s=t.core_objects();this._marked_for_deletion_per_object_index=new Map;for(let t of s)this._marked_for_deletion_per_object_index.set(t.index,!1);let i,r;this.pv.by_expression&&(yield this._eval_expressions_for_objects(s)),this.pv.by_object_type&&this._eval_type_for_objects(s),this.pv.by_attrib&&""!==this.pv.attrib_name&&this._eval_attrib_for_objects(s),this.pv.invert&&this._marked_for_deletion_per_object_index.forEach((t,e)=>{this._marked_for_deletion_per_object_index.set(e,!t)});const n=[];this._marked_for_deletion_per_object_index.forEach((t,o)=>{i=s[o],r=i.object(),this.pv.hide_objects?(e.push(r),t&&(r.visible=!1)):(t||e.push(r),t&&n.push(this._point_object(i)))});for(let t of n)e.push(t);this.set_objects(e)}))}_eval_for_points(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t.core_objects();let s;for(let t=0;t<e.length;t++){s=e[t];let i=s.core_geometry();if(i){let t=i.points_from_geometry();const e=t.length;if(this.pv.by_expression&&(t=yield this._eval_expressions_for_points(t)),this.pv.by_attrib&&""!==this.pv.attrib_name&&(t=this._eval_attrib_for_points(t)),this.pv.by_bbox&&(t=this._eval_bbox_for_points(t)),t.length!=e){const e=s.object();i.geometry().dispose(),t.length>0?e.geometry=Tt.geometry_from_points(t,e.constructor):null!=e.parent&&e.parent.remove(e)}}}this.set_core_group(t)}))}_eval_expressions_for_points(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=[],s=this.p.expression;if(this.p.expression.has_expression()&&s.expression_controller)yield s.expression_controller.compute_expression_for_points(t,(t,s)=>{let i=!s;this.pv.invert&&(i=!i),i&&e.push(t)});else{let s=!this.pv.expression;this.pv.invert&&(s=!s);for(let i=0;i<t.length;i++)s&&e.push(t[i])}return console.log(e),e}))}_eval_expressions_for_objects(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=this.p.expression;if(e.has_expression()&&e.expression_controller)yield e.expression_controller.compute_expression_for_objects(t,(t,e)=>{this._marked_for_deletion_per_object_index.get(t.index)||this._marked_for_deletion_per_object_index.set(t.index,e)});else for(let s of t)this._marked_for_deletion_per_object_index.set(s.index,e.value)}))}_eval_attrib_for_points(t){const e=[];if(t.length>0){const s=t[0].attrib_value(this.pv.attrib_name);(Rt()(s)?Ot.a.attrib_names(this.pv.attrib_string):[this.pv.attrib_numeric.x]).forEach(s=>t.forEach(t=>{const i=t.attrib_value(this.pv.attrib_name);let r=!this._comparison(i,s);if(this.pv.invert&&(r=!r),r)return e.push(t)}))}return e}_comparison(t,e){switch(this.pv.attrib_ComparisonOperator){case Ws["=="]:return t===e;case Ws["<="]:return t<=e;case Ws["<"]:return t<e;case Ws[">"]:return t>e;case Ws[">="]:return t>=e;case Ws["!="]:return t!==e}}_eval_type_for_objects(t){const e=A[this.pv.object_type];for(let s of t){if(!this._marked_for_deletion_per_object_index.get(s.index)){s.object().constructor.name===e&&this._marked_for_deletion_per_object_index.set(s.index,!0)}}}_eval_attrib_for_objects(t){for(let e of t){if(!this._marked_for_deletion_per_object_index.get(e.index)){const t=e.attrib_value(this.pv.attrib_name);t===(Rt()(t)?this.pv.attrib_string:this.pv.attrib_float)&&this._marked_for_deletion_per_object_index.set(e.index,!0)}}}_eval_bbox_for_points(t){const e=[];return W()(t,(t,s)=>{const i=this._bbox.containsPoint(t.position());if(this.pv.invert?i:!i)return e.push(t)}),e}get _bbox(){return null!=this._bbox_cache?this._bbox_cache:this._bbox_cache=new H.a(this.pv.bbox_center.clone().sub(this.pv.bbox_size.clone().multiplyScalar(.5)),this.pv.bbox_center.clone().add(this.pv.bbox_size.clone().multiplyScalar(.5)))}_point_object(t){const e=t.points(),s=Tt.geometry_from_points(e,t.object().constructor);return this.create_object(s,i.POINTS)}}class si extends Ft.a{constructor(){super(...arguments),this.make_faces_unique=Ft.b.BOOLEAN(0),this.add_face_center_attribute=Ft.b.BOOLEAN(0,{visible_if:{make_faces_unique:1}}),this.add_face_id=Ft.b.BOOLEAN(0,{visible_if:{make_faces_unique:1}}),this.transform=Ft.b.BOOLEAN(0,{visible_if:{make_faces_unique:1}}),this.scale=Ft.b.FLOAT(1,{visible_if:{make_faces_unique:1,transform:1}})}}const ii=new si;class ri extends Pt{constructor(){super(...arguments),this.params_config=ii}static type(){return"face"}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){const e=t[0];this.pv.make_faces_unique&&(this._make_faces_unique(e),this.pv.add_face_center_attribute&&this._add_face_center_attribute(e),this.pv.add_face_id&&this._add_face_id(e),this.pv.transform&&this._transform_faces(e)),this.set_core_group(e)}_make_faces_unique(t){var e;for(let s of t.objects())if(s.isMesh){const t=s.geometry,i=Q()((null===(e=t.index)||void 0===e?void 0:e.array)||[],3),r=3*i.length;for(let e of Object.keys(t.attributes)){const s=t.attributes[e],n=s.itemSize,a=new Float32Array(r*n);let c=0;i.forEach(t=>{t.forEach(t=>{o()(n,e=>{const i=s.array[t*n+e];a[c]=i,c+=1})})}),t.setAttribute(e,new _.a(a,n))}const n=l()(r);t.setIndex(n)}}_add_face_center_attribute(t){const e=new Y.a;let s,i,r,n;t.core_objects().forEach(t=>{const o=t.object(),a=t.core_geometry();if(o.isMesh&&a){s=a.faces(),a.has_attrib("face_center")||a.add_numeric_attrib("face_center",3,-1);for(let t=0;t<s.length;t++){i=s[t],i.center(e),r=i.points;for(let t=0;t<r.length;t++)n=r[t],n.set_attrib_value("face_center",e)}}})}_add_face_id(t){t.core_objects().forEach(t=>{const e=t.object(),s=t.core_geometry();if(e.isMesh&&s){const t=s.faces();s.has_attrib("face_id")||s.add_numeric_attrib("face_id",1,-1);for(let e=0;e<t.length;e++){const s=t[e].points;for(let t=0;t<s.length;t++){s[t].set_attrib_value("face_id",e)}}}})}_transform_faces(t){const e=new Y.a,s=new Y.a,i=this.pv.scale;let r,n,o,a;t.core_objects().forEach(t=>{const _=t.object(),c=t.core_geometry();if(_.isMesh&&c){r=c.faces(),c.has_attrib("position")||c.add_numeric_attrib("position",3,-1);for(let t=0;t<r.length;t++){n=r[t],n.center(e),o=n.points;for(let t=0;t<o.length;t++){a=o[t];const r=a.position();s.x=r.x*i+e.x*(1-i),s.y=r.y*i+e.y*(1-i),s.z=r.z*i+e.z*(1-i),a.set_attrib_value("position",s)}}}})}}class ni{constructor(t){this.url=t;const e=this.url.split(".");this.ext=e[e.length-1].toLowerCase(),"zip"===this.ext&&(this.ext=e[e.length-2])}load(t,e){this.load_auto().then(e=>{t(e)}).catch(t=>{e(t)})}load_auto(){return new Promise((t,e)=>Object(Yt.a)(this,void 0,void 0,(function*(){const s=this.url;if("json"==this.ext)fetch(s).then(e=>Object(Yt.a)(this,void 0,void 0,(function*(){const s=yield e.json();(new Je.a).parse(s,e=>{t(this.on_load_success(e.children[0]))})}))).catch(t=>{e(t)});else{const i=yield this.loader_for_ext();if(i)i.load(s,e=>{console.log(e),this.on_load_success(e).then(e=>{t(e)})},void 0,t=>{e(t)});else{const t=`format not supported (${this.ext})`;e(t)}}})))}on_load_success(t){return Object(Yt.a)(this,void 0,void 0,(function*(){if(t instanceof m.a)switch(this.ext){case"gltf":case"glb":return this.on_load_succes_gltf(t);case"obj":case"json":default:return[t]}if(t instanceof a.a)switch(this.ext){case"drc":return this.on_load_succes_drc(t);default:return[new f.a(t)]}switch(this.ext){case"gltf":case"glb":return this.on_load_succes_gltf(t);default:return[]}return[]}))}on_load_succes_gltf(t){const e=t.scene;return e.animations=t.animations,console.log("[scene]",[e]),[e]}on_load_succes_drc(t){const e=new w.a;return[new f.a(t,e)]}loader_for_ext(){return Object(Yt.a)(this,void 0,void 0,(function*(){switch(this.ext.toLowerCase()){case"gltf":return this.loader_for_gltf();case"glb":return this.loader_for_glb();case"drc":return this.loader_for_drc();case"obj":return this.loader_for_obj()}}))}loader_for_gltf(){return Object(Yt.a)(this,void 0,void 0,(function*(){const{GLTFLoader:t}=yield s.e(1).then(s.bind(null,623));return new t}))}loader_for_glb(){return Object(Yt.a)(this,void 0,void 0,(function*(){const{GLTFLoader:t}=yield s.e(1).then(s.bind(null,623)),{DRACOLoader:e}=yield s.e(0).then(s.bind(null,611)),i=new t,r=new e;return r.setDecoderPath("/three/js/libs/draco/gltf/"),r.setDecoderConfig({type:"js"}),i.setDRACOLoader(r),i}))}loader_for_drc(){return Object(Yt.a)(this,void 0,void 0,(function*(){const{DRACOLoader:t}=yield s.e(0).then(s.bind(null,611)),e=new t;return e.setDecoderPath("/three/js/libs/draco/"),e.setDecoderConfig({type:"js"}),e}))}loader_for_obj(){return Object(Yt.a)(this,void 0,void 0,(function*(){const{OBJLoader:t}=yield s.e(5).then(s.bind(null,612));return new t}))}}class oi extends Ft.a{constructor(){super(...arguments),this.url=Ft.b.STRING("",{desktop_browse:{file_type:"geometry"},always_reference_asset:!0}),this.reload=Ft.b.BUTTON(null,{callback:(t,e)=>{_i.PARAM_CALLBACK_reload(t)}})}}const ai=new oi;class _i extends Pt{constructor(){super(...arguments),this.params_config=ai}static type(){return"file"}initialize_node(){}cook(){new ni(this.pv.url).load(this._on_load.bind(this),this._on_error.bind(this))}_on_load(t){console.log("objects",t),t=U()(t),this.set_objects(t)}_on_error(t){this.states.error.set(`could not load geometry from ${this.pv.url} (${t})`)}static PARAM_CALLBACK_reload(t){t.param_callback_reload()}param_callback_reload(){this.p.url.set_dirty()}}class ci extends Ft.a{constructor(){super(...arguments),this.dist=Ft.b.FLOAT(.1,{range:[0,1],range_locked:[!0,!1]})}}const li=new ci;class ui extends Pt{constructor(){super(...arguments),this.params_config=li}static type(){return"fuse"}static displayed_input_names(){return["points to fuse together"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){const e=t[0],s=[];let i;for(let t of e.core_objects())i=this._fuse_core_object(t),i&&s.push(i);this.set_objects(s)}_fuse_core_object(t){const e=t.object();if(!e)return;const s=t.points(),i=this.pv.dist,r={};for(let t of s){const e=t.position(),s=new Y.a(Math.round(e.x/i),Math.round(e.y/i),Math.round(e.z/i)).toArray().join("-");r[s]=r[s]||[],r[s].push(t)}const n=[];return Object.keys(r).forEach(t=>{n.push(r[t][0])}),e.geometry.dispose(),n.length>0?(e.geometry=Tt.geometry_from_points(n,e.constructor),e):void 0}}const hi={BufferAttribute:_.a,BufferGeometry:a.a,Vector2:X.a};class di{constructor(t,e,s){this._param_size=t,this._param_hexagon_radius=e,this._param_points_only=s}process(){const t=this._param_hexagon_radius,e=.5*t,s=t,i=Math.cos(Math.PI/6)*this._param_hexagon_radius,r=Math.floor(this._param_size.x/s),n=Math.floor(this._param_size.y/i);let o=[],a=[];for(let t=0;t<n;t++)for(let n=0;n<r;n++)o.push([-.5*this._param_size.x+n*s+(t%2==0?e:0),0,-.5*this._param_size.y+t*i]),this._param_points_only||t>=1&&(0==n||n==r-1?0==n?a.push([n+1+(t-1)*r,n+(t-1)*r,n+t*r]):a.push([n+t*r,n+(t-1)*r,n-1+t*r]):(a.push([n+t*r,n+(t-1)*r,n-1+t*r]),a.push([n+t*r,n+1+(t-1)*r,n+(t-1)*r])));o=U()(o);const _=new hi.BufferGeometry;return _.setAttribute("position",new hi.BufferAttribute(new Float32Array(o),3)),this._param_points_only||(a=U()(a),_.setIndex(a),_.computeVertexNormals()),_}}const pi=new Y.a(0,1,0);class mi extends Ft.a{constructor(){super(...arguments),this.size=Ft.b.VECTOR2([1,1]),this.hexagon_radius=Ft.b.FLOAT(.1),this.direction=Ft.b.VECTOR3([0,1,0]),this.points_only=Ft.b.BOOLEAN(0)}}const fi=new mi;class bi extends Pt{constructor(){super(...arguments),this.params_config=fi,this._core_transform=new $e.a}static type(){return"hexagons"}initialize_node(){}cook(){const t=new di(this.pv.size,this.pv.hexagon_radius,this.pv.points_only).process();this._core_transform.rotate_geometry(t,pi,this.pv.direction),this.pv.points_only?this.set_geometry(t,k.OBJECT_TYPE.POINTS):this.set_geometry(t)}}const gi={Group:g.a,Object3D:m.a};var vi;!function(t){t.ADD_PARENT="add_parent",t.REMOVE_PARENT="remove_parent"}(vi||(vi={}));const yi=[vi.ADD_PARENT,vi.REMOVE_PARENT];class xi extends Ft.a{constructor(){super(...arguments),this.mode=Ft.b.INTEGER(0,{menu:{entries:yi.map((t,e)=>({name:t,value:e}))}}),this.levels=Ft.b.INTEGER(1,{range:[0,5]})}}const Ei=new xi;class Ti extends Pt{constructor(){super(...arguments),this.params_config=Ei}static type(){return"hierarchy"}static displayed_input_names(){return["geometry to add or remove parents to/from"]}initialize_node(){this.io.inputs.set_count(1)}cook(t){const e=t[0];if(yi[this.pv.mode]==vi.ADD_PARENT){const t=this._add_parent_to_core_group(e);this.set_objects(t)}else{const t=this._remove_parent_from_core_group(e);this.set_objects(t)}}_add_parent_to_core_group(t){if(0==this.pv.levels)return t.objects();{const e=[];let s;for(let i of t.objects())s=this._add_parent_to_object(i),s&&e.push(s);return e}}_add_parent_to_object(t){let e=new gi.Group;if(e.add(t),this.pv.levels>0)for(let t=0;t<this.pv.levels-1;t++)e=this._add_new_parent(e);return e}_add_new_parent(t){const e=new gi.Group;return e.add(t),e}_remove_parent_from_core_group(t){if(0==this.pv.levels)return t.objects();{const e=[];for(let s of t.objects()){const t=this._remove_parent_from_object(s);for(let s of t)e.push(s)}return e}}_remove_parent_from_object(t){let e=t.children;for(let t=0;t<this.pv.levels-1;t++)e=this._get_children_from_objects(e);return e}_get_children_from_objects(t){let e;const s=[];for(;e=t.pop();)if(e.children)for(let t of e.children)s.push(t);return s}}var wi=s(345);class Oi extends Ft.a{constructor(){super(...arguments),this.attributes_to_copy=Ft.b.STRING("instance*"),this.apply_material=Ft.b.BOOLEAN(1),this.material=Ft.b.OPERATOR_PATH("",{visible_if:{apply_material:1},node_selection:{context:zt.a.MAT},dependent_on_found_node:!1})}}const Ai=new Oi;class Ri extends Pt{constructor(){super(...arguments),this.params_config=Ai,this._on_create_bound=this._on_create.bind(this)}static type(){return"instance"}static displayed_input_names(){return["geometry to be instanciated","points to instance to"]}initialize_node(){super.initialize_node(),this.lifecycle.add_on_create_hook(this._on_create_bound),this.io.inputs.set_count(2),this.io.inputs.init_inputs_clonable_state([Gt.a.ALWAYS,Gt.a.NEVER])}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t[0];this._geometry=void 0;const s=e.objects()[0];if(s){const e=s.geometry;if(e){const s=t[1];this._create_instance(e,s)}}if(this._geometry){const t=(r=s)instanceof f.a?i.MESH:r instanceof b.a?i.LINE_SEGMENTS:r instanceof p.a?i.POINTS:void console.warn("ObjectTypeByObject received an unknown object type",r);if(t){const e=this.create_object(this._geometry,t);this.pv.apply_material&&(yield this._apply_material(e)),this.set_object(e)}else this.cook_controller.end_cook()}else this.cook_controller.end_cook();var r}))}_apply_material(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=this.p.material.found_node();if(e)if(e.node_context()==zt.a.MAT){const s=e;this._globals_handler=this._globals_handler||new wi.a;const i=s;i.assembler_controller&&i.assembler_controller.set_assembler_globals_handler(this._globals_handler);const r=(yield s.request_container()).material();r&&(t.material=r,wt.apply_custom_materials(t,r))}else this.states.error.set("found node is not a material");else this.states.error.set("material node invalid")}))}_create_instance(t,e){this._geometry=Is.create_instance_buffer_geo(t,e,this.pv.attributes_to_copy)}_on_create(){const t=this.scene.root;let e;const s=t.node("MAT");s&&"materials"==s.type?e=s:(e=t.create_node("materials"),e.set_name("MAT"));const i=e.node("mesh_lambert_builder1")||((t,e)=>{const s=t.create_node("mesh_lambert_builder");s.set_name(e);const i=s.create_node("instance_transform");let r=s.node("output1");return r||(r=s.create_node("output")),r.set_input("position",i,"position"),r.set_input("normal",i,"normal"),s})(e,"mesh_lambert_builder1");this.p.material.set(i.full_path())}}const Ni={Vector3:Y.a};class ji extends Ft.a{constructor(){super(...arguments),this.amount=Ft.b.FLOAT(1),this.seed=Ft.b.INTEGER(1,{range:[0,100]})}}const Ii=new ji;class Si extends Pt{constructor(){super(...arguments),this.params_config=Ii}static type(){return"jitter"}static displayed_input_names(){return["geometry to jitter points of"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){const e=t[0];e.points().forEach((t,e)=>{const s=new Ni.Vector3(2*(bt.a.rand(75*e+764+this.pv.seed)-.5),2*(bt.a.rand(5678*e+3653+this.pv.seed)-.5),2*(bt.a.rand(657*e+48464+this.pv.seed)-.5));s.normalize(),s.multiplyScalar(this.pv.amount);const i=t.position().clone().add(s);t.set_position(i)}),this.set_core_group(e)}}class Mi extends Ft.a{constructor(){super(...arguments),this.layer=Ft.b.INTEGER(0,{range:[0,31],range_locked:[!0,!0]})}}const ki=new Mi;class zi extends Pt{constructor(){super(...arguments),this.params_config=ki}static type(){return"layer"}static displayed_input_names(){return["objects to change layers of"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){const e=t[0];for(let t of e.objects())t.layers.set(this.pv.layer);this.set_core_group(e)}}class Ci extends Ft.a{constructor(){super(...arguments),this.length=Ft.b.FLOAT(1,{range:[0,10]}),this.points_count=Ft.b.INTEGER(1,{range:[2,100],range_locked:[!0,!1]}),this.origin=Ft.b.VECTOR3([0,0,0]),this.direction=Ft.b.VECTOR3([0,1,0])}}const Li=new Ci;class Pi extends Pt{constructor(){super(...arguments),this.params_config=Li}static type(){return"line"}initialize_node(){}cook(){const t=Math.max(2,this.pv.points_count),e=new Array(3*t),s=new Array(t),i=this.pv.direction.clone().normalize().multiplyScalar(this.pv.length);o()(t,r=>{const n=r/(t-1),o=i.clone().multiplyScalar(n);o.add(this.pv.origin),o.toArray(e,3*r),r>0&&(s[2*(r-1)]=r-1,s[2*(r-1)+1]=r)});const r=new a.a;r.setAttribute("position",new _.b(e,3)),r.setIndex(s),this.set_geometry(r,k.OBJECT_TYPE.LINE_SEGMENTS)}}var Fi=s(336);class Di extends Ft.a{constructor(){super(...arguments),this.group=Ft.b.STRING(""),this.material=Ft.b.OPERATOR_PATH("/MAT/mesh_standard1",{node_selection:{context:zt.a.MAT},dependent_on_found_node:!1}),this.apply_to_children=Ft.b.BOOLEAN(1)}}const Bi=new Di;class Vi extends Pt{constructor(){super(...arguments),this.params_config=Bi,this._globals_handler=new wi.a}static type(){return"material"}static displayed_input_names(){return["objects to assign material to"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t[0],s=this.p.material.found_node();if(s)if(s.node_context()!=zt.a.MAT)this.states.error.set("node is not a material");else{const t=s,i=t.material;if(i instanceof Fi.a){s.assembler_controller.set_assembler_globals_handler(this._globals_handler)}if(yield t.request_container(),i){for(let t of e.objects_from_group(this.pv.group))this.pv.apply_to_children?t.traverse(t=>{this.apply_material(t,i)}):this.apply_material(t,i);this.set_core_group(e)}else this.states.error.set(`material invalid. (error: '${t.states.error.message}')`)}else this.states.error.set(`node '${this.pv.material}' not found`)}))}apply_material(t,e){t.material=e,wt.apply_custom_materials(t,e)}}const Gi="geometry to merge";class Ui extends Ft.a{constructor(){super(...arguments),this.compact=Ft.b.BOOLEAN(1)}}const $i=new Ui;class qi extends Pt{constructor(){super(...arguments),this.params_config=$i}static type(){return"merge"}static displayed_input_names(){return[Gi,Gi,Gi,Gi]}initialize_node(){this.io.inputs.set_count(1,4),this.ui_data.set_width(100)}cook(t){let e=[];for(let s of t)if(s){const t=s.objects();for(let s of t)s.traverse(t=>{e.push(t)})}this.pv.compact&&(e=this._make_compact(e)),this.set_objects(e)}_make_compact(t){const e={[i.MESH]:[],[i.POINTS]:[],[i.LINE_SEGMENTS]:[]},s=[];for(let s of t)s.traverse(t=>{const s=t;s.geometry&&(s.isMesh?e[i.MESH].push(s):s.isLineSegments?e[i.LINE_SEGMENTS].push(s):s.isPoints&&e[i.POINTS].push(s))});for(let t of Object.keys(e)){const i=e[t],r=[];for(let t of i){const e=t.geometry;e.applyMatrix4(t.matrix),r.push(e)}const n=Tt.merge_geometries(r);if(n){const e=this.create_object(n,t);s.push(e)}}return s}}var Yi,Hi=s(130),Xi=function(t){null==t&&(t=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var e=0;e<256;e++)this.p[e]=Math.floor(256*t.random());this.perm=[];for(e=0;e<512;e++)this.perm[e]=this.p[255&e];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]};Xi.prototype.dot=function(t,e,s){return t[0]*e+t[1]*s},Xi.prototype.dot3=function(t,e,s,i){return t[0]*e+t[1]*s+t[2]*i},Xi.prototype.dot4=function(t,e,s,i,r){return t[0]*e+t[1]*s+t[2]*i+t[3]*r},Xi.prototype.noise=function(t,e){var s,i,r=(t+e)*(.5*(Math.sqrt(3)-1)),n=Math.floor(t+r),o=Math.floor(e+r),a=(3-Math.sqrt(3))/6,_=(n+o)*a,c=t-(n-_),l=e-(o-_);c>l?(s=1,i=0):(s=0,i=1);var u=c-s+a,h=l-i+a,d=c-1+2*a,p=l-1+2*a,m=255&n,f=255&o,b=this.perm[m+this.perm[f]]%12,g=this.perm[m+s+this.perm[f+i]]%12,v=this.perm[m+1+this.perm[f+1]]%12,y=.5-c*c-l*l,x=.5-u*u-h*h,E=.5-d*d-p*p;return 70*((y<0?0:(y*=y)*y*this.dot(this.grad3[b],c,l))+(x<0?0:(x*=x)*x*this.dot(this.grad3[g],u,h))+(E<0?0:(E*=E)*E*this.dot(this.grad3[v],d,p)))},Xi.prototype.noise3d=function(t,e,s){var i,r,n,o,a,_,c=(t+e+s)*(1/3),l=Math.floor(t+c),u=Math.floor(e+c),h=Math.floor(s+c),d=1/6,p=(l+u+h)*d,m=t-(l-p),f=e-(u-p),b=s-(h-p);m>=f?f>=b?(i=1,r=0,n=0,o=1,a=1,_=0):m>=b?(i=1,r=0,n=0,o=1,a=0,_=1):(i=0,r=0,n=1,o=1,a=0,_=1):f<b?(i=0,r=0,n=1,o=0,a=1,_=1):m<b?(i=0,r=1,n=0,o=0,a=1,_=1):(i=0,r=1,n=0,o=1,a=1,_=0);var g=m-i+d,v=f-r+d,y=b-n+d,x=m-o+2*d,E=f-a+2*d,T=b-_+2*d,w=m-1+.5,O=f-1+.5,A=b-1+.5,R=255&l,N=255&u,j=255&h,I=this.perm[R+this.perm[N+this.perm[j]]]%12,S=this.perm[R+i+this.perm[N+r+this.perm[j+n]]]%12,M=this.perm[R+o+this.perm[N+a+this.perm[j+_]]]%12,k=this.perm[R+1+this.perm[N+1+this.perm[j+1]]]%12,z=.6-m*m-f*f-b*b,C=.6-g*g-v*v-y*y,L=.6-x*x-E*E-T*T,P=.6-w*w-O*O-A*A;return 32*((z<0?0:(z*=z)*z*this.dot3(this.grad3[I],m,f,b))+(C<0?0:(C*=C)*C*this.dot3(this.grad3[S],g,v,y))+(L<0?0:(L*=L)*L*this.dot3(this.grad3[M],x,E,T))+(P<0?0:(P*=P)*P*this.dot3(this.grad3[k],w,O,A)))},Xi.prototype.noise4d=function(t,e,s,i){var r,n,o,a,_,c,l,u,h,d,p,m,f=this.grad4,b=this.simplex,g=this.perm,v=(Math.sqrt(5)-1)/4,y=(5-Math.sqrt(5))/20,x=(t+e+s+i)*v,E=Math.floor(t+x),T=Math.floor(e+x),w=Math.floor(s+x),O=Math.floor(i+x),A=(E+T+w+O)*y,R=t-(E-A),N=e-(T-A),j=s-(w-A),I=i-(O-A),S=(R>N?32:0)+(R>j?16:0)+(N>j?8:0)+(R>I?4:0)+(N>I?2:0)+(j>I?1:0),M=R-(r=b[S][0]>=3?1:0)+y,k=N-(n=b[S][1]>=3?1:0)+y,z=j-(o=b[S][2]>=3?1:0)+y,C=I-(a=b[S][3]>=3?1:0)+y,L=R-(_=b[S][0]>=2?1:0)+2*y,P=N-(c=b[S][1]>=2?1:0)+2*y,F=j-(l=b[S][2]>=2?1:0)+2*y,D=I-(u=b[S][3]>=2?1:0)+2*y,B=R-(h=b[S][0]>=1?1:0)+3*y,V=N-(d=b[S][1]>=1?1:0)+3*y,G=j-(p=b[S][2]>=1?1:0)+3*y,U=I-(m=b[S][3]>=1?1:0)+3*y,$=R-1+4*y,q=N-1+4*y,Y=j-1+4*y,H=I-1+4*y,X=255&E,J=255&T,K=255&w,W=255&O,Z=g[X+g[J+g[K+g[W]]]]%32,Q=g[X+r+g[J+n+g[K+o+g[W+a]]]]%32,tt=g[X+_+g[J+c+g[K+l+g[W+u]]]]%32,et=g[X+h+g[J+d+g[K+p+g[W+m]]]]%32,st=g[X+1+g[J+1+g[K+1+g[W+1]]]]%32,it=.6-R*R-N*N-j*j-I*I,rt=.6-M*M-k*k-z*z-C*C,nt=.6-L*L-P*P-F*F-D*D,ot=.6-B*B-V*V-G*G-U*U,at=.6-$*$-q*q-Y*Y-H*H;return 27*((it<0?0:(it*=it)*it*this.dot4(f[Z],R,N,j,I))+(rt<0?0:(rt*=rt)*rt*this.dot4(f[Q],M,k,z,C))+(nt<0?0:(nt*=nt)*nt*this.dot4(f[tt],L,P,F,D))+(ot<0?0:(ot*=ot)*ot*this.dot4(f[et],B,V,G,U))+(at<0?0:(at*=at)*at*this.dot4(f[st],$,q,Y,H)))},function(t){t.ADD="add",t.SET="set",t.MULT="mult",t.SUBSTRACT="substract",t.DIVIDE="divide"}(Yi||(Yi={}));const Ji=[Yi.ADD,Yi.SET,Yi.MULT,Yi.SUBSTRACT,Yi.DIVIDE];class Ki extends Ft.a{constructor(){super(...arguments),this.amount=Ft.b.FLOAT(1),this.freq=Ft.b.VECTOR3([1,1,1]),this.offset=Ft.b.VECTOR3([0,0,0]),this.octaves=Ft.b.INTEGER(3,{range:[1,8],range_locked:[!0,!1]}),this.amp_attenuation=Ft.b.FLOAT(.5,{range:[0,1]}),this.freq_increase=Ft.b.FLOAT(2,{range:[0,10]}),this.seed=Ft.b.INTEGER(0,{range:[0,100]}),this.separator=Ft.b.SEPARATOR(),this.use_normals=Ft.b.BOOLEAN(0),this.attrib_name=Ft.b.STRING("position"),this.operation=Ft.b.INTEGER(Ji.indexOf(Yi.ADD),{menu:{entries:Ji.map(t=>({name:t,value:Ji.indexOf(t)}))}}),this.compute_normals=Ft.b.BOOLEAN(1)}}const Wi=new Ki;class Zi extends Pt{constructor(){super(...arguments),this.params_config=Wi,this._simplex_by_seed=new Map,this._rest_points=[]}static type(){return"noise"}static displayed_input_names(){return["geometry to add noise to","rest geometry"]}initialize_node(){this.io.inputs.set_count(1,2),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE,Gt.a.NEVER])}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t[0],s=t[1],i=e.points();s&&(null!=this._rest_core_group_timestamp&&this._rest_core_group_timestamp==s.timestamp()||(this._rest_points=s.points(),this._rest_core_group_timestamp=s.timestamp()));const r=this._get_simplex(),n=this.pv.use_normals&&e.has_attrib("normal"),o=e.attrib_size(this.pv.attrib_name);for(let t=0;t<i.length;t++){const e=i[t];let a=s?this._rest_points[t]:e;const _=a.attrib_value(this.pv.attrib_name),c=a.position().add(this.pv.offset).multiply(this.pv.freq);let l=(()=>{if(n){const t=a.attrib_value("normal"),e=this.pv.amount*this._fbm(r,c.x,c.y,c.z);return t.clone().multiplyScalar(e)}return new Y.a(this.pv.amount*this._fbm(r,c.x+545,c.y+125454,c.z+2142),this.pv.amount*this._fbm(r,c.x-425,c.y-25746,c.z+95242),this.pv.amount*this._fbm(r,c.x+765132,c.y+21,c.z-9245))})();l=(()=>{switch(o){case 1:return l.x;case 2:return new X.a(l.x,l.y);case 3:return l}})();const u=(()=>{const t=Ji[this.pv.operation];switch(o){case 1:switch(t){case Yi.ADD:return _+l;case Yi.SET:return l;case Yi.MULT:return _*l;case Yi.DIVIDE:return _/l;case Yi.SUBSTRACT:return _-l}Hi.a.unreachable(t);break;default:switch(t){case Yi.ADD:return _.add(l);case Yi.SET:return l;case Yi.MULT:return _.multiply(l);case Yi.DIVIDE:return _.divide(l);case Yi.SUBSTRACT:return _.sub(l)}Hi.a.unreachable(t)}})();e.set_attrib_value(this.pv.attrib_name,u)}if(!this.io.inputs.input_cloned(0))for(let t of e.geometries())t.getAttribute(this.pv.attrib_name).needsUpdate=!0;this.pv.compute_normals&&e.compute_vertex_normals(),this.set_core_group(e)}))}_fbm(t,e,s,i){let r=0,n=1;for(let o=0;o<this.pv.octaves;o++)r+=n*t.noise3d(e,s,i),e*=this.pv.freq_increase,s*=this.pv.freq_increase,i*=this.pv.freq_increase,n*=this.pv.amp_attenuation;return r}_get_simplex(){const t=this._simplex_by_seed.get(this.pv.seed);if(t)return t;{const t=this._create_simplex();return this._simplex_by_seed.set(this.pv.seed,t),t}}_create_simplex(){const t=this.pv.seed,e=new Xi({random:function(){return bt.a.rand_float(t)}});return this._simplex_by_seed.delete(t),e}}class Qi extends Ft.a{constructor(){super(...arguments),this.edit=Ft.b.BOOLEAN(0),this.update_x=Ft.b.BOOLEAN(0,{visible_if:{edit:1}}),this.x=Ft.b.FLOAT("@N.x",{visible_if:{update_x:1,edit:1},expression:{for_entities:!0}}),this.update_y=Ft.b.BOOLEAN(0,{visible_if:{edit:1}}),this.y=Ft.b.FLOAT("@N.y",{visible_if:{update_y:1,edit:1},expression:{for_entities:!0}}),this.update_z=Ft.b.BOOLEAN(0,{visible_if:{edit:1}}),this.z=Ft.b.FLOAT("@N.z",{visible_if:{update_z:1,edit:1},expression:{for_entities:!0}}),this.recompute=Ft.b.BOOLEAN(0,{visible_if:{edit:0}}),this.invert=Ft.b.BOOLEAN(0)}}const tr=new Qi;class er extends Pt{constructor(){super(...arguments),this.params_config=tr}static type(){return"normals"}static displayed_input_names(){return["geometry to update normals of"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t[0];this.pv.edit?yield this._eval_expressions_for_core_group(e):e.compute_vertex_normals(),this.pv.invert&&this._invert_normals(e),this.set_core_group(e)}))}_eval_expressions_for_core_group(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t.core_objects();for(let t=0;t<e.length;t++)yield this._eval_expressions_for_core_object(e[t])}))}_eval_expressions_for_core_object(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t.object().geometry,s=t.points(),i=e.getAttribute("normal").array;if(this.pv.update_x)if(this.p.x.has_expression()&&this.p.x.expression_controller)yield this.p.x.expression_controller.compute_expression_for_points(s,(t,e)=>{i[3*t.index+0]=e});else{let t;for(let e=0;e<s.length;e++)t=s[e],i[3*t.index+0]=this.pv.x}if(this.pv.update_y)if(this.p.y.has_expression()&&this.p.y.expression_controller)yield this.p.y.expression_controller.compute_expression_for_points(s,(t,e)=>{i[3*t.index+1]=e});else{let t;for(let e=0;e<s.length;e++)t=s[e],i[3*t.index+1]=this.pv.y}if(this.pv.update_z)if(this.p.z.has_expression()&&this.p.z.expression_controller)yield this.p.z.expression_controller.compute_expression_for_points(s,(t,e)=>{i[3*t.index+2]=e});else{let t;for(let e=0;e<s.length;e++)t=s[e],i[3*t.index+2]=this.pv.z}}))}_invert_normals(t){var e;for(let s of t.core_objects()){const t=null===(e=s.core_geometry())||void 0===e?void 0:e.geometry();if(t){const e=t.attributes.normal;if(e){const t=e.array;for(let e=0;e<t.length;e++)t[e]*=-1}}}}}class sr extends Ft.a{}const ir=new sr;class rr extends Pt{constructor(){super(...arguments),this.params_config=ir}static type(){return"null"}initialize_node(){this.io.inputs.set_count(0,1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE]),this.ui_data.set_border_radius(1e3)}cook(t){const e=t[0];e?this.set_core_group(e):this.set_objects([])}}class nr extends Ft.a{constructor(){super(...arguments),this.geometry=Ft.b.OPERATOR_PATH("",{node_selection:{context:zt.a.SOP}})}}const or=new nr;class ar extends Pt{constructor(){super(...arguments),this.params_config=or}static type(){return"object_merge"}initialize_node(){}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const t=this.p.geometry.found_node();if(t)if(t.node_context()==zt.a.SOP){const e=yield t.request_container();this.import_input(t,e)}else this.states.error.set("found node is not a geometry");else this.states.error.set(`node not found at path '${this.pv.geometry}'`)}))}import_input(t,e){let s;null!=(s=e.core_content_cloned())?this.set_core_group(s):this.states.error.set("invalid target")}}var _r=s(511),cr=s.n(_r);const lr={Float32BufferAttribute:_.b};class ur extends Ft.a{constructor(){super(...arguments),this.attrib_name=Ft.b.STRING("occlusion"),this.samples=Ft.b.INTEGER(256,{range:[1,256],range_locked:[!0,!1]}),this.sep=Ft.b.SEPARATOR(),this.buffer_resolution=Ft.b.INTEGER(512),this.bias=Ft.b.FLOAT(.01)}}const hr=new ur;class dr extends Pt{constructor(){super(...arguments),this.params_config=hr}static type(){return"occlusion"}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t[0],s=e.core_objects();for(let t of s)yield this._process_occlusion_on_object(t);this.set_core_group(e)}))}_process_occlusion_on_object(t){var e,s;return Object(Yt.a)(this,void 0,void 0,(function*(){const i=null===(e=t.core_geometry())||void 0===e?void 0:e.geometry();if(!i)return;const r=i.attributes.position.array,n=i.attributes.normal.array,o=null===(s=i.getIndex())||void 0===s?void 0:s.array,a=cr()(r,{cells:o,normals:n,resolution:this.pv.buffer_resolution,bias:this.pv.bias});for(let t=0;t<this.pv.samples;t++)a.sample();const _=a.report();i.setAttribute(this.pv.attrib_name,new lr.Float32BufferAttribute(_,1)),a.dispose()}))}}var pr=s(366),mr=s(114),fr=s.n(mr);class br{constructor(t){this._shader_name=t,this._size=0}add_variable(t){this._variables=this._variables||[],this._variables.push(t),t.set_position(this._size),t.set_allocation(this),this._size+=t.size}has_space_for_variable(t){return this._size+t.size<=4}get shader_name(){return this._shader_name}get texture_name(){return`texture_${this._shader_name}`}get variables(){return this._variables}variables_for_input_node(t){var e;return null===(e=this._variables)||void 0===e?void 0:e.filter(e=>{var s;return(null===(s=e.graph_node_ids)||void 0===s?void 0:s.has(t.graph_node_id))||!1})}input_names_for_node(t){var e;return null===(e=this.variables_for_input_node(t))||void 0===e?void 0:e.map(t=>t.name)}variable(t){if(this._variables)for(let e of this._variables)if(e.name==t)return e}to_json(t){var e;return null===(e=this._variables)||void 0===e?void 0:e.map(e=>e.to_json(t))}}class gr{constructor(t,e){if(this._name=t,this._size=e,this._position=-1,!t)throw"TextureVariable requires a name"}set_allocation(t){this._allocation=t}get allocation(){return this._allocation}get graph_node_ids(){return this._graph_node_ids}add_graph_node_id(t){this._graph_node_ids=this._graph_node_ids||new Map,this._graph_node_ids.set(t,!0)}get name(){return this._name}get size(){return this._size}set_position(t){this._position=t}get position(){return this._position}get component(){return"xyzw".split("").splice(this._position,this._size).join("")}to_json(t){const e=[];return this._graph_node_ids&&this._graph_node_ids.forEach((s,i)=>{const r=t.graph.node_from_id(i).name;e.push(r)}),{name:this.name,nodes:e.sort()}}}var vr=s(333),yr=s(45);class xr{constructor(){this._allocations=[],this._next_allocation_index=0}allocate_connections_from_root_nodes(t,e){const s=[];for(let e of t){const t=e.graph_node_id;switch(e.type){case"output":for(let i of e.io.inputs.named_input_connection_points){if(e.io.inputs.named_input(i.name)){const e=new gr(i.name,yr.a[i.type]);e.add_graph_node_id(t),s.push(e)}}break;case"attribute":{const i=e,r=i.connected_input_node(),n=i.connected_input_connection_point();if(r&&n){const e=new gr(i.attribute_name,yr.a[n.type]);e.add_graph_node_id(t),s.push(e)}break}}}for(let t of e){const e=t.graph_node_id;switch(t.type){case"globals":{const i=t,r=["position","normal","color","uv"];for(let t of i.io.outputs.used_output_names()){if(r.includes(t)){const r=i.io.outputs.named_output_connection_points_by_name(t);if(r){const i=r.type,n=new gr(t,yr.a[i]);n.add_graph_node_id(e),s.push(n)}}}break}case"attribute":{const i=t,r=i.output_connection_point();if(r){const t=new gr(i.attribute_name,yr.a[r.type]);t.add_graph_node_id(e),s.push(t)}break}}}this.allocate_variables(s)}allocate_variables(t){const e=we()(t,t=>-t.size);for(let t of e)this.allocate_variable(t)}allocate_variable(t){var e;let s=this.has_variable(t.name);if(s){const s=this.variables().filter(e=>e.name==t.name)[0];null===(e=t.graph_node_ids)||void 0===e||e.forEach((t,e)=>{s.add_graph_node_id(e)})}else{if(!s)for(let e of this._allocations)!s&&e.has_space_for_variable(t)&&(e.add_variable(t),s=!0);if(!s){const e=new br(this.next_allocation_name());this._allocations.push(e),e.add_variable(t)}}}next_allocation_name(){const t=vr.a[this._next_allocation_index];return this._next_allocation_index+=1,t}shader_names(){const t=this._allocations.map(t=>t.shader_name);return C()(t)}create_shader_configs(){return[]}allocation_for_shader_name(t){return this._allocations.filter(e=>e.shader_name==t)[0]}input_names_for_shader_name(t,e){const s=this.allocation_for_shader_name(e);if(s)return s.input_names_for_node(t)}variable(t){for(let e of this._allocations){const s=e.variable(t);if(s)return s}}variables(){return U()(this._allocations.map(t=>t.variables||[]))}has_variable(t){const e=this.variables().map(t=>t.name);return fr()(e,t)}to_json(t){return this._allocations.map(e=>({[e.texture_name]:e.to_json(t)}))}print(t){console.log(JSON.stringify(this.to_json(t),[""],2))}}var Er=s(332),Tr=s(386),wr=s(118),Or=s(331);class Ar extends pr.a{get _template_shader(){}_template_shader_for_shader_name(t){return"#include <common>\n\n// INSERT DEFINE\n\nvoid main() {\n\n\tvec2 particleUV = (gl_FragCoord.xy / resolution.xy);\n\n\t// INSERT BODY\n\n}"}compile(){return Object(Yt.a)(this,void 0,void 0,(function*(){yield this.setup_shader_names_and_variables(),yield this.update_shaders()}))}root_nodes_by_shader_name(t){var e;const s=[];for(let i of this._root_nodes)switch(i.type){case"output":s.push(i);break;case"attribute":{const r=i.attribute_name,n=null===(e=this._texture_allocations_controller)||void 0===e?void 0:e.variable(r);if(n&&n.allocation){n.allocation.shader_name==t&&s.push(i)}break}}return s}leaf_nodes_by_shader_name(t){var e;const s=[];for(let i of this._leaf_nodes)switch(i.type){case"globals":s.push(i);break;case"attribute":{const r=i.attribute_name,n=null===(e=this._texture_allocations_controller)||void 0===e?void 0:e.variable(r);if(n&&n.allocation){n.allocation.shader_name==t&&s.push(i)}break}}return s}setup_shader_names_and_variables(){var t;return Object(Yt.a)(this,void 0,void 0,(function*(){const e=new Tr.a(this,this._gl_parent_node);this._leaf_nodes=e.leaves_from_nodes(this._root_nodes);for(let t of this._root_nodes)yield t.params.eval_all();for(let t of this._leaf_nodes)yield t.params.eval_all();console.log("root and leaf:",this._root_nodes,this._leaf_nodes),this._texture_allocations_controller=new xr,this._texture_allocations_controller.allocate_connections_from_root_nodes(this._root_nodes,this._leaf_nodes),this.globals_handler&&(null===(t=this.globals_handler)||void 0===t||t.set_texture_allocations_controller(this._texture_allocations_controller)),this._reset_shader_configs()}))}update_shaders(){return Object(Yt.a)(this,void 0,void 0,(function*(){this._shaders_by_name=new Map,this._lines=new Map,console.log("this.shader_names",this.shader_names);for(let t of this.shader_names){const e=this._template_shader_for_shader_name(t);this._lines.set(t,e.split("\n"))}this._root_nodes.length>0&&(yield this.build_code_from_nodes(this._root_nodes),this._build_lines());for(let t of this.shader_names){const e=this._lines.get(t);e&&(console.log(t,e.join("\n")),this._shaders_by_name.set(t,e.join("\n")))}}))}add_output_params(t){t.add_param(Xt.a.VECTOR3,"position",[0,0,0]),t.add_param(Xt.a.VECTOR3,"velocity",[0,0,0])}add_globals_params(t){t.io.outputs.set_named_output_connection_points([new wr.a("position",yr.c.VEC3),new wr.a("velocity",yr.c.VEC3),new wr.a("time",yr.c.FLOAT)])}allow_attribute_exports(){return!0}get texture_allocations_controller(){return this._texture_allocations_controller=this._texture_allocations_controller||new xr}create_shader_configs(){var t;return(null===(t=this._texture_allocations_controller)||void 0===t?void 0:t.create_shader_configs())||[]}create_variable_configs(){return[]}get shader_names(){return this.texture_allocations_controller.shader_names()||[]}input_names_for_shader_name(t,e){return this.texture_allocations_controller.input_names_for_shader_name(t,e)||[]}insert_define_after(t){return"// INSERT DEFINE"}insert_body_after(t){return"// INSERT BODY"}lines_to_remove(t){return["// INSERT DEFINE","// INSERT BODY"]}add_export_body_line(t,e,s,i,r){var n;if(s){const s=t.variable_for_input(e),o=Er.a.vector3(s);if(o){const e=this.texture_allocations_controller.variable(i),s=r.current_shader_name;if(e&&(null===(n=e.allocation)||void 0===n?void 0:n.shader_name)==s){const i=`gl_FragColor.${e.component} = ${o}`;r.add_body_lines(t,[i],s)}}}}set_node_lines_output(t,e){const s=e.current_shader_name,i=this.texture_allocations_controller.input_names_for_shader_name(t,s);if(i)for(let s of i){const i=t.io.inputs.named_input(s);if(i){const r=s;this.add_export_body_line(t,s,i,r,e)}}}set_node_lines_attribute(t,e){var s,i;if(t.is_importing){const r=t.gl_type(),n=t.attribute_name,o=null===(s=this.globals_handler)||void 0===s?void 0:s.read_attribute(t,r,n,e),a=t.gl_var_name(t.output_name),_=`${r} ${a} = ${o}`;e.add_body_lines(t,[_]);const c=this.texture_allocations_controller.variable(n),l=e.current_shader_name;if(c&&(null===(i=c.allocation)||void 0===i?void 0:i.shader_name)==l){const s=this.texture_allocations_controller.variable(n);if(s){const i=`gl_FragColor.${s.component} = ${a}`;e.add_body_lines(t,[i])}}}if(t.is_exporting){const s=t.connected_input_node();if(s){const i=t.attribute_name;this.add_export_body_line(t,t.input_name,s,i,e)}}}set_node_lines_globals(t,e){for(let s of t.io.outputs.used_output_names())switch(s){case"time":this._handle_globals_time(t,s,e);break;default:this._handle_globals_default(t,s,e)}}_handle_globals_time(t,e,s){const i=new Or.d(t,yr.c.FLOAT,e);s.add_definitions(t,[i]);const r=`float ${t.gl_var_name(e)} = ${e}`;s.add_body_lines(t,[r]),this.set_uniforms_time_dependent()}_handle_globals_default(t,e,s){var i;const r=t.io.outputs.named_output_connection_points_by_name(e);if(r){const n=r.type,o=null===(i=this.globals_handler)||void 0===i?void 0:i.read_attribute(t,n,e,s),a=`${n} ${t.gl_var_name(e)} = ${o}`;s.add_body_lines(t,[a])}}}var Rr=s(385);class Nr extends Rr.a{constructor(t){super(),this._uv_name=t}set_texture_allocations_controller(t){this._texture_allocations_controller=t}handle_globals_node(t,e,s){if(!this._texture_allocations_controller)return;const i=t.io.outputs.named_output_connection_points_by_name(e),r=t.gl_var_name(e);if(this._texture_allocations_controller.variable(e)&&i){const n=i.type,o=`${n} ${r} = ${this.read_attribute(t,n,e,s)}`;s.add_body_lines(t,[o])}else this.globals_geometry_handler=this.globals_geometry_handler||new wi.a,this.globals_geometry_handler.handle_globals_node(t,e,s)}read_attribute(t,e,s,i){if(!this._texture_allocations_controller)return;const r=this._texture_allocations_controller.variable(s);if(!r)return wi.a.read_attribute(t,e,s,i);{this.add_particles_sim_uv_attribute(t,i);const e=r.component,s=r.allocation;if(s){const r=s.texture_name,n=new Or.d(t,yr.c.SAMPLER_2D,r);return i.add_definitions(t,[n]),`texture2D( ${r}, ${this._uv_name} ).${e}`}}}add_particles_sim_uv_attribute(t,e){const s=new Or.a(t,yr.c.VEC2,Nr.UV_ATTRIB),i=new Or.e(t,yr.c.VEC2,Nr.UV_VARYING);e.add_definitions(t,[s,i],vr.b.VERTEX),e.add_definitions(t,[i],vr.b.FRAGMENT),e.add_body_lines(t,[`${Nr.UV_VARYING} = ${Nr.UV_ATTRIB}`],vr.b.VERTEX)}}Nr.UV_ATTRIB="particles_sim_uv_attrib",Nr.UV_VARYING="particles_sim_uv_varying",Nr.PARTICLE_SIM_UV="particleUV";var jr=s(365);class Ir{constructor(t){this.node=t,this._particles_group_objects=[]}set_shaders_by_name(t){this._shaders_by_name=t,this.reset_render_material()}assign_render_material(){if(this._render_material){for(let t of this._particles_group_objects){const e=t;e.geometry&&(e.material=this._render_material,wt.apply_custom_materials(e,this._render_material),e.matrixAutoUpdate=!1,e.updateMatrix())}this._render_material.needsUpdate=!0,this.update_render_material_uniforms()}}update_render_material_uniforms(){var t;this._render_material&&(null===(t=this._shaders_by_name)||void 0===t||t.forEach((t,e)=>{var s;const i=null===(s=this.node.gpu_controller.getCurrentRenderTarget(e))||void 0===s?void 0:s.texture;if(i){const t=`texture_${e}`;this._render_material&&(this._render_material.uniforms[t].value=i,wt.assign_custom_uniforms(this._render_material,t,i))}}))}reset_render_material(){this._render_material=void 0,this._particles_group_objects=[]}get initialized(){return null!=this._render_material}init_core_group(t){for(let e of t.objects())this._particles_group_objects.push(e)}init_render_material(){var t;return Object(Yt.a)(this,void 0,void 0,(function*(){if(this._render_material)return;this.node.p.material.is_dirty&&(yield this.node.p.material.compute());const e=this.node.p.material.found_node();if(e){const t=this.node.assembler_controller.assembler.texture_allocations_controller.to_json(this.node.scene),s=new Nr(Nr.UV_VARYING);s.set_texture_allocations_controller(this.node.assembler_controller.assembler.texture_allocations_controller),e.assembler_controller.set_assembler_globals_handler(s),this._texture_allocations_json&&JSON.stringify(this._texture_allocations_json)==JSON.stringify(t)||(this._texture_allocations_json=et()(t),e.set_dirty());const i=yield e.request_container();this._render_material=i.material()}else this.node.states.error.set("render material not valid");if(this._render_material){const e=this._render_material.uniforms;null===(t=this._shaders_by_name)||void 0===t||t.forEach((t,s)=>{const i=`texture_${s}`,r={value:null};e[i]=r,this._render_material&&wt.init_custom_material_uniforms(this._render_material,i,r)})}this.assign_render_material()}))}}var Sr=s(410),Mr=s(122),kr=s(353),zr=s(396),Cr=function(t,e,s){this.variables=[],this.currentTextureIndex=0;var i=new d.a,r=new Sr.a;r.position.z=1;var n={passThruTexture:{value:null}},o=c("uniform sampler2D passThruTexture;\n\nvoid main() {\n\n\tvec2 uv = gl_FragCoord.xy / resolution.xy;\n\n\tgl_FragColor = texture2D( passThruTexture, uv );\n\n}\n",n),a=new f.a(new kr.a(2,2),o);function _(s){s.defines.resolution="vec2( "+t.toFixed(1)+", "+e.toFixed(1)+" )"}function c(t,e){e=e||{};var s=new Fi.a({uniforms:e,vertexShader:"void main()\t{\n\n\tgl_Position = vec4( position, 1.0 );\n\n}\n",fragmentShader:t});return _(s),s}i.add(a),this.addVariable=function(t,e,s){var i={name:t,initialValueTexture:s,material:this.createShaderMaterial(e),dependencies:null,renderTargets:[],wrapS:null,wrapT:null,minFilter:v.kb,magFilter:v.kb};return this.variables.push(i),i},this.setVariableDependencies=function(t,e){t.dependencies=e},this.init=function(){if(!s.capabilities.isWebGL2&&!s.extensions.get("OES_texture_float"))return"No OES_texture_float support for float textures.";if(0===s.capabilities.maxVertexTextures)return"No support for vertex shader textures.";for(var i=0;i<this.variables.length;i++){var r=this.variables[i];r.renderTargets[0]=this.createRenderTarget(t,e,r.wrapS,r.wrapT,r.minFilter,r.magFilter),r.renderTargets[1]=this.createRenderTarget(t,e,r.wrapS,r.wrapT,r.minFilter,r.magFilter),this.renderTexture(r.initialValueTexture,r.renderTargets[0]),this.renderTexture(r.initialValueTexture,r.renderTargets[1]);var n=r.material.uniforms;if(null!==r.dependencies)for(var o=0;o<r.dependencies.length;o++){var a=r.dependencies[o];if(a.name!==r.name){for(var _=!1,c=0;c<this.variables.length;c++)if(a.name===this.variables[c].name){_=!0;break}if(!_)return"Variable dependency not found. Variable="+r.name+", dependency="+a.name}n[a.name]={value:null}}}return this.currentTextureIndex=0,null},this.compute=function(){for(var t=this.currentTextureIndex,e=0===this.currentTextureIndex?1:0,s=0,i=this.variables.length;s<i;s++){var r=this.variables[s];if(null!==r.dependencies)for(var n=r.material.uniforms,o=0,a=r.dependencies.length;o<a;o++){var _=r.dependencies[o];n[_.name].value=_.renderTargets[t].texture}this.doRenderTarget(r.material,r.renderTargets[e])}this.currentTextureIndex=e},this.getCurrentRenderTarget=function(t){return t.renderTargets[this.currentTextureIndex]},this.getAlternateRenderTarget=function(t){return t.renderTargets[0===this.currentTextureIndex?1:0]},this.addResolutionDefine=_,this.createShaderMaterial=c,this.createRenderTarget=function(s,i,r,n,o,a){return s=s||t,i=i||e,r=r||v.l,n=n||v.l,o=o||v.kb,a=a||v.kb,new zr.a(s,i,{wrapS:r,wrapT:n,minFilter:o,magFilter:a,format:v.Db,type:/(iPad|iPhone|iPod)/g.test(navigator.userAgent)?v.I:v.D,stencilBuffer:!1,depthBuffer:!1})},this.createTexture=function(){var s=new Float32Array(t*e*4);return new Mr.a(s,t,e,v.Db,v.D)},this.renderTexture=function(t,e){n.passThruTexture.value=t,this.doRenderTarget(o,e),n.passThruTexture.value=null},this.doRenderTarget=function(t,e){var n=s.getRenderTarget();a.material=t,s.setRenderTarget(e),s.render(i,r),a.material=o,s.setRenderTarget(n)}},Lr=s(11);class Pr{constructor(t){this.node=t,this._simulation_restart_required=!1,this._points=[],this.variables_by_name=new Map,this._created_textures_by_name=new Map,this._used_textures_size=new X.a}set_shaders_by_name(t){this._shaders_by_name=t,this.reset_gpu_compute()}init(t){return Object(Yt.a)(this,void 0,void 0,(function*(){this.init_particle_group_points(t),yield this.create_gpu_compute()}))}getCurrentRenderTarget(t){var e;const s=this.variables_by_name.get(t);if(s)return null===(e=this._gpu_compute)||void 0===e?void 0:e.getCurrentRenderTarget(s)}init_particle_group_points(t){this.reset_gpu_compute(),t&&(this._particles_core_group=t,this._points=this._get_points()||[])}compute_similation_if_required(){const t=this.node.scene.frame,e=this.node.pv.start_frame;t>=e&&(null==this._last_simulated_frame&&(this._last_simulated_frame=e-1),t>this._last_simulated_frame&&this._compute_simulation(t-this._last_simulated_frame))}_compute_simulation(t=1){if(this._gpu_compute){this.update_simulation_material_uniforms();for(let e=0;e<t;e++)this._gpu_compute.compute();this.node.render_controller.update_render_material_uniforms(),this._last_simulated_frame=this.node.scene.frame}}create_gpu_compute(){var t,e;return Object(Yt.a)(this,void 0,void 0,(function*(){if(this.node.pv.auto_textures_size){const t=bt.a.nearestPower2(Math.sqrt(this._points.length));this._used_textures_size.x=Math.min(t,this.node.pv.max_textures_size.x),this._used_textures_size.y=Math.min(t,this.node.pv.max_textures_size.y)}else{if(!hs.a.isPowerOfTwo(this.node.pv.textures_size.x)||!hs.a.isPowerOfTwo(this.node.pv.textures_size.y))return void this.node.states.error.set("texture size must be a power of 2");const t=this.node.pv.textures_size.x*this.node.pv.textures_size.y;if(this._points.length>t)return void this.node.states.error.set(`max particles is set to (${this.node.pv.textures_size.x}x${this.node.pv.textures_size.y}=) ${t}`);this._used_textures_size.copy(this.node.pv.textures_size)}this.node.states.time_dependent.force_time_dependent(),this._init_particles_uvs(),this.node.render_controller.reset_render_material();const s=yield Lr.a.instance().renderers_controller.wait_for_renderer();s?this._renderer=s:this.node.states.error.set("no renderer found");const i=new Cr(this._used_textures_size.x,this._used_textures_size.y,this._renderer);if(this._gpu_compute=i,!this._gpu_compute)return void this.node.states.error.set("failed to create the GPUComputationRenderer");this._last_simulated_frame=void 0,this.variables_by_name.forEach((t,e)=>{t.renderTargets[0].dispose(),t.renderTargets[1].dispose(),this.variables_by_name.delete(e)});const r=[];null===(t=this._shaders_by_name)||void 0===t||t.forEach((t,e)=>{if(this._gpu_compute){const s=this._gpu_compute.addVariable(`texture_${e}`,t,this._created_textures_by_name.get(e));this.variables_by_name.set(e,s),r.push(s)}}),null===(e=this.variables_by_name)||void 0===e||e.forEach((t,e)=>{this._gpu_compute&&this._gpu_compute.setVariableDependencies(t,r)}),this._create_texture_render_targets(),this._fill_textures(),this.create_simulation_material_uniforms();var n=this._gpu_compute.init();null!==n&&(console.error(n),this.node.states.error.set(n))}))}create_simulation_material_uniforms(){this.variables_by_name.forEach((t,e)=>{const s=t.material.uniforms;s.frame={value:this.node.scene.frame};for(let t of this.node.assembler_controller.assembler.param_configs())s[t.uniform_name]=t.uniform})}update_simulation_material_uniforms(){this.variables_by_name.forEach((t,e)=>{t.material.uniforms.frame.value=this.node.scene.frame})}_init_particles_uvs(){var t=new Float32Array(2*this._points.length);let e=0;for(var s=0,i=0;i<this._used_textures_size.x;i++)for(var r=0;r<this._used_textures_size.y&&(t[e++]=r/(this._used_textures_size.x-1),t[e++]=i/(this._used_textures_size.y-1),!((s+=2)>=t.length));r++);const n=Nr.UV_ATTRIB;if(this._particles_core_group)for(let e of this._particles_core_group.core_geometries()){const s=e.geometry(),i=e.marked_as_instance()?As.a:_.a;s.setAttribute(n,new i(t,2))}}created_textures_by_name(){return this._created_textures_by_name}_fill_textures(){this._created_textures_by_name.forEach((t,e)=>{const s=this.node.assembler_controller.assembler.texture_allocations_controller.allocation_for_shader_name(e);if(!s)return;const i=s.variables;if(!i)return;const r=t.image.data;for(let t of i){const e=t.position;let s=t.name;const i=this._points[0];if(i){if(i.has_attrib(s)){const t=i.attrib_size(s);let n=e;for(let e of this._points){if(1==t){const t=e.attrib_value(s);r[n]=t}else e.attrib_value(s).toArray(r,n);n+=4}}}}})}reset_gpu_compute(){this._gpu_compute=void 0,this._simulation_restart_required=!0}set_restart_not_required(){this._simulation_restart_required=!1}reset_gpu_compute_and_set_dirty(){this.reset_gpu_compute(),this.node.set_dirty()}reset_particle_groups(){this._particles_core_group=void 0}get initialized(){return null!=this._particles_core_group&&null!=this._gpu_compute}_create_texture_render_targets(){this._created_textures_by_name.forEach((t,e)=>{t.dispose()}),this._created_textures_by_name.clear(),this.variables_by_name.forEach((t,e)=>{this._gpu_compute&&this._created_textures_by_name.set(e,this._gpu_compute.createTexture())})}restart_simulation_if_required(){this._simulation_restart_required&&this._restart_simulation()}_restart_simulation(){this._last_simulated_frame=void 0,this._create_texture_render_targets(),this._get_points()&&(this._fill_textures(),this.variables_by_name.forEach((t,e)=>{const s=this._created_textures_by_name.get(e);this._gpu_compute&&s&&(this._gpu_compute.renderTexture(s,t.renderTargets[0]),this._gpu_compute.renderTexture(s,t.renderTargets[1]))}))}_get_points(){if(!this._particles_core_group)return;let t=this._particles_core_group.core_geometries();const e=t[0];if(e){const s=e.marked_as_instance(),i=[];for(let e of t)e.marked_as_instance()==s&&i.push(e);const r=[];for(let t of i)for(let e of t.points())r.push(e);return r}return[]}}var Fr=s(388),Dr=s(452),Br=s(436);class Vr extends Ft.a{constructor(){super(...arguments),this.start_frame=Ft.b.FLOAT(1,{range:[1,100]}),this.auto_textures_size=Ft.b.BOOLEAN(1),this.max_textures_size=Ft.b.VECTOR2([1024,1024],{visible_if:{auto_textures_size:1}}),this.textures_size=Ft.b.VECTOR2([64,64],{visible_if:{auto_textures_size:0}}),this.reset=Ft.b.BUTTON(null,{callback:(t,e)=>{Ur.PARAM_CALLBACK_reset(t)}}),this.material=Ft.b.OPERATOR_PATH("",{node_selection:{context:zt.a.MAT},dependent_on_found_node:!1})}}const Gr=new Vr;class Ur extends Pt{constructor(){super(...arguments),this.params_config=Gr,this._assembler_controller=new jr.a(this,Ar),this.gpu_controller=new Pr(this),this.render_controller=new Ir(this),this._reset_material_if_dirty_bound=this._reset_material_if_dirty.bind(this),this._children_controller_context=zt.a.GL,this._on_create_prepare_material_bound=this._on_create_prepare_material.bind(this)}static type(){return"particles_system_gpu"}get assembler_controller(){return this._assembler_controller}static require_webgl2(){return!0}static PARAM_CALLBACK_reset(t){t.PARAM_CALLBACK_reset()}PARAM_CALLBACK_reset(){this.gpu_controller.reset_gpu_compute_and_set_dirty()}static displayed_input_names(){return["points to emit particles from"]}initialize_node(){var t;this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.NEVER]),this.add_post_dirty_hook("_reset_material_if_dirty",this._reset_material_if_dirty_bound),this.lifecycle.add_on_create_hook(this.assembler_controller.on_create.bind(this.assembler_controller)),this.lifecycle.add_on_create_hook(this._on_create_prepare_material_bound),null===(t=this.children_controller)||void 0===t||t.init()}create_node(t){return super.create_node(t)}children(){return super.children()}nodes_by_type(t){return super.nodes_by_type(t)}_reset_material_if_dirty(){return Object(Yt.a)(this,void 0,void 0,(function*(){this.p.material.is_dirty&&(this.render_controller.reset_render_material(),this.is_on_frame_start()||(yield this.render_controller.init_render_material()))}))}is_on_frame_start(){return this.scene.frame==this.pv.start_frame}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){this.gpu_controller.set_restart_not_required();const e=t[0];console.log("particles cook"),yield this.compile_if_required(),this.is_on_frame_start()&&this.gpu_controller.reset_particle_groups(),this.gpu_controller.initialized||(yield this.gpu_controller.init(e)),this.render_controller.initialized||(this.render_controller.init_core_group(e),yield this.render_controller.init_render_material()),this.gpu_controller.restart_simulation_if_required(),this.gpu_controller.compute_similation_if_required(),this.is_on_frame_start()?this.set_core_group(e):this.cook_controller.end_cook()}))}compile_if_required(){return Object(Yt.a)(this,void 0,void 0,(function*(){this.assembler_controller.compile_required()&&(yield this.run_assembler())}))}run_assembler(){return Object(Yt.a)(this,void 0,void 0,(function*(){const t=this._find_root_nodes();if(console.log("root_nodes",t),t.length>0){const e=new Nr(Nr.PARTICLE_SIM_UV);this.assembler_controller.set_assembler_globals_handler(e),this.assembler_controller.assembler.set_root_nodes(t),yield this.assembler_controller.assembler.compile(),yield this.assembler_controller.post_compile()}const e=this.assembler_controller.assembler.shaders_by_name();this.gpu_controller.set_shaders_by_name(e),this.render_controller.set_shaders_by_name(e),this.gpu_controller.reset_gpu_compute(),this.gpu_controller.reset_particle_groups(),yield this.assembler_controller.assign_uniform_values()}))}_find_root_nodes(){const t=Fr.a.find_attribute_export_nodes(this),e=Fr.a.find_output_nodes(this);if(e.length>1)return this.states.error.set("only one output node is allowed"),[];const s=e[0];return s&&t.push(s),t}_on_create_prepare_material(){const t=this.scene.root.nodes_by_type("materials")[0]||this.scene.root.create_node("materials");t.set_name("MAT");const e=t.node("points_particles")||((t,e)=>{let s=t.node("points_builder1");s&&s.type==Dr.a.type()||(s=t.create_node("points_builder")),s.set_name(e);let i=s.node("constant");i&&i.type==Br.a.type()||(i=s.create_node("constant"),i.set_name("constant_point_size")),i.p.float.set(4);const r=s.node("output1");return r&&r.set_input("gl_PointSize",i,Br.a.OUTPUT_NAME),s})(t,"points_particles");if(e){const t=e.full_path();this.p.material.raw_input!=t&&this.p.material.set(t)}}}class $r extends Ft.a{constructor(){super(...arguments),this.amount=Ft.b.FLOAT(1,{range:[-1,1]})}}const qr=new $r;class Yr extends Pt{constructor(){super(...arguments),this.params_config=qr}static type(){return"peak"}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){const e=t[0];let s,i;for(let t of e.objects())t.traverse(t=>{let e;if(null!=(e=t.geometry)){for(i of(s=new Tt(e),s.points())){const t=i.normal(),e=i.position().clone().add(t.multiplyScalar(this.pv.amount));i.set_position(e)}if(!this.io.inputs.input_cloned(0)){s.geometry().getAttribute("position").needsUpdate=!0}}});this.set_core_group(e)}}const Hr=new Y.a(0,0,1),Xr=new Y.a(0,0,1),Jr=new Y.a(0,1,0);class Kr extends Ft.a{constructor(){super(...arguments),this.size=Ft.b.VECTOR2([1,1]),this.use_segments_count=Ft.b.BOOLEAN(0),this.step_size=Ft.b.FLOAT(1,{visible_if:{use_segments_count:0}}),this.segments=Ft.b.VECTOR2([1,1],{visible_if:{use_segments_count:1}}),this.direction=Ft.b.VECTOR3([0,1,0]),this.center=Ft.b.VECTOR3([0,0,0])}}const Wr=new Kr;class Zr extends Pt{constructor(){super(...arguments),this.params_config=Wr,this._core_transform=new $e.a}static type(){return"plane"}static displayed_input_names(){return["geometry to create plane from (optional)"]}initialize_node(){this.io.inputs.set_count(0,1),this.io.inputs.init_inputs_clonable_state([Gt.a.NEVER])}cook(t){const e=t[0];e?this._cook_with_input(e):this._cook_without_input()}_cook_without_input(){const t=this._create_plane(this.pv.size);this._core_transform.rotate_geometry(t,Hr,this.pv.direction);const e=this._core_transform.translation_matrix(this.pv.center);t.applyMatrix4(e),this.set_geometry(t)}_cook_with_input(t){const e=t.bounding_box(),s=new Y.a;e.getSize(s);const i=new Y.a;e.getCenter(i);const r=new X.a(s.x,s.z),n=this._create_plane(r);this._core_transform.rotate_geometry(n,Xr,Jr);const o=this._core_transform.translation_matrix(i);n.applyMatrix4(o),this.set_geometry(n)}_create_plane(t){let e;return t=t.clone(),this.pv.use_segments_count?e={x:Math.floor(this.pv.segments.x),y:Math.floor(this.pv.segments.y)}:(e={x:Math.floor(t.x/this.pv.step_size),y:Math.floor(t.y/this.pv.step_size)},t.x=e.x*this.pv.step_size,t.y=e.y*this.pv.step_size),new kr.a(t.x,t.y,e.x,e.y)}}class Qr extends Ft.a{constructor(){super(...arguments),this.update_x=Ft.b.BOOLEAN(0),this.x=Ft.b.FLOAT("@P.x",{visible_if:{update_x:1},expression:{for_entities:!0}}),this.update_y=Ft.b.BOOLEAN(0),this.y=Ft.b.FLOAT("@P.y",{visible_if:{update_y:1},expression:{for_entities:!0}}),this.update_z=Ft.b.BOOLEAN(0),this.z=Ft.b.FLOAT("@P.z",{visible_if:{update_z:1},expression:{for_entities:!0}}),this.update_normals=Ft.b.BOOLEAN(1)}}const tn=new Qr;class en extends Pt{constructor(){super(...arguments),this.params_config=tn,this._x_arrays_by_geometry_uuid=new Map,this._y_arrays_by_geometry_uuid=new Map,this._z_arrays_by_geometry_uuid=new Map}static type(){return"point"}static displayed_input_names(){return["points to move"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t[0];yield this._eval_expressions_for_core_group(e)}))}_eval_expressions_for_core_group(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t.core_objects();for(let t=0;t<e.length;t++)yield this._eval_expressions_for_core_object(e[t]);this.pv.update_normals&&t.compute_vertex_normals();const s=t.geometries();for(let t of s)t.computeBoundingBox();if(!this.io.inputs.input_cloned(0)){const e=t.geometries();for(let t of e){t.getAttribute("position").needsUpdate=!0}}this.set_core_group(t)}))}_eval_expressions_for_core_object(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t.object().geometry,s=t.points(),i=e.getAttribute("position").array,r=yield this._update_from_param(e,i,s,this.p.update_x,this.p.x,this.pv.x,this._x_arrays_by_geometry_uuid,0),n=yield this._update_from_param(e,i,s,this.p.update_y,this.p.y,this.pv.y,this._y_arrays_by_geometry_uuid,1),o=yield this._update_from_param(e,i,s,this.p.update_z,this.p.z,this.pv.z,this._z_arrays_by_geometry_uuid,2);r&&this._commit_tmp_values(r,i,0),n&&this._commit_tmp_values(n,i,1),o&&this._commit_tmp_values(o,i,2)}))}_update_from_param(t,e,s,i,r,n,o,a){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=i,_=r;let c=this._init_array_if_required(t,o,s.length,a);if(e.value)if(_.has_expression()&&_.expression_controller)yield _.expression_controller.compute_expression_for_points(s,(t,e)=>{c[t.index]=e});else{let t;for(let e=0;e<s.length;e++)t=s[e],c[t.index]=n}return c}))}_init_array_if_required(t,e,s,i){const r=t.uuid,n=e.get(r);if(n){if(n.length<s){const n=this._array_for_component(t,s,i);return e.set(r,n),n}return n}{const n=this._array_for_component(t,s,i);return e.set(r,n),n}}_array_for_component(t,e,s){const i=new Array(e),r=t.getAttribute("position").array;for(let t=0;t<i.length;t++)i[t]=r[3*t+s];return i}_commit_tmp_values(t,e,s){for(let i=0;i<t.length;i++)e[3*i+s]=t[i]}}class sn{static accumulated_curve_point_indices(t){let e=[];const s=[];let i,r=null;for(let n=0;n<t.length;n++)if(n%2==1){i=t[n];const o=t[n-1];null==r||o===r?(0===e.length&&e.push(o),e.push(i),r=i):(s.push(e),e=[o,i],r=i)}return s.push(e),s}static create_line_segment_geometry(t,e,s,i){const r=[],n={};s.forEach(t=>{n[t]=[]}),e.forEach((e,o)=>{const a=t[e];s.forEach(t=>{let e=a.attrib_value(t);e=i[t]>1?e.toArray():[e],e.forEach(e=>{n[t].push(e)})}),o>0&&(r.push(o-1),r.push(o))});const o=new a.a;return s.forEach(t=>{const e=i[t],s=n[t];o.setAttribute(t,new _.b(s,e))}),o.setIndex(r),o}static line_segment_to_geometries(t){var e;const s=[],i=new Tt(t),r=i.attrib_names(),n=i.points(),o=(null===(e=t.getIndex())||void 0===e?void 0:e.array)||[],a=this.accumulated_curve_point_indices(o);if(console.log(o,a),a.length>0){const e=i.attrib_sizes();a.forEach((i,o)=>{t=this.create_line_segment_geometry(n,i,r,e),s.push(t)})}return s}}var rn=s(384),nn=s.n(rn),on=s(181),an=s.n(on);class _n{constructor(t,e,s){this.geometry=t,this.geometry1=e,this.geometry0=s}process(){const t=new Tt(this.geometry0),e=new Tt(this.geometry1),s=t.segments(),i=e.segments();if(0===s.length||0===i.length)return;const r=s.length<i.length?[t,e]:[e,t],n=r[0],o=r[1],a=n.segments(),c=o.segments(),l=n.points(),u=o.points(),h=l.length,d=an()(l,u),p=[];a.forEach((t,e)=>{const s=c[e];p.push(t[0]),p.push(t[1]),p.push(s[0]+h),p.push(t[1]),p.push(s[1]+h),p.push(s[0]+h)}),nn()(n.attrib_names(),o.attrib_names()).forEach(t=>{const e=n.attrib_size(t);let s=d.map(e=>e.attrib_value(t));e>1&&(s=U()(s.map(t=>t.toArray()))),this.geometry.setAttribute(t,new _.b(s,e))}),this.geometry.setIndex(p),this.geometry.computeVertexNormals()}}const cn=new Y.a(0,0,0),ln=new Y.a(1,1,1);class un extends Ft.a{constructor(){super(...arguments),this.radius=Ft.b.FLOAT(1),this.segments_radial=Ft.b.INTEGER(8,{range:[3,20],range_locked:[!0,!1]}),this.closed=Ft.b.BOOLEAN(0)}}const hn=new un;class dn extends Pt{constructor(){super(...arguments),this.params_config=hn,this._core_transform=new $e.a,this._geometries=[]}static type(){return"polywire"}static displayed_input_names(){return["lines to create tubes from"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.NEVER])}cook(t){const e=t[0];this._geometries=[];for(let t of e.objects())t instanceof b.a&&this._create_tube(t);const s=Tt.merge_geometries(this._geometries);for(let t of this._geometries)t.dispose();if(s){const t=this.create_object(s);this.set_object(t)}else this.set_objects([])}_create_tube(t){var e;const s=t.geometry,i=new Tt(s).points(),r=null===(e=s.getIndex())||void 0===e?void 0:e.array,n=sn.accumulated_curve_point_indices(r);for(let t of n){const e=t.map(t=>i[t]);this._create_tube_from_points(e)}}_create_tube_from_points(t){if(t.length<=1)return;const e=t.map(t=>t.attrib_value("position")),s=ts.create(this.pv.radius,this.pv.segments_radial),i=[];for(let t of e){const e=t,r=this._core_transform.matrix(e,cn,ln,1),n=s.clone();n.applyMatrix4(r),i.push(n)}for(let t=0;t<i.length;t++)if(t>0){const e=i[t],s=i[t-1],r=this._skin(s,e);this._geometries.push(r)}}_skin(t,e){const s=new a.a;return new _n(s,t,e).process(),s}}var pn=s(413);const mn=new(s(367).a)({side:v.w});class fn extends Ft.a{constructor(){super(...arguments),this.use_normals=Ft.b.BOOLEAN(1),this.direction=Ft.b.VECTOR3([0,-1,0],{visible_if:{use_normals:0}}),this.transfer_face_normals=Ft.b.BOOLEAN(1)}}const bn=new fn;class gn extends Pt{constructor(){super(...arguments),this.params_config=bn,this._bound_assign_mat=this._assign_double_sided_material_to_object.bind(this),this._raycaster=new pn.a}static type(){return"ray"}static double_sided_material(){return mn}static displayed_input_names(){return["geometry to move","geometry to ray onto"]}initialize_node(){this.io.inputs.set_count(2),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE,Gt.a.ALWAYS])}create_params(){}cook(t){const e=t[0],s=t[1];this.ray(e,s)}ray(t,e){let s,i;this._assign_double_sided_material_to_core_group(e);for(let r of t.points())s=this.pv.use_normals?r.normal():this.pv.direction,this._raycaster.set(r.position(),s),i=this._raycaster.intersectObjects(e.objects(),!0)[0],i&&(r.set_position(i.point),this.pv.transfer_face_normals&&i.face&&r.set_normal(i.face.normal));this.set_core_group(t)}_assign_double_sided_material_to_core_group(t){for(let e of t.objects())e.traverse(this._bound_assign_mat)}_assign_double_sided_material_to_object(t){t.material=gn.double_sided_material()}}var vn,yn=s(440),xn=s(191),En=s.n(xn);!function(t){t.POINTS_COUNT="points_count",t.SEGMENT_LENGTH="segment_length"}(vn||(vn={}));const Tn=[vn.POINTS_COUNT,vn.SEGMENT_LENGTH];var wn;!function(t){t.CENTRIPETAL="centripetal",t.CHORDAL="chordal",t.CATMULLROM="catmullrom"}(wn||(wn={}));const On=[wn.CENTRIPETAL,wn.CHORDAL,wn.CATMULLROM];class An extends Ft.a{constructor(){super(...arguments),this.method=Ft.b.INTEGER(Tn.indexOf(vn.POINTS_COUNT),{menu:{entries:Tn.map((t,e)=>({name:t,value:e}))}}),this.curve_type=Ft.b.INTEGER(On.indexOf(wn.CATMULLROM),{range:[0,2],range_locked:[!0,!0],menu:{entries:On.map((t,e)=>({name:t,value:e}))}}),this.tension=Ft.b.FLOAT(.01,{range:[0,1],range_locked:[!0,!0]}),this.points_count=Ft.b.INTEGER(100,{visible_if:{method:Tn.indexOf(vn.POINTS_COUNT)}}),this.segment_length=Ft.b.FLOAT(1,{visible_if:{method:Tn.indexOf(vn.SEGMENT_LENGTH)}})}}const Rn=new An;class Nn extends Pt{constructor(){super(...arguments),this.params_config=Rn}static type(){return"resample"}initialize_node(){this.io.inputs.set_count(1)}cook(t){const e=t[0],s=[];if(this.pv.points_count>=2){const t=e.core_objects();for(let e=0;e<t.length;e++){const i=t[e].object();if(i instanceof b.a){const t=this._resample(i);s.push(t)}}}this.set_objects(s)}_resample(t){var e;const s=t.geometry,i=new Tt(s).points(),r=null===(e=s.getIndex())||void 0===e?void 0:e.array,n=sn.accumulated_curve_point_indices(r),o=[];for(let t=0;t<n.length;t++){const e=n[t].map(t=>i[t]),s=this._create_curve_from_points(e);s&&o.push(s)}const a=Et.mergeBufferGeometries(o);return this.create_object(a,k.OBJECT_TYPE.LINE_SEGMENTS)}_create_curve_from_points(t){if(t.length<=1)return;const e=En()(t,t=>t.attrib_value("position")),s=On[this.pv.curve_type],i=this.pv.tension,r=new yn.a(e,!1,s,i),n=this._get_points_from_curve(r);let o=[];const c=[];for(let t=0;t<n.length;t++){const e=n[t].toArray();o.push(e),t>0&&(c.push(t-1),c.push(t))}o=U()(o);const l=new a.a;return l.setAttribute("position",new _.b(o,3)),l.setIndex(c),l}_get_points_from_curve(t){const e=Tn[this.pv.method];switch(e){case vn.POINTS_COUNT:return t.getSpacedPoints(Math.max(2,this.pv.points_count));case vn.SEGMENT_LENGTH:var s=t.getLength(),i=0!==this.pv.segment_length?1+s/this.pv.segment_length:2;return i=Math.max(2,i),t.getSpacedPoints(i)}Hi.a.unreachable(e)}}const jn={BufferAttribute:_.a,BufferGeometry:a.a};class In extends Ft.a{constructor(){super(...arguments),this.points_count=Ft.b.INTEGER(100,{range:[0,100],range_locked:[!0,!1]}),this.seed=Ft.b.INTEGER(0,{range:[0,100],range_locked:[!1,!1]}),this.transfer_attributes=Ft.b.BOOLEAN(0),this.attributes_to_transfer=Ft.b.STRING("normal",{visible_if:{transfer_attributes:1}}),this.add_id_attribute=Ft.b.BOOLEAN(1)}}const Sn=new In;class Mn extends Pt{constructor(){super(...arguments),this.params_config=Sn}static type(){return"scatter"}static displayed_input_names(){return["geometry to scatter points onto"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.NEVER])}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t[0];let s=e.faces();const i=[];let r=0;const n=new Map;for(let t of s){const e=t.area;n.set(t.index,e)}const o=we()(s,t=>n.get(t.index));let a=0;for(let t of o)r+=n.get(t.index),i[a]=r,a++;const _=[];let c=[];this.pv.transfer_attributes&&(c=e.attrib_names_matching_mask(this.pv.attributes_to_transfer));const u=new Map,h=new Map;for(let t of c)u.set(t,[]),h.set(t,e.attrib_size(t));const d=new ze;yield d.start_with_count(this.pv.points_count,t=>{const e=bt.a.rand_float(this.pv.seed+t)*r;for(let t=0;t<i.length;t++){if(e<=i[t]){const s=o[t],i=s.random_position(e);i.toArray(_,_.length);for(let t of c){const e=s.attrib_value_at_position(t,i);at()(e)?u.get(t).push(e):e.toArray(u.get(t),u.get(t).length)}break}}});const p=new jn.BufferGeometry;p.setAttribute("position",new jn.BufferAttribute(new Float32Array(_),3));for(let t of c)p.setAttribute(t,new jn.BufferAttribute(new Float32Array(u.get(t)),h.get(t)));if(this.pv.add_id_attribute){const t=l()(this.pv.points_count);p.setAttribute("id",new jn.BufferAttribute(new Float32Array(t),1))}this.set_geometry(p,k.OBJECT_TYPE.POINTS)}))}}class kn extends Ft.a{constructor(){super(...arguments),this.cast_shadow=Ft.b.BOOLEAN(1),this.receive_shadow=Ft.b.BOOLEAN(1),this.apply_to_children=Ft.b.BOOLEAN(0)}}const zn=new kn;class Cn extends Pt{constructor(){super(...arguments),this.params_config=zn}static type(){return"shadows"}static displayed_input_names(){return["objects to change shadows properties of"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=t[0];for(let t of e.objects())this.pv.apply_to_children?t.traverse(t=>{t.castShadow=this.pv.cast_shadow,t.receiveShadow=this.pv.receive_shadow}):(t.castShadow=this.pv.cast_shadow,t.receiveShadow=this.pv.receive_shadow);console.log(e.objects()),this.set_core_group(e)}))}}var Ln=s(603),Pn=s.n(Ln);class Fn extends Ft.a{}const Dn=new Fn;class Bn extends Pt{constructor(){super(...arguments),this.params_config=Dn}static type(){return"skin"}static displayed_input_names(){return["lines to create polygons from","if used, lines from both inputs will be used"]}initialize_node(){this.io.inputs.set_count(1,2)}cook(t){switch(P()(this.io.inputs.inputs()).length){case 1:return this.process_one_input(t);case 2:return this.process_two_inputs(t);default:return this.states.error.set("inputs count not valid")}}process_one_input(t){const e=t[0],s=this._get_line_segments(e),i=[];if(s){const t=s[0];if(t){const e=sn.line_segment_to_geometries(t.geometry);e.forEach((t,s)=>{if(s>0){const r=e[s-1],n=this._skin(r,t);i.push(n)}})}}this.set_geometries(i)}process_two_inputs(t){const e=t[0],s=t[1],i=this._get_line_segments(e),r=this._get_line_segments(s),n=Pn()(we()([i,r],t=>t.length)),o=n[0],a=n[1],_=[];o.forEach((t,e)=>{const s=a[e];if(null!=t&&null!=s){const e=t.geometry,i=s.geometry,r=this._skin(e,i);_.push(r)}}),this.set_geometries(_)}_get_line_segments(t){return t.objects().filter(t=>t.isLineSegments)}_skin(t,e){const s=new a.a;return new _n(s,t,e).process(),s}}var Vn,Gn=s(406),Un=s(420);!function(t){t.DEFAULT="default",t.ISOCAHEDRON="isocahedron"}(Vn||(Vn={}));const $n={default:0,isocahedron:1},qn=[Vn.DEFAULT,Vn.ISOCAHEDRON];class Yn extends Ft.a{constructor(){super(...arguments),this.type=Ft.b.INTEGER($n.default,{menu:{entries:qn.map(t=>({name:t,value:$n[t]}))}}),this.radius=Ft.b.FLOAT(1,{visible_if:{type:$n.default}}),this.resolution=Ft.b.VECTOR2([8,6],{visible_if:{type:$n.default}}),this.open=Ft.b.BOOLEAN(0,{visible_if:{type:$n.default}}),this.angle_range_x=Ft.b.VECTOR2([0,"$PI*2"],{visible_if:{type:$n.default,open:!0}}),this.angle_range_y=Ft.b.VECTOR2([0,"$PI*2"],{visible_if:{type:$n.default,open:!0}}),this.detail=Ft.b.INTEGER(1,{range:[0,5],range_locked:[!0,!1],visible_if:{type:$n.isocahedron}}),this.center=Ft.b.VECTOR3([0,0,0])}}const Hn=new Yn;class Xn extends Pt{constructor(){super(...arguments),this.params_config=Hn}static type(){return"sphere"}initialize_node(){this.io.inputs.set_count(0,1),this.io.inputs.init_inputs_clonable_state([Gt.a.NEVER])}cook(t){const e=t[0];e?this._cook_with_input(e):this._cook_without_input()}_cook_without_input(){const t=this._create_required_geometry();t.translate(this.pv.center.x,this.pv.center.y,this.pv.center.z),this.set_geometry(t)}_cook_with_input(t){const e=t.bounding_box(),s=e.max.clone().sub(e.min),i=e.max.clone().add(e.min).multiplyScalar(.5),r=this._create_required_geometry();r.translate(this.pv.center.x,this.pv.center.y,this.pv.center.z),r.translate(i.x,i.y,i.z),r.scale(s.x,s.y,s.z),this.set_geometry(r)}_create_required_geometry(){return this.pv.type==$n.default?this._create_default_sphere():this._create_default_isocahedron()}_create_default_sphere(){return this.pv.open?new Gn.a(this.pv.radius,this.pv.resolution.x,this.pv.resolution.y,this.pv.angle_range_x.x,this.pv.angle_range_x.y,this.pv.angle_range_y.x,this.pv.angle_range_y.y):new Gn.a(this.pv.radius,this.pv.resolution.x,this.pv.resolution.y)}_create_default_isocahedron(){return new Un.a(this.pv.radius,this.pv.detail)}}class Jn extends Ft.a{constructor(){super(...arguments),this.input=Ft.b.INTEGER(0,{range:[0,3],range_locked:[!0,!0]})}}const Kn=new Jn;class Wn extends Pt{constructor(){super(...arguments),this.params_config=Kn}static type(){return"switch"}static displayed_input_names(){return["geometry to switch to","geometry to switch to","geometry to switch to","geometry to switch to"]}initialize_node(){this.io.inputs.set_count(0,4),this.io.inputs.init_inputs_clonable_state([Gt.a.NEVER,Gt.a.NEVER,Gt.a.NEVER,Gt.a.NEVER]),this.ui_data.set_width(100),this.cook_controller.disallow_inputs_evaluation()}cook(){return Object(Yt.a)(this,void 0,void 0,(function*(){const t=this.pv.input;if(this.io.inputs.has_input(t)){const e=yield this.container_controller.request_input_container(t);this.set_core_group(e.core_content())}else this.states.error.set(`no input ${t}`)}))}}var Zn=s(423),Qn=s(425),to=s(609),eo=s(606);var so;!function(t){t.MESH="mesh",t.FLAT="flat",t.LINE="line",t.STROKE="stroke"}(so||(so={}));const io=[so.MESH,so.FLAT,so.LINE,so.STROKE];class ro extends Ft.a{constructor(){super(...arguments),this.font=Ft.b.STRING(""),this.text=Ft.b.STRING("polygonjs",{multiline:!0}),this.type=Ft.b.INTEGER(0,{menu:{entries:io.map((t,e)=>({name:t,value:e}))}}),this.size=Ft.b.FLOAT(1,{range:[0,1],range_locked:[!0,!1]}),this.extrude=Ft.b.FLOAT(.1,{visible_if:{type:io.indexOf(so.MESH)}}),this.segments=Ft.b.INTEGER(1,{range:[1,20],range_locked:[!0,!1],visible_if:{type:io.indexOf(so.MESH)}}),this.stroke_width=Ft.b.FLOAT(.02,{visible_if:{type:io.indexOf(so.STROKE)}})}}const no=new ro;class oo extends Pt{constructor(){super(...arguments),this.params_config=no,this._font_loader=new to.a,this._loaded_fonts={}}static type(){return"text"}initialize_node(){}cook(){return Object(Yt.a)(this,void 0,void 0,(function*(){try{this._loaded_fonts[this.pv.font]=this._loaded_fonts[this.pv.font]||(yield this._load_url(this.pv.font))}catch(t){return void this.states.error.set(`count not load font (${this.pv.font})`)}const t=this._loaded_fonts[this.pv.font];if(t)switch(io[this.pv.type]){case so.MESH:return this._create_geometry_from_type_mesh(t);case so.FLAT:return this._create_geometry_from_type_flat(t);case so.LINE:return this._create_geometry_from_type_line(t);case so.STROKE:return this._create_geometry_from_type_stroke(t);default:console.warn("type is not valid")}}))}_create_geometry_from_type_mesh(t){const e=this.displayed_text(),s={font:t,size:this.pv.size,height:this.pv.extrude,curveSegments:this.pv.segments};try{const t=new Zn.a(e,s);if(!t.index){const e=t.getAttribute("position").array;t.setIndex(l()(e.length/3))}this.set_geometry(t)}catch(t){this.states.error.set("failed to generate geometry. Try to remove some characters")}}_create_geometry_from_type_flat(t){const e=this._get_shapes(t);if(e){var s=new Qn.a(e);this.set_geometry(s)}}_create_geometry_from_type_line(t){const e=this.shapes_from_font(t);if(e){const t=[],s=[];let i=0;for(let r=0;r<e.length;r++){const n=e[r].getPoints();for(let e=0;e<n.length;e++){const r=n[e];t.push(r.x),t.push(r.y),t.push(0),s.push(i),e>0&&e<n.length-1&&s.push(i),i+=1}}const r=new a.a;r.setAttribute("position",new _.b(t,3)),r.setIndex(s),this.set_geometry(r,k.OBJECT_TYPE.LINE_SEGMENTS)}}_create_geometry_from_type_stroke(t){return Object(Yt.a)(this,void 0,void 0,(function*(){const e=this.shapes_from_font(t);if(e){this._svg_loader=this._svg_loader||(yield this._load_svg_loader());var s=this._svg_loader.getStrokeStyle(this.pv.stroke_width,"white","miter","butt",4);const t=[];for(let i=0;i<e.length;i++){const r=e[i].getPoints(),n=12,o=.001,a=this._svg_loader.pointsToStroke(r,s,n,o);t.push(a)}const i=Et.mergeBufferGeometries(t);this.set_geometry(i)}}))}shapes_from_font(t){const e=this._get_shapes(t);if(e){const t=[];for(let s=0;s<e.length;s++){const i=e[s];if(i.holes&&i.holes.length>0)for(let e=0;e<i.holes.length;e++){const s=i.holes[e];t.push(s)}}return e.push.apply(e,t),e}}_get_shapes(t){const e=this.displayed_text();try{return t.generateShapes(e,this.pv.size)}catch(t){this.states.error.set("failed to generate geometry. Try to remove some characters")}}displayed_text(){return this.pv.text||""}_load_url(t){""===t&&(t="/fonts/droid_sans_regular.typeface.json");const e=t.split("?")[0].split("."),s=e[e.length-1];switch(t=`${t}?${Date.now()}`,s){case"ttf":return this._load_ttf(t);case"json":return this._load_json(t);default:return null}}_load_ttf(t){return new Promise((e,s)=>Object(Yt.a)(this,void 0,void 0,(function*(){this._ttf_loader=this._ttf_loader||(yield this._load_ttf_loader()),window.opentype=eo,this._ttf_loader.load(t,t=>{const s=this._font_loader.parse(t);e(s)},void 0,()=>{s()})})))}_load_json(t){return new Promise((e,s)=>{this._font_loader.load(t,t=>{e(t)},void 0,()=>{s()})})}_load_ttf_loader(){return Object(Yt.a)(this,void 0,void 0,(function*(){const{TTFLoader:t}=yield s.e(7).then(s.bind(null,613));return new t}))}_load_svg_loader(){return Object(Yt.a)(this,void 0,void 0,(function*(){const{SVGLoader:t}=yield s.e(6).then(s.bind(null,614));return t}))}}var ao=s(422);class _o extends Ft.a{constructor(){super(...arguments),this.radius=Ft.b.FLOAT(1,{range:[0,1]}),this.radius_tube=Ft.b.FLOAT(1,{range:[0,1]}),this.segments_radial=Ft.b.INTEGER(20,{range:[1,50],range_locked:[!0,!1]}),this.segments_tube=Ft.b.INTEGER(12,{range:[1,50],range_locked:[!0,!1]})}}const co=new _o;class lo extends Pt{constructor(){super(...arguments),this.params_config=co}static type(){return"torus"}initialize_node(){}cook(){const t=this.pv.radius,e=this.pv.radius_tube,s=this.pv.segments_radial,i=this.pv.segments_tube,r=new ao.a(t,e,s,i);this.set_geometry(r)}}const uo={TorusKnotBufferGeometry:s(421).a};class ho extends Ft.a{constructor(){super(...arguments),this.radius=Ft.b.FLOAT(1),this.radius_tube=Ft.b.FLOAT(1),this.segments_radial=Ft.b.INTEGER(64,{range:[1,128]}),this.segments_tube=Ft.b.INTEGER(8,{range:[1,32]}),this.p=Ft.b.INTEGER(2,{range:[1,10]}),this.q=Ft.b.INTEGER(3,{range:[1,10]})}}const po=new ho;class mo extends Pt{constructor(){super(...arguments),this.params_config=po}static type(){return"torus_knot"}initialize_node(){}cook(){const t=this.pv.radius,e=this.pv.radius_tube,s=this.pv.segments_radial,i=this.pv.segments_tube,r=this.pv.p,n=this.pv.q,o=new uo.TorusKnotBufferGeometry(t,e,s,i,r,n);this.set_geometry(o)}}class fo extends Ft.a{constructor(){super(...arguments),this.group=Ft.b.STRING(""),this.t=Ft.b.VECTOR3([0,0,0]),this.r=Ft.b.VECTOR3([0,0,0]),this.s=Ft.b.VECTOR3([1,1,1]),this.scale=Ft.b.FLOAT(1),this.look_at=Ft.b.OPERATOR_PATH(""),this.up=Ft.b.VECTOR3([0,1,0]),this.pivot=Ft.b.VECTOR3([0,0,0])}}const bo=new fo;class go extends Pt{constructor(){super(...arguments),this.params_config=bo,this._core_transform=new $e.a}static type(){return"transform"}static displayed_input_names(){return["geometry to transform"]}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){const e=t[0].objects(),s=this._core_transform.matrix(this.pv.t,this.pv.r,this.pv.s,this.pv.scale);if(""===this.pv.group)for(let t of e){let e;null!=(e=t.geometry)?(e.translate(-this.pv.pivot.x,-this.pv.pivot.y,-this.pv.pivot.z),e.applyMatrix4(s),e.translate(this.pv.pivot.x,this.pv.pivot.y,this.pv.pivot.z)):t.applyMatrix4(s)}else{const t=jt.from_objects(e).points_from_group(this.pv.group);for(let e of t){const t=e.position().sub(this.pv.pivot);t.applyMatrix4(s),e.set_position(t.add(this.pv.pivot))}}this.set_objects(e)}}var vo=s(394);const yo=new Y.a(0,1,0);class xo extends Ft.a{constructor(){super(...arguments),this.radius=Ft.b.FLOAT(1,{range:[0,1]}),this.height=Ft.b.FLOAT(1,{range:[0,1]}),this.segments_radial=Ft.b.INTEGER(12,{range:[3,20],range_locked:[!0,!1]}),this.segments_height=Ft.b.INTEGER(1,{range:[1,20],range_locked:[!0,!1]}),this.cap=Ft.b.BOOLEAN(1),this.center=Ft.b.VECTOR3([0,0,0]),this.direction=Ft.b.VECTOR3([0,0,1])}}const Eo=new xo;class To extends Pt{constructor(){super(...arguments),this.params_config=Eo,this._core_transform=new $e.a}static type(){return"tube"}cook(){const t=new vo.a(this.pv.radius,this.pv.radius,this.pv.height,this.pv.segments_radial,this.pv.segments_height,!this.pv.cap);this._core_transform.rotate_geometry(t,yo,this.pv.direction),t.translate(this.pv.center.x,this.pv.center.y,this.pv.center.z),this.set_geometry(t)}}var wo;!function(t){t.CHANGE="change",t.MOVEEND="moveend"}(wo||(wo={}));class Oo{constructor(t){this._callback=t,this._update_always=!0,this._listener_added=!1,this._listener=this._execute_callback.bind(this)}remove_target(){this.set_target(void 0)}set_target(t){t||this._remove_camera_event();const e=this._target;this._target=t,null!=this._target&&this._execute_callback(),(null!=this._target?this._target.uuid:void 0)!==(null!=e?e.uuid:void 0)&&this._add_camera_event()}set_update_always(t){this._remove_camera_event(),this._update_always=t,this._add_camera_event()}_current_event_name(){return this._update_always?wo.CHANGE:wo.MOVEEND}_add_camera_event(){this._listener_added||null!=this._target&&(this._target.addEventListener(this._current_event_name(),this._listener),this._listener_added=!0)}_remove_camera_event(){!0===this._listener_added&&null!=this._target&&(this._target.removeEventListener(this._current_event_name(),this._listener),this._listener_added=!1)}_execute_callback(){null!=this._target&&this._callback(this._target)}}class Ao extends Ft.a{constructor(){super(...arguments),this.camera=Ft.b.OPERATOR_PATH("/perspective_camera1",{node_selection:{context:zt.a.OBJ}})}}const Ro=new Ao;class No extends Pt{constructor(){super(...arguments),this.params_config=Ro,this._camera_controller=new Oo(this._update_uvs_from_camera.bind(this))}static type(){return"uv_project"}initialize_node(){this.io.inputs.set_count(1),this.io.inputs.init_inputs_clonable_state([Gt.a.FROM_NODE])}cook(t){this._processed_core_group=t[0];const e=this.p.camera.found_node();null!=e?(this._camera_object=e.object,this._camera_controller.set_target(this._camera_object)):(this._camera_object=void 0,this._camera_controller.remove_target()),this.set_core_group(this._processed_core_group)}_update_uvs_from_camera(t){if(this._processed_core_group&&this.parent){const t=this._processed_core_group.points(),e=this.parent.object.matrixWorld;t.forEach(t=>{const s=t.position(),i=this._vector_in_camera_space(s,e);if(i){const e={x:1-(.5*i[0]+.5),y:.5*i[1]+.5};t.set_attrib_value("uv",e)}})}}_vector_in_camera_space(t,e){if(this._camera_object)return t.applyMatrix4(e),t.project(this._camera_object).toArray()}}class jo{static run(t){t.register_node(Vt,r.f.INPUT),t.register_node(qt,r.f.ANIMATION),t.register_node(Zt,r.f.ANIMATION),t.register_node(ee,r.f.ATTRIBUTE),t.register_node(re,r.f.ATTRIBUTE),t.register_node(ae,r.f.ATTRIBUTE),t.register_node(le,r.f.ATTRIBUTE),t.register_node(be,r.f.ATTRIBUTE),t.register_node(Ee,r.f.ATTRIBUTE),t.register_node(Re,r.f.ATTRIBUTE),t.register_node(Ie,r.f.ATTRIBUTE),t.register_node(Pe,r.f.ATTRIBUTE),t.register_node(Be,r.f.MODIFIER),t.register_node(Ue,r.f.MODIFIER),t.register_node(Xe,r.f.PRIMITIVES),t.register_node(Ze,r.f.MISC),t.register_node(us,r.f.ADVANCED),t.register_node(rs,r.f.PRIMITIVES),t.register_node(bs,r.f.MODIFIER),t.register_node(Es,r.f.PRIMITIVES),t.register_node(Cs,r.f.MODIFIER),t.register_node($s,r.f.INPUT),t.register_node(Hs,r.f.INPUT),t.register_node(Ks,r.f.MISC),t.register_node(ei,r.f.MODIFIER),t.register_node(ri,r.f.MODIFIER),t.register_node(_i,r.f.INPUT),t.register_node(ui,r.f.MODIFIER),t.register_node(bi,r.f.PRIMITIVES),t.register_node(Ti,r.f.MISC),t.register_node(Ri,r.f.RENDER),t.register_node(Si,r.f.MODIFIER),t.register_node(zi,r.f.MODIFIER),t.register_node(Pi,r.f.PRIMITIVES),t.register_node(Vi,r.f.RENDER),t.register_node(qi,r.f.MISC),t.register_node(Zi,r.f.MISC),t.register_node(er,r.f.MODIFIER),t.register_node(rr,r.f.MODIFIER),t.register_node(ar,r.f.INPUT),t.register_node(dr,r.f.RENDER),t.register_node(Ur,r.f.DYNAMICS),t.register_node(Yr,r.f.MODIFIER),t.register_node(Zr,r.f.PRIMITIVES),t.register_node(en,r.f.MODIFIER),t.register_node(dn,r.f.MODIFIER),t.register_node(gn,r.f.MODIFIER),t.register_node(Nn,r.f.MODIFIER),t.register_node(Mn,r.f.MODIFIER),t.register_node(Bn,r.f.MODIFIER),t.register_node(Cn,r.f.MODIFIER),t.register_node(Xn,r.f.PRIMITIVES),t.register_node(Wn,r.f.MISC),t.register_node(oo,r.f.PRIMITIVES),t.register_node(lo,r.f.PRIMITIVES),t.register_node(mo,r.f.PRIMITIVES),t.register_node(go,r.f.MODIFIER),t.register_node(To,r.f.PRIMITIVES),t.register_node(No,r.f.MODIFIER)}}}}]);
//# sourceMappingURL=Sop.bundle.js.map